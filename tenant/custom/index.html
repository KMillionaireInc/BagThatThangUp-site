<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BagThat Â· Custom Tenant</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6faf9;margin:0;color:#0b1320}
  .disclosure{position:fixed;top:0;left:0;width:100%;background:#0f915a;color:#fff;text-align:center;font-size:14px;font-weight:500;padding:6px 10px;z-index:1000}
  body{margin-top:40px}
  header{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px}
  header img{height:42px;border-radius:8px}
  h1{font-size:20px;margin:0;font-weight:700}
  .tabs{display:flex;justify-content:center;gap:10px;margin:10px auto}
  .tabs button{padding:8px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
  .tabs button.active{background:#0f915a;color:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;padding:10px;max-width:1100px;margin:0 auto}
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:10px;text-align:center}
  .card img{max-width:100%;border-radius:10px}
  .title{font-size:14px;font-weight:600;margin:6px 0;color:#0b1320}
  .price{font-size:14px;color:#0f915a;font-weight:700}
  .strike{color:#777;text-decoration:line-through;margin-right:4px;font-weight:500}
  .btn{display:inline-block;margin-top:8px;background:#0f915a;color:#fff;padding:8px 10px;border-radius:6px;text-decoration:none;font-size:13px;font-weight:600}
</style>
</head>
<body>
<div class="disclosure">As an Amazon Associate I earn from qualifying purchases.</div>
<header>
  <img id="logo" src="" alt="" style="display:none">
  <h1 id="siteTitle">BagThat Store</h1>
</header>

<div class="tabs">
  <button class="active" onclick="showTab('today')">Today's Deals</button>
  <button onclick="showTab('yesterday')">Yesterday</button>
  <button onclick="showTab('almostgone')">Almost Gone</button>
</div>

<div id="dealContainer" class="grid"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx3fxXZuoBROs2iYCuugwfTxRRXmX30BCMPZfzyUI8W3jbWK_oQwlvibIVhx9oL87v3/exec";
const params = new URLSearchParams(window.location.search);
const site = (params.get("site") || location.hostname.split(".")[0] || "").toLowerCase();
let tenantData = null, currentTab = "today";

// ===== Load Tenant Branding =====
async function loadTenant() {
  try {
    const res = await fetch(`${API_URL}?plan=custom&subdomain=${encodeURIComponent(site)}`);
    tenantData = await res.json();
    if (!tenantData || !tenantData.ok) throw new Error("Invalid data");

    const info = tenantData.row || tenantData.data || tenantData;
    const name = info.site_display_name || "BagThat Store";
    const logo = info.logo_url || "";
    const color1 = info.color_primary || "#0f915a";
    const color2 = info.color_secondary || "#1e90ff";
    const tag = info.amazon_tag || "";

    document.title = name;
    document.getElementById("siteTitle").textContent = name;

    if (logo) {
      const el = document.getElementById("logo");
      el.src = logo; el.style.display = "block";
    }

    document.documentElement.style.setProperty("--color-primary", color1);
    document.querySelector(".disclosure").style.background = color1;
    document.querySelectorAll(".tabs button.active, .btn").forEach(b=>b.style.background=color1);

    loadDeals(tag);
  } catch(e){
    console.error("Tenant load error:", e);
    loadDeals("");
  }
}

// ===== Load Deals =====
async function loadDeals(tag) {
  try {
    const res = await fetch(`${API_URL}?fetch=deals&plan=custom&subdomain=${encodeURIComponent(site)}`);
    const data = await res.json();
    const deals = data.deals || data;

    renderDeals(deals, tag);
  } catch(err){
    console.error("Deal load error:", err);
  }
}

function renderDeals(deals, tag){
  const container=document.getElementById("dealContainer");
  container.innerHTML="";
  (deals||[]).forEach(d=>{
    const cleanLink = d.TaggedLink ? d.TaggedLink.replace(/tag=[^&]*/g,`tag=${tag}`) : "#";
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <img src="${d.ImageURL_clean || d.ImageURL_raw || ''}">
      <div class="title">${d.Title||''}</div>
      <div class="price">
        ${d.OriginalPrice ? `<span class='strike'>$${d.OriginalPrice}</span>`:''}
        $${d.DiscountPrice||''}
      </div>
      <a class="btn" href="${cleanLink}" target="_blank">Shop Now</a>
    `;
    container.appendChild(card);
  });
}

function showTab(tab){
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.querySelector(`.tabs button[onclick="showTab('${tab}')"]`).classList.add("active");
  currentTab=tab;
  loadTenant(); // re-fetch data for selected tab
}

// === Init ===
loadTenant();
</script>
</body>
</html>
