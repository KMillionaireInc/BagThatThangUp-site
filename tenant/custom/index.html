<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Custom Storefront · BagThat</title>
<style>
:root{
  --brand:#0ea5a6;
  --accent:#1e90ff;
  --ink:#0b1320;
  --muted:#4d6375;
  --bg:#f6faf9;
  --btn:#0f915a;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
img{max-width:100%;display:block}
a{text-decoration:none;color:inherit}

/* Disclosure */
.disclosure-bar{
  background:#fff8e1;
  border-bottom:1px solid #f0e0b0;
  color:#664d03;
  text-align:center;
  font-size:13px;
  font-weight:700;
  padding:8px 12px;
}

/* Header */
.hero{background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff}
.hero .inner{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:14px;grid-template-columns:64px 1fr}
.avatar{width:64px;height:64px;border-radius:999px;border:2px solid rgba(255,255,255,.9);object-fit:cover;background:#fff}
.h1{margin:0;font-size:clamp(22px,2.4vw,34px);font-weight:900}
.sub{margin:4px 0 8px;color:#fffbe7;font-size:14px;line-height:1.4}
.hero .actions{display:flex;gap:10px;flex-wrap:wrap}
.pill{background:#fff;color:#083663;border:1px solid #d9e7ff;padding:8px 12px;border-radius:999px;font-weight:800;cursor:pointer}
.pill.primary{background:#083663;color:#fff;border-color:#083663}

/* Grid */
.wrap{max-width:1200px;margin:0 auto;padding:0 16px}
.grid{display:grid;gap:16px;margin:16px 0 36px}
@media(max-width:599px){.grid{grid-template-columns:1fr}}
@media(min-width:600px){.grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}}
.card{background:#fff;border:1px solid #e8eef5;border-radius:16px;box-shadow:0 10px 26px rgba(2,24,43,.12);overflow:hidden;display:flex;flex-direction:column}
.media{display:flex;justify-content:center;align-items:center;height:240px;background:#fff;border-bottom:1px solid #e8eef5}
.body{padding:12px}
.title-line{font-size:15px;font-weight:800;line-height:1.25;margin:2px 0 6px}
.price-box{display:flex;align-items:center;gap:6px}
.deal-price{color:#0c6e53;font-weight:900;font-size:18px}
.original-price{color:#999;text-decoration:line-through;font-size:13px}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.btn{display:inline-block;text-align:center;padding:12px;border-radius:12px;background:var(--btn);color:#fff;font-weight:900}
.btn-code{background:#fff;color:#083663;border:1px solid #cfeeee;border-radius:12px;font-weight:900}

/* Footer */
footer{color:#4e6a79;border-top:1px solid #e8eef5;padding:24px 0;margin-top:20px;text-align:center;font-size:13px}
</style>
</head>
<body>

<div class="disclosure-bar">
  Daily Amazon promo codes — As an Amazon Associate I earn from qualifying purchases.
</div>

<header class="hero">
  <div class="inner">
    <img id="avatar" class="avatar" src="https://via.placeholder.com/64x64.png?text=Logo" alt="Logo">
    <div>
      <h1 id="storeTitle" class="h1">Loading...</h1>
      <p id="storeSub" class="sub">Refreshed daily.</p>
      <div id="buttonRow" class="actions"></div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="grid" class="grid"><p>Loading deals…</p></div>
</main>

<footer>© 2025</footer>

<script>
// ===== CONFIG =====
const GAS = "https://script.google.com/macros/s/AKfycbx3fxXZuoBROs2iYCuugwfTxRRXmX30BCMPZfzyUI8W3jbWK_oQwlvibIVhx9oL87v3/exec";
const DEALS = {
  today: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_hOlderdV0ABENcLrWMZFl8zXEqXii-3TnA55f13uVNMArQJjDw9OskRH1gLLQLIivHl5zOeH0yKb/pub?gid=0&single=true&output=csv"
};

// ===== GET URL PARAMS =====
const params = new URLSearchParams(location.search);
const sub = params.get("site") || location.hostname.split(".")[0];
const plan = params.get("plan") || "custom";

// ===== LOAD TENANT SETTINGS =====
async function loadTenant() {
  const url = `${GAS}?subdomain=${encodeURIComponent(sub)}&plan=${encodeURIComponent(plan)}`;
  const r = await fetch(url);
  const t = await r.json();
  if (!t.ok || !t.tenant) return;
  const d = t.tenant;

  // Apply theme + title
  document.documentElement.style.setProperty("--brand", d.color_primary || "#0ea5a6");
  document.documentElement.style.setProperty("--accent", d.color_secondary || "#1e90ff");
  document.getElementById("storeTitle").textContent = d["site_display_name"] || sub;
  if (d.logo_url) document.getElementById("avatar").src = d.logo_url;

  // Buttons
  const row = document.getElementById("buttonRow");
  row.innerHTML = `
    <button class="pill primary" onclick="loadDeals()">Today's Deals</button>
    ${d.extra_button_label && d.extra_button_url ? `<a class="pill" href="${d.extra_button_url}" target="_blank">${d.extra_button_label}</a>` : ""}
  `;
}

// ===== LOAD DEALS =====
async function loadDeals() {
  const grid = document.getElementById("grid");
  const r = await fetch(DEALS.today);
  const txt = await r.text();
  const rows = txt.split("\n").slice(1).map(r=>r.split(","));
  grid.innerHTML = rows.map(r=>{
    const title=r[12]||"Deal";
    const price=r[2]||"";
    const orig=r[21]||"";
    const link=(r[6]||"").replace("tag=kimberlymillionaire-20",`tag=${encodeURIComponent(sub)}-20`);
    const img=r[9]||"https://via.placeholder.com/300x300?text=Deal";
    const code=r[3]||"";
    return `
      <article class="card">
        <div class="media"><img src="${img}" alt="${title}"></div>
        <div class="body">
          <div class="title-line">${title}</div>
          <div class="price-box"><span class="deal-price">$${price}</span>${orig?`<span class="original-price">$${orig}</span>`:""}</div>
          <div class="actions">
            <button class="btn-code" onclick="navigator.clipboard.writeText('${code}')">Copy Code</button>
            <a class="btn" href="${link}" target="_blank">Shop</a>
          </div>
        </div>
      </article>`;
  }).join("");
}

document.addEventListener("DOMContentLoaded", async()=>{
  await loadTenant();
  await loadDeals();
});
</script>
</body>
</html>
