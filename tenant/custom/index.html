<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Custom Deals Â· BagThat</title>

<style>
:root {
  --primary:#0ea5a6;
  --accent:#1e90ff;
  --ink:#0b1320;
  --surface:#fff;
  --radius:16px;
  --shadow:0 10px 26px rgba(2,24,43,.08);
}

body {
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#f6faf9;
  color:var(--ink);
}

header {
  text-align:center;
  background:var(--primary);
  color:#fff;
  padding:16px;
  box-shadow:var(--shadow);
}

header img {
  max-height:60px;
  margin-bottom:8px;
  border-radius:10px;
}

.deals {
  display:grid;
  gap:16px;
  padding:20px;
}
.deal {
  background:var(--surface);
  border:1px solid #e8eef5;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  text-align:center;
  padding:16px;
}
.deal img {
  width:100%;
  max-height:220px;
  object-fit:contain;
}
.deal h3 { font-size:16px; margin:10px 0; }
.deal a.btn {
  display:inline-block;
  background:var(--primary);
  color:#fff;
  padding:10px 14px;
  border-radius:10px;
  font-weight:600;
  text-decoration:none;
}
.deal a.btn:hover { background:var(--accent); }

#extraBtns { text-align:center; margin:10px 0; }
#extraBtns a {
  display:inline-block;
  margin:4px;
  padding:10px 14px;
  border-radius:10px;
  background:var(--accent);
  color:#fff;
  text-decoration:none;
  font-weight:600;
}
.list .deals { display:block; }
.list .deal { display:flex; gap:12px; text-align:left; }
.list .deal img { width:120px; height:120px; }
</style>
</head>
<body>

<header id="siteHeader">
  <img id="logo" alt="Logo" style="display:none">
  <h1 id="storeName">Loading...</h1>
  <div id="extraBtns"></div>
</header>

<main id="dealContainer" class="grid">
  <div style="text-align:center;padding:50px;color:#555;">Loading deals...</div>
</main>

<script>
// ====== CONFIG ======
const SHEET_ID = "1qn-BIcMQlTs_j7b5oC_tYFQ8DFKzJtZdPD-VmBbcOtg"; // BagThat master
const FEED_URL = "https://script.google.com/macros/s/AKfycbx_KZ_AzillionairesFeedID/exec"; // placeholder feed endpoint

// ====== HELPERS ======
function param(name) {
  return new URLSearchParams(location.search).get(name);
}

async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Fetch failed: ${url}`);
  return res.json();
}

// ====== LOAD TENANT INFO ======
(async ()=>{
  try {
    const sub = location.hostname.split(".")[0].toLowerCase();
    const url = `https://script.google.com/macros/s/AKfycbytm-ntU4HHZq4PDXpwr4qoflZUy8Hcg-7GFLT0RFUJGuKIG0Zy3lIDEYTRBt7UVqkK/exec?action=getTenant&plan=custom&subdomain=${encodeURIComponent(sub)}`;
    const tenant = await fetchJSON(url);

    if (!tenant || !tenant.ok) throw new Error("Tenant not found");

    const { site_display_name, logo_url, color_primary, color_secondary, extra_button_label, extra_button_url, layout, amazon_tag } = tenant;

    // apply branding
    document.documentElement.style.setProperty("--primary", color_primary || "#0ea5a6");
    document.documentElement.style.setProperty("--accent", color_secondary || "#1e90ff");
    document.getElementById("storeName").textContent = site_display_name || sub;
    if (logo_url) {
      const logo = document.getElementById("logo");
      logo.src = logo_url;
      logo.style.display = "block";
    }
    if (extra_button_label && extra_button_url) {
      const b = document.createElement("a");
      b.href = extra_button_url;
      b.textContent = extra_button_label;
      document.getElementById("extraBtns").appendChild(b);
    }
    document.getElementById("dealContainer").className = layout === "list" ? "list" : "grid";

    // ====== LOAD DEALS ======
    const deals = await fetchJSON(FEED_URL);
    renderDeals(deals, amazon_tag);

  } catch(err) {
    document.getElementById("dealContainer").innerHTML = `<div style="text-align:center;padding:50px;color:#a33">Error loading site: ${err.message}</div>`;
    console.error(err);
  }
})();

// ====== RENDER DEALS ======
function renderDeals(deals, tag) {
  const wrap = document.getElementById("dealContainer");
  wrap.innerHTML = "";
  deals.forEach(d=>{
    let link = d.TaggedLink || d.ProductLink || "#";
    link = link.replace(/tag=[^&]+/, "tag=" + encodeURIComponent(tag));
    if (!link.includes("tag=")) {
      link += (link.includes("?") ? "&" : "?") + "tag=" + encodeURIComponent(tag);
    }
    const el = document.createElement("div");
    el.className = "deal";
    el.innerHTML = `
      <img src="${d.ImageURL_clean||d.ImageURL_raw||''}" alt="">
      <h3>${d.Title||''}</h3>
      <a href="${link}" class="btn" target="_blank">View Deal</a>
    `;
    wrap.appendChild(el);
  });
}
</script>

</body>
</html>
