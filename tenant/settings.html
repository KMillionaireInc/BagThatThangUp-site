<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Account Settings | BagThatThangUp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="https://www.bagthatthangup.com/custompro.png" />

<style>
  :root {
    --ink:#1b1b1b;
    --accent:#b7a98b;
    --bg:#f6f5f3;
    --white:#ffffff;
    --radius:18px;
    --muted:#6e6e6e;
    --shadow:0 8px 22px rgba(0,0,0,0.08);
  }

  body {
    margin:0;
    font-family:"Inter", system-ui, sans-serif;
    background:var(--bg);
    color:var(--ink);
  }

  header {
    text-align:center;
    padding:32px 14px;
    background:#f6f4ee;
    border-bottom:1px solid #e7e0d4;
  }

  header h1 {
    font-family:"Playfair Display", serif;
    font-size:40px;
    margin:0 0 8px;
    letter-spacing:0.5px;
    color:var(--ink);
    text-transform:uppercase;
  }

  header p {
    font-size:16px;
    margin:4px 0 0;
    color:#444;
  }

  #settingsCard {
    background:var(--white);
    max-width:460px;
    margin:40px auto;
    padding:32px 26px;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }

  #settingsCard h2 {
    font-size:22px;
    margin-bottom:18px;
    font-weight:700;
    color:var(--ink);
  }

  label {
    display:block;
    font-size:15px;
    font-weight:600;
    margin-bottom:6px;
    margin-top:18px;
    color:#283860;
  }

  input {
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:15px;
    background:#fff;
  }

  input[readonly] {
    background:#f2f2f2;
    cursor:not-allowed;
  }

  button {
    width:100%;
    margin-top:26px;
    padding:14px;
    font-size:17px;
    font-weight:700;
    border:none;
    border-radius:10px;
    cursor:pointer;
    background:var(--accent);
    color:#fff;
  }

  #msg {
    margin-top:16px;
    font-size:15px;
    text-align:center;
    font-weight:600;
  }
</style>

</head>
<body>

<header>
  <h1>Account Settings</h1>
  <p>Update your site details and social links</p>
</header>

<div id="settingsCard">
  <h2>Your Site Information</h2>

  <label>Subdomain (locked)</label>
  <input type="text" id="subdomain" readonly />

  <label>Site Name</label>
  <input type="text" id="site_name" />

  <label>Amazon Store ID</label>
  <input type="text" id="amazon_id" placeholder="example19-20" />

  <label>Amazon Storefront URL</label>
  <input type="text" id="amazon_url" placeholder="https://amazon.com/shop/yourname" />

  <label>Instagram URL</label>
  <input type="text" id="instagram_url" />

  <label>Facebook URL</label>
  <input type="text" id="facebook_url" />

  <label>YouTube URL</label>
  <input type="text" id="youtube_url" />

  <label>Pinterest URL</label>
  <input type="text" id="pinterest_url" />

  <label>TikTok URL</label>
  <input type="text" id="tiktok_url" />

  <button id="saveBtn">Save Changes</button>
  <div id="msg"></div>
</div>

<script>
const SUPABASE_URL = "https://gmsjqunfsffjiksffvem.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtc2pxdW5mc2Zmamlrc2ZmdmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NzIxNTgsImV4cCI6MjA3NjQ0ODE1OH0.7qEXKk8f8Sd3G2y8KyQ0XbeCyG8ieD-8WV18-_JkRGc";

const subdomain = window.location.hostname.split(".")[0];

// Fetch existing tenant info
async function loadSettings() {
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/Users?subdomain=eq.${subdomain}&select=*`,
    {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    }
  );

  const data = await res.json();
  const s = data?.[0] || {};

  document.getElementById("subdomain").value = s.subdomain || "";
  document.getElementById("site_name").value = s.site_name || "";
  document.getElementById("amazon_id").value = s.amazon_id || "";
  document.getElementById("amazon_url").value = s.amazon_url || "";
  document.getElementById("instagram_url").value = s.instagram_url || "";
  document.getElementById("facebook_url").value = s.facebook_url || "";
  document.getElementById("youtube_url").value = s.youtube_url || "";
  document.getElementById("pinterest_url").value = s.pinterest_url || "";
  document.getElementById("tiktok_url").value = s.tiktok_url || "";
}

function normalize(url, platform) {
  if (!url) return "";

  url = url.trim();
  if (url.startsWith("@")) url = url.slice(1);
  if (url.startsWith("http://") || url.startsWith("https://")) return url;

  if (!url.includes(".")) {
    switch (platform) {
      case "amazon": return "https://www.amazon.com/shop/" + url;
      case "instagram": return "https://instagram.com/" + url;
      case "facebook": return "https://facebook.com/" + url;
      case "youtube": return "https://youtube.com/" + url;
      case "pinterest": return "https://www.pinterest.com/" + url + "/";
      case "tiktok": return "https://www.tiktok.com/@" + url;
    }
  }

  return "https://" + url.replace(/^https?:\/\//, "");
}

async function saveSettings() {
  const msg = document.getElementById("msg");
  msg.textContent = "Saving...";

  const amazonId = document.getElementById("amazon_id").value.trim();
  if (!/^[a-zA-Z0-9]+-20$/.test(amazonId)) {
    msg.textContent = "Amazon ID must end with -20.";
    msg.style.color = "red";
    return;
  }

  const payload = {
    site_name: document.getElementById("site_name").value.trim(),
    amazon_id: amazonId,
    amazon_url: normalize(document.getElementById("amazon_url").value, "amazon"),
    instagram_url: normalize(document.getElementById("instagram_url").value, "instagram"),
    facebook_url: normalize(document.getElementById("facebook_url").value, "facebook"),
    youtube_url: normalize(document.getElementById("youtube_url").value, "youtube"),
    pinterest_url: normalize(document.getElementById("pinterest_url").value, "pinterest"),
    tiktok_url: normalize(document.getElementById("tiktok_url").value, "tiktok")
  };

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/Users?subdomain=eq.${subdomain}`,
    {
      method: "PATCH",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    }
  );

  if (res.ok) {
    msg.textContent = "Saved successfully!";
    msg.style.color = "green";
  } else {
    msg.textContent = "Error saving changes.";
    msg.style.color = "red";
  }
}

document.getElementById("saveBtn").addEventListener("click", saveSettings);
loadSettings();
</script>

</body>
</html>
