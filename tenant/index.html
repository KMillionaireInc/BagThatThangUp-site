<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BagThatThangUp Promo Code Deals</title>
  <link rel="icon" type="image/png" href="https://www.bagthatthangup.com/custompro.png" />
  <style>
    :root {
      --ink:#1b1b1b; --accent:#b7a98b; --bg:#f6f5f3; --white:#ffffff;
      --radius:18px; --shadow:0 8px 22px rgba(0,0,0,0.08); --muted:#6e6e6e;
    }
    body {
      margin:0; background:var(--bg); color:var(--ink);
      font-family:"Inter",system-ui,sans-serif;
    }
    #disclosure {
      position: sticky; top: 0; z-index: 2000; background: var(--ink);
      color: var(--white); text-align: center; font-size: 14px;
      padding: 10px 12px; letter-spacing: 0.3px;
    }
    header {
      background: #f6f4ee; text-align: center; padding: 46px 14px 26px;
      border-bottom: 1px solid #e7e0d4; position: sticky; top: 42px;
      z-index: 1500;
    }
    header h1 {
      font-family:"Playfair Display",serif; font-size:46px; font-weight:700;
      margin:0 0 12px; letter-spacing:0.6px; color:#1b1b1b;
      text-transform:uppercase;
      text-shadow:0 0 12px rgba(183,169,139,0.55);
    }
    nav button {
      background:none; border:none; font-size:16px; margin:0 12px;
      cursor:pointer; font-weight:600; color:#1b1b1b;
    }
    nav button.active, nav button:hover {
      color:#b7a98b; text-decoration:underline;
    }
    #welcomeBanner {
      background:#f7f5f1; text-align:center; padding:26px 16px;
      font-size:1.22rem; font-family:"Playfair Display",serif;
      color:#1b1b1b; border-top:1px solid #e8e1d5;
      border-bottom:1px solid #e8e1d5; letter-spacing:0.2px;
    }
    #dealCount {
      background:#f6f4ee; padding:16px; text-align:center;
      font-size:16px; font-weight:700; color:#b7a98b;
      border-bottom:1px solid #e3dbcf;
      cursor: pointer;
    }
    #categoryBarWrapper {
      padding:10px 18px; background:var(--bg);
      border-bottom:1px solid rgba(0,0,0,0.05);
    }
    #categoryDropdown {
      width:100%; padding:10px 14px; font-size:15px;
      border-radius:12px; border:1px solid #d2d2d2;
      background:var(--white); outline:none; color:var(--ink);
      margin-bottom:8px;
    }
    #searchBarWrapper {
      position:sticky; top:110px; background:var(--bg);
      padding:14px 18px; z-index:1400;
      border-bottom:1px solid rgba(0,0,0,0.05);
    }
    #searchInput {
      width:100%; padding:12px 40px 12px 16px; font-size:15px;
      border-radius:14px; border:1px solid #d2d2d2;
      background:var(--white); outline:none;
    }
    #searchIcon {
      position:absolute; right:26px; top:50%;
      transform:translateY(-50%); opacity:0.55;
    }
    #deals {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:26px; padding:32px;
    }
    @media(max-width:600px){
      #deals{
        padding:12px; gap:16px;
        grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      }
    }
    .card {
      background:var(--white); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden;
      display:flex; flex-direction:column;
      position:relative;
    }
    .card.glow-highlight {
      box-shadow:0 0 18px rgba(183,169,139,0.8);
      border:2px solid var(--accent);
    }
/* Collage selection checkbox â€“ move to top right */
.collage-checkbox {
  position:absolute;
  top:8px;
  right:8px;   /* was left:8px */
  width:18px;
  height:18px;
  cursor:pointer;
  accent-color:var(--accent);
  z-index:5;
}
    .card img {
      width:100%; object-fit:contain; aspect-ratio:1/1;
      background:var(--white); padding:12px;
    }
    .info { padding:16px 20px; }
    .asin { font-size:0.75rem; color:var(--muted); margin-bottom:6px; }
    .info h3 {
      font-size:15px; font-weight:600; margin:0 0 10px;
      display:flex; justify-content:space-between; align-items:center;
      color:var(--ink);
    }
    .cc-badge {
      background:#f3efe7; color:var(--ink); font-size:0.7rem;
      padding:2px 6px; border-radius:6px; font-weight:700;
      margin-left:4px;
    }
    .share-icon { cursor:pointer; opacity:0.85; }
    .rating { font-size:0.9rem; color:#d1a500; margin-bottom:6px; }
    .price {
      display:flex; align-items:baseline; gap:8px; margin-bottom:10px;
    }
    .price .discount {
      font-size:1.2rem; font-weight:700; color:var(--ink);
    }
    .price .original {
      color:#999; text-decoration:line-through; font-size:0.9rem;
    }
    .copy-code {
      background:#f3efe7; color:var(--ink); padding:6px 10px;
      font-size:0.78rem; font-weight:700; border-radius:6px;
      margin-top:6px; width:fit-content; cursor:pointer;
    }
    .coupon-flag {
      background:#fff8d1; color:#8a6a00; padding:4px 10px;
      font-size:0.8rem; font-weight:700; border-radius:8px;
      margin-top:10px; width:fit-content;
    }
    .cta {
      margin-top:auto; background:var(--accent); color:white;
      padding:14px; text-align:center; font-weight:700;
      text-decoration:none; border-radius:0 0 var(--radius) var(--radius);
    }
    #toast {
      position:fixed; bottom:20px; left:50%;
      transform:translateX(-50%); background:var(--ink); color:white;
      padding:12px 18px; border-radius:8px; opacity:0;
      transition:opacity .3s; z-index:9999;
    }
    #visitorCounter {
      position:fixed; bottom:14px; right:14px;
      background:rgba(0,0,0,0.65); color:#fff; font-size:12px;
      font-weight:600; padding:6px 10px; border-radius:6px;
      z-index:9999; backdrop-filter:blur(4px);
    }
   #haulToaster {
      position:fixed; 
      top:60%;
      left:50%;
      transform:translate(-50%, -50%);
      background:#FF8C00;
      color:#fff;
      border-radius:18px;
      padding:28px 44px;
      min-width:320px;
      max-width:92%;
      box-shadow:0 12px 28px rgba(0,0,0,0.22);
      font-family:Inter,sans-serif;
      display:none;
      align-items:center;
      gap:16px;
      z-index:99999;
      cursor:pointer;
      animation:fadeInPop .45s ease-out;
      font-weight:700;
      font-size:18px;
      text-align:center;
    }
    #haulToaster .closeToaster {
      position:absolute; top:10px; right:12px; font-size:24px;
      cursor:pointer; padding:4px 8px; color:#fff;
    }
    @keyframes fadeInPop {
      0% { opacity:0; transform:translate(-50%, -45%) scale(.9); }
      100%{ opacity:1; transform:translate(-50%, -50%) scale(1); }
    }
    .copy-link-btn {
      background: var(--accent); color: white;
      padding: 10px 14px; border-radius: 10px;
      font-size: 14px; font-weight: 700; cursor: pointer;
      width: fit-content; margin-top: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.12);
      transition: filter .2s ease, transform .2s ease;
    }
    .copy-link-btn:hover {
      filter: brightness(1.08); transform: translateY(-1px);
    }
    #asinCopyPill {
      position: fixed;
      bottom: 16px;
      left: 16px;
      z-index: 9999;
      background: #000;
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      opacity: 0.7;
    }
    #asinCopyPill:hover {
      opacity: 1;
    }
    #sharePageBtn {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      cursor: pointer;
      background: var(--accent);
      padding: 8px 14px;
      border-radius: 10px;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: filter .2s ease, transform .2s ease;
    }
    #sharePageBtn:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    /* Collage action pill */
    #collageActionPill {
      position:fixed;
      bottom:60px;
      left:50%;
      transform:translateX(-50%);
      background:var(--accent);
      color:#fff;
      padding:10px 18px;
      border-radius:999px;
      font-size:14px;
      font-weight:600;
      box-shadow:0 4px 14px rgba(0,0,0,0.18);
      display:none;
      cursor:pointer;
      z-index:9999;
    }

    /* Collage modal */
    #collageModalBackdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
    }
    #collageModal {
      background:#fff;
      padding:16px;
      border-radius:12px;
      max-width:420px;
      width:90%;
      box-shadow:0 6px 24px rgba(0,0,0,0.25);
    }
    #collageSizeToggle {
      display:flex;
      justify-content:center;
      gap:8px;
      margin-bottom:8px;
    }
    .toggle-option {
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #d2d2d2;
      cursor:pointer;
    }
    .toggle-option.active {
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    #collagePreview {
      width:100%;
      background:#f3f3f3;
      border-radius:8px;
      margin-bottom:10px;
    }
    #collageCaption {
      font-size:14px;
      color:var(--ink);
      background:#f9f8f6;
      padding:10px;
      border-radius:8px;
      margin-bottom:10px;
    }
    .modal-actions {
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
    .modal-actions button {
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    #collageDownloadBtn {
      background:var(--accent);
      color:#fff;
    }
    #collageCopyCaptionBtn {
      background:#eee;
      color:#000;
    }
    #collageCloseBtn {
      background:transparent;
      color:#333;
    }

    /* Collage intro modal (every visit) */
    #collageIntroBackdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10001;
    }
  </style>
</head>

<body>

  <div id="disclosure">
    As an Amazon Associate, I earn from qualifying purchases.
    Prices/Codes/Coupons can change anytime.
  </div>

  <header>
    <h1 id="storeName">Loading...</h1>
    <div id="subHeaderTagline">
      Daily promo codes, coupons & curated finds â€” curated savings every day.
    </div>
    <nav>
      <button id="tab-today" class="active">Today's Deals</button>
      <button id="tab-yesterday">Yesterday</button>
      <button id="tab-almost">Almost Gone</button>
    </nav>

    <div id="sharePageBtn">Text this page to a friend!</div>

    <div id="tenantAffiliateLinksHeader" style="
      margin-top:14px;
      text-align:center;
      font-size:14px;
      font-weight:600;
      display:flex;
      justify-content:center;
      gap:16px;
      flex-wrap:wrap;
    ">
      <a id="getYourOwnLink_header"
         href="https://www.bagthatthangup.com/"
         target="_blank"
         style="color:#1b1b1b;text-decoration:underline;">
         Claim your own BagThat site!
      </a>

      <a id="becomeAffiliateLink_header"
         href="https://bagthatthangupcom-6869.endorsely.com"
         target="_blank"
         style="color:#1b1b1b;text-decoration:underline;">
         Become an affiliate
      </a>
    </div>
  </header>

  <div id="socialLinksBar" style="text-align:center;padding:14px 0;background:#f6f4ee;border-bottom:1px solid #e7e0d4;display:none;">
    <a id="btnAmazon" href="#" target="_blank" style="display:none;">Amazon</a>
    <a id="btnInstagram" href="#" target="_blank" style="display:none;">Instagram</a>
    <a id="btnFacebook" href="#" target="_blank" style="display:none;">Facebook</a>
    <a id="btnYouTube" href="#" target="_blank" style="display:none;">YouTube</a>
    <a id="btnPinterest" href="#" target="_blank" style="display:none;">Pinterest</a>
    <a id="btnTikTok" href="#" target="_blank" style="display:none;">TikTok</a>
    <a id="btnLTK" href="#" target="_blank" style="display:none;">LTK</a>
  </div>

  <div id="welcomeBanner">
    Welcome to <span id="storeGreeting">Your Store</span> â€” let's save big today!
  </div>

  <div id="dealCount">Deals: 0</div>

  <div id="categoryBarWrapper">
    <select id="categoryDropdown">
      <option value="">All Categories</option>
      <option value="Clothing">Clothing</option>
      <option value="Jewelry & Accessories">Jewelry & Accessories</option>
      <option value="Beauty/Wellness">Beauty/Wellness</option>
      <option value="Home & Furniture">Home & Furniture</option>
      <option value="Kitchen">Kitchen</option>
      <option value="Electronics">Electronics</option>
      <option value="Fitness">Fitness</option>
      <option value="Kids/Toys">Kids/Toys</option>
      <option value="Pets">Pets</option>
      <option value="Outdoor & Garden">Outdoor & Garden</option>
      <option value="Sports/Outdoor">Sports/Outdoor</option>
      <option value="Automotive">Automotive</option>
    </select>
  </div>

  <div id="searchBarWrapper">
    <div id="searchContainer" style="position:relative;">
      <input id="searchInput" placeholder="Search deals..." />
      <svg id="searchIcon" width="20" height="20" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </div>
  </div>

  <main id="deals">Loading deals...</main>

  <div id="toast">Copied!</div>
  <div id="visitorCounter"></div>

  <div id="haulToaster">
    Amazon Haul Deals!
    <div class="closeToaster">Ã—</div>
  </div>

  <div id="asinCopyPill" title="Copy all ASINs">A</div>

  <!-- Collage action pill -->
  <div id="collageActionPill">Build & Share Collage (0)</div>

  <!-- Collage Modal -->
  <div id="collageModalBackdrop">
    <div id="collageModal">
      <canvas id="collageCanvas" width="1080" height="1080" style="display:none;"></canvas>
      <div id="collageSizeToggle">
        <div class="toggle-option active" data-mode="square">Square (1080Ã—1080)</div>
        <div class="toggle-option" data-mode="story">Story (1080Ã—1920)</div>
      </div>
      <img id="collagePreview" alt="Collage preview"/>
      <div id="collageCaption"></div>
      <div class="modal-actions">
        <button id="collageCloseBtn">Close</button>
        <button id="collageCopyCaptionBtn">Copy Caption</button>
        <button id="collageDownloadBtn">Download Image</button>
      </div>
    </div>
  </div>

  <!-- Collage Intro Modal (every visit) -->
  <div id="collageIntroBackdrop">
    <div style="
      background:#fff; padding:20px; border-radius:14px;
      max-width:420px; width:90%; text-align:center;">
      <h2 style="margin-top:0;">New: Build & Share a Collage</h2>
      <p style="font-size:14px; color:#333; margin:10px 0 16px;">
        Check 4â€“6 promo code deals on this page and tap
        <strong>Build &amp; Share Collage</strong> to get a ready-to-share image
        and caption for your social media.
      </p>
      <button id="collageIntroGotIt" style="
        border:none; border-radius:999px; padding:8px 16px;
        background:var(--accent); color:#fff; font-weight:600; cursor:pointer;">
        Got it
      </button>
    </div>
  </div>

  <footer style="margin:32px auto 20px;max-width:700px;padding:14px 18px;border-top:1px solid #e3dbcf;text-align:center;font-size:14px;color:#1b1b1b;">
    <div style="margin-bottom:6px;font-weight:600;">Powered by BagThat</div>
    <div style="display:flex;justify-content:center;gap:16px;flex-wrap:wrap;">
      <a id="getYourOwnLink"
         href="https://www.bagthatthangup.com/"
         target="_blank"
         style="color:#1b1b1b;text-decoration:underline;">
        Claim your own BagThat site!
      </a>
      <a id="becomeAffiliateLink"
         href="https://bagthatthangupcom-6869.endorsely.com"
         target="_blank"
         style="color:#1b1b1b;text-decoration:underline;">
        Become an affiliate
      </a>
    </div>
  </footer>


  <!-----------------------  JAVASCRIPT ------------------------->

<script>
  function parseCSV(text){
      const rows=[];let row=[];let cell="";let insideQuotes=false;
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(c==='"'&&text[i+1]==='"'){cell+='"';i++;continue;}
        if(c==='"'){insideQuotes=!insideQuotes;continue;}
        if(c===','&&!insideQuotes){row.push(cell);cell="";continue;}
        if(c==='\n'&&!insideQuotes){row.push(cell);rows.push(row);row=[];cell="";continue;}
        cell+=c;
      }
      if(cell.length||row.length){row.push(cell);rows.push(row);}
      return rows;
  }

  const CSV_URLS={
    today:"https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=23655256&single=true&output=csv",
    yesterday:"https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=1955863351&single=true&output=csv",
    almost:"https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=499142778&single=true&output=csv"
  };

  const subdomain=window.location.hostname.split(".")[0];
  let amazonTag="";
  let storeName="";
  let allRows=[];
  const dealsEl=document.getElementById("deals");
  let collageSelectedAsins = [];
  let collageMode = "square"; // "square" | "story"[web:249]

  async function fetchTenantInfo(){
    try{
      const res=await fetch(
        "https://gmsjqunfsffjiksffvem.supabase.co/rest/v1/Users?subdomain=eq." +
        encodeURIComponent(subdomain) +
        "&select=site_name,amazon_id,amazon_url,instagram_url,facebook_url,youtube_url,pinterest_url,tiktok_url,bagthat_affiliate_url,ltk_url",
        {
          headers:{
            apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtc2pxdW5mc2Zmamlrc2ZmdmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NzIxNTgsImV4cCI6MjA3NjQ0ODE1OH0.7qEXKk8f8Sd3G2y8KyQ0XbeCyG8ieD-8WV18-_JkRGc"
          }
        }
      );

      const data=await res.json();
      const s=data?.[0]||{};

      storeName=s.site_name||"BagThat Deals";
      amazonTag=(s.amazon_id||"").trim();
      if(!amazonTag) amazonTag="MISSING-TAG";
      if(amazonTag && !amazonTag.endsWith("-20")){
        amazonTag=amazonTag+"-20";
      }

      const bagthatAffiliate = (s.bagthat_affiliate_url || "").trim();
      const getYourOwnLink = document.getElementById("getYourOwnLink");

      if (getYourOwnLink) {
        getYourOwnLink.href = bagthatAffiliate || "https://www.bagthatthangup.com/";
      }

      const getYourOwnLinkHeader = document.getElementById("getYourOwnLink_header");
      if (getYourOwnLinkHeader) {
        getYourOwnLinkHeader.href = bagthatAffiliate || "https://www.bagthatthangup.com/";
      }

      const links={
        amazon:s.amazon_url,
        instagram:s.instagram_url,
        facebook:s.facebook_url,
        youtube:s.youtube_url,
        pinterest:s.pinterest_url,
        tiktok:s.tiktok_url,
        ltk:s.ltk_url
      };

      function normalizeSocial(url, platform){
        if(!url)return"";
        url=url.trim();
        if(url.startsWith("http"))return url;
        if(url.startsWith("@"))url=url.slice(1);
        if(!url.includes(".")){
          switch(platform){
            case"instagram":return"https://instagram.com/"+url;
            case"tiktok":return"https://www.tiktok.com/@"+url;
            case"facebook":return"https://facebook.com/"+url;
            case"youtube":return"https://youtube.com/"+url;
            case"pinterest":return"https://www.pinterest.com/"+url+"/";
          }
        }
        return"https://"+url.replace(/^https?:\/\//,"");
      }

      links.instagram=normalizeSocial(links.instagram,"instagram");
      links.facebook=normalizeSocial(links.facebook,"facebook");
      links.youtube=normalizeSocial(links.youtube,"youtube");
      links.pinterest=normalizeSocial(links.pinterest,"pinterest");
      links.tiktok=normalizeSocial(links.tiktok,"tiktok");

      let anySocial = false;

      if(links.amazon){
        btnAmazon.href=links.amazon;
        btnAmazon.style.display="inline-block";
        anySocial = true;
      }
      if(links.instagram){
        btnInstagram.href=links.instagram;
        btnInstagram.style.display="inline-block";
        anySocial = true;
      }
      if(links.facebook){
        btnFacebook.href=links.facebook;
        btnFacebook.style.display="inline-block";
        anySocial = true;
      }
      if(links.youtube){
        btnYouTube.href=links.youtube;
        btnYouTube.style.display="inline-block";
        anySocial = true;
      }
      if(links.pinterest){
        btnPinterest.href=links.pinterest;
        btnPinterest.style.display="inline-block";
        anySocial = true;
      }
      if(links.tiktok){
        btnTikTok.href=links.tiktok;
        btnTikTok.style.display="inline-block";
        anySocial = true;
      }

      if (links.ltk) {
        btnLTK.href = links.ltk;
        btnLTK.style.display = "inline-block";
        anySocial = true;
      }

      if(anySocial){
        socialLinksBar.style.display="block";
      }

      document.getElementById("storeName").textContent=storeName;
      document.getElementById("storeGreeting").textContent=storeName;

    } catch(e){}
  }

  function createShareLink(asin){
    const host = window.location.hostname || "bagthatthangup.com";
    const protocol = window.location.protocol === "http:" ? "http:" : "https:";
    return protocol + "//" + host + "/?item=" + encodeURIComponent(asin);
  }

  function shareDeal(asin){
    const link = createShareLink(asin);
    if (navigator.share) {
      navigator.share({ url: link });
    } else {
      navigator.clipboard.writeText(link);
      const t = toast;
      t.textContent = "Link Copied!";
      t.style.opacity = "1";
      setTimeout(() => t.style.opacity = "0", 1200);
    }
  }

  async function loadDeals(type="today"){
    dealsEl.textContent="Loading deals...";
    const res=await fetch(CSV_URLS[type]);
    const text=await res.text();
    const rows=parseCSV(text).slice(1);
    allRows=rows;
    renderDeals(rows);
  }

  function copyCode(code){
    navigator.clipboard.writeText(code).then(()=>{
      toast.textContent = "Code Copied!";
      toast.style.opacity="1";
      setTimeout(()=>toast.style.opacity="0",1200);
    });
  }

  function forceTag(url, tag) {
    if (!url) return "";
    if (!tag) return url;
    if (url.includes("tag=")) return url;
    return url + (url.includes("?") ? "&tag=" + tag : "?tag=" + tag);
  }

  /* Try to open Amazon app on mobile when possible */
  function toAmazonAppLink(url) {
    if (!url) return url;
    const ua = navigator.userAgent || "";
    const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);

    if (!isMobile) {
      return url;
    }

    try {
      const u = new URL(url);
      return "amazon://" + u.host + u.pathname + (u.search || "");
    } catch (e) {
      return url;
    }
  }

  function getCategoryHashtags(cat) {
    const map = {
      "Kitchen": "#kitchenideas #homeinspo",
      "Home & Furniture": "#homeinspo #homerefresh",
      "Beauty/Wellness": "#beautyfinds #selfcareideas",
      "Kids/Toys": "#kidsessentials #momlife",
      "Clothing": "#outfitinspo #styleideas",
      "Jewelry & Accessories": "#styleideas #fashionfinds",
      "Electronics": "#gadgets #techfinds",
      "Fitness": "#fitnessessentials #workoutideas",
      "Pets": "#petfinds #petideas",
      "Outdoor & Garden": "#gardenideas #homeinspo",
      "Sports/Outdoor": "#sportsgear #outdoorfinds",
      "Automotive": "#caraccessories #autofinds"
    };
    return map[cat] || "#dailyfinds";
  }

  function renderDeals(rows){
    dealsEl.innerHTML = rows
      .filter(r => r[1])
      .map(r => {
        const asin = r[1];
        const discountPrice = r[16];
        const promoCode = r[3];
        const ccFlag = r[5];
        const taggedLink = r[6];
        const hasCoupon = (r[10] || "").trim().toLowerCase() === "true";
        const imageURL = r[8] || r[7] || "";
        const title = r[12] || "Untitled Product";
        const rating = r[14] || "";
        const originalPrice = r[21] || "";
        const category = r[13] || "Finds";

        const url = toAmazonAppLink(
          forceTag(taggedLink, amazonTag)
        );
        const deepLink = createShareLink(asin);

        const pinterestTitle = `Trending ${category} find worth saving today`;
        const pinterestDesc =
          `Saw this come back around today â€” saving it here in case youâ€™re browsing ${category} ideas. ` +
          `This one keeps circulating lately, so pinning it for anyone looking for updated ${category} inspiration. ` +
          `#amazonfinds #dailyfinds #trendingnow ${getCategoryHashtags(category)}`;

        const ccBadge = ccFlag && ccFlag.toLowerCase() === "yes"
          ? '<span class="cc-badge">âœ” CC</span>'
          : "";

        const normalizeMoney = v => String(v || "").replace(/\$/g, "").trim();
        const disc = normalizeMoney(discountPrice);
        const orig = normalizeMoney(originalPrice);

        const priceHTML = orig
          ? `<div class="price"><span class="discount">$${disc}</span><span class="original">$${orig}</span></div>`
          : `<div class="price"><span class="discount">$${disc}</span></div>`;

        return `
          <div class="card"
            data-asin="${asin}"
            data-title="${title.toLowerCase()}"
            data-category="${category}"
            data-deeplink="${deepLink}"
            data-cc="${ccFlag || ""}"
          >
            <input type="checkbox" class="collage-checkbox" data-asin="${asin}">
            <img 
              src="${imageURL}"
              alt="${title.replace(/"/g, '&quot;')}"
              data-pin-url="${deepLink}"
              data-pin-title="${pinterestTitle}"
              data-pin-description="${pinterestDesc}"
            >

            <div class="info">
              <div class="asin">ASIN: ${asin}</div>
              <h3>
                <span>${title} ${ccBadge}</span>
              </h3>

              ${rating ? `<div class="rating">â˜… ${rating}</div>` : ""}
              ${priceHTML}

              ${promoCode ? `<div class="copy-code" onclick="copyCode('${promoCode}')">Copy Code: ${promoCode}</div>` : ""}
              ${hasCoupon ? `<div class="coupon-flag">+ coupon on listing</div>` : ""}

              <div class="copy-link-btn" onclick="copyDealLink('${deepLink}')">Copy Link</div>
            </div>

            <a class="cta" href="${url}" target="_blank">Go to Amazon</a>
          </div>
        `;
      })
      .join("");

    attachCollageCheckboxHandlers();
    highlightDeepLinkedItem();
    updateDealCount();
  }

  function filterDeals(){
    const cat=categoryDropdown.value;
    const searchQ=searchInput.value.toLowerCase();
    document.querySelectorAll(".card").forEach(card=>{
      const title=card.dataset.title;
      const category=card.dataset.category;
      const matchCat=!cat||category===cat;
      const matchSearch=!searchQ||title.includes(searchQ);
      card.style.display=matchCat&&matchSearch?"flex":"none";
    });
    updateDealCount();
  }

  document.getElementById("categoryDropdown").addEventListener("change",filterDeals);
  document.getElementById("searchInput").addEventListener("input",filterDeals);

  function highlightDeepLinkedItem(){
    const asin = new URLSearchParams(window.location.search).get("item");
    if(!asin)return;
    let attempts=0;
    const max=20;
    const interval=setInterval(()=>{
      attempts++;
      const card=document.querySelector('.card[data-asin="'+asin+'"]');
      if(card){
        clearInterval(interval);
        card.classList.add("glow-highlight");
        setTimeout(()=>card.scrollIntoView({behavior:"smooth",block:"center"}),250);
        setTimeout(()=>card.classList.remove("glow-highlight"),2500);
      }
      if(attempts>=max)clearInterval(interval);
    },300);
  }

  function updateDealCount(){
    const cards=[...document.querySelectorAll(".card")]
      .filter(c=>c.style.display!=="none");
    dealCount.textContent="Deals: "+cards.length;
  }

  const buttons = {
    today: document.getElementById("tab-today"),
    yesterday: document.getElementById("tab-yesterday"),
    almost: document.getElementById("tab-almost")
  };

  Object.entries(buttons).forEach(([key,btn])=>{
    btn.addEventListener("click",()=>{
      Object.values(buttons).forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      categoryDropdown.value="";
      searchInput.value="";
      filterDeals();
      loadDeals(key);
    });
  });

  fetchTenantInfo().then(()=>{
    loadDeals("today");
    const asin = new URLSearchParams(window.location.search).get("item");
    if(asin) resolveDeepLinkTab(asin);
  });

  async function resolveDeepLinkTab(asin){
    if(!asin) return;
    const order = ["today","yesterday","almost"];
    for(let tab of order){
      const res = await fetch(CSV_URLS[tab]);
      const text = await res.text();
      const parsed = parseCSV(text).slice(1);
      const found = parsed.find(r => r[1] === asin);
      if(found){
        document.getElementById("tab-"+tab).click();
        return;
      }
    }
  }

  function updateVisitorCounter(){
    let count=localStorage.getItem("visitorCount");
    count=count?parseInt(count)+1:1;
    localStorage.setItem("visitorCount",count);
    visitorCounter.textContent=count;
  }
  updateVisitorCounter();

  function copyVisibleAsins() {
    const visibleCards = Array.from(document.querySelectorAll(".card"))
      .filter(c => c.style.display !== "none");

    const ccAsins = visibleCards
      .filter(c => (c.getAttribute("data-cc") || "").toLowerCase() === "yes")
      .map(c => c.getAttribute("data-asin"))
      .filter(Boolean);

    if (!ccAsins.length) {
      toast.textContent = "No CC ASINs visible.";
      toast.style.opacity = "1";
      setTimeout(() => toast.style.opacity = "0", 1200);
      return;
    }

    const list = ccAsins.join(", ");
    navigator.clipboard.writeText(list).then(() => {
      toast.textContent = `Copied ${ccAsins.length} CC ASIN${ccAsins.length === 1 ? "" : "s"}!`;
      toast.style.opacity = "1";
      setTimeout(() => toast.style.opacity = "0", 1200);
    });
  }

  document.addEventListener("DOMContentLoaded",()=>{
    setTimeout(()=>haulToaster.style.display="flex",3000);
    haulToaster.addEventListener("click", e => {
      if (!e.target.classList.contains("closeToaster")) {
        const baseAmazonUrl = "https://www.amazon.com/haul/store";
        const taggedAmazonUrl = toAmazonAppLink(
          forceTag(baseAmazonUrl, amazonTag)
        );
        window.open(taggedAmazonUrl, "_blank");
      }
    });
    document.querySelector(".closeToaster").addEventListener("click",e=>{
      e.stopPropagation();
      haulToaster.style.display="none";
    });

    asinCopyPill.addEventListener("click", copyVisibleAsins);
    dealCount.addEventListener("click", copyVisibleAsins);
  });

  function copyDealLink(url){
    navigator.clipboard.writeText(url);
    toast.textContent="Link Copied!";
    toast.style.opacity="1";
    setTimeout(()=>toast.style.opacity="0",1200);
  }
  window.copyDealLink = copyDealLink;

  /* Collage selection + pill */
  function attachCollageCheckboxHandlers() {
    collageSelectedAsins = [];
    updateCollagePill();

    const checkboxes = document.querySelectorAll(".collage-checkbox");
    checkboxes.forEach(cb => {
      cb.addEventListener("change", () => {
        const asin = cb.getAttribute("data-asin");
        if (cb.checked) {
          if (!collageSelectedAsins.includes(asin)) {
            collageSelectedAsins.push(asin);
          }
        } else {
          collageSelectedAsins = collageSelectedAsins.filter(a => a !== asin);
        }
        updateCollagePill();
      });
    });
  }

  function updateCollagePill() {
    const pill = document.getElementById("collageActionPill");
    const count = collageSelectedAsins.length;
    if (count > 0) {
      pill.style.display = "block";
      pill.textContent = `Build & Share Collage (${count})`;
    } else {
      pill.style.display = "none";
    }
  }

  function clearCollageSelection() {
    collageSelectedAsins = [];
    document.querySelectorAll(".collage-checkbox").forEach(cb => {
      cb.checked = false;
    });
    updateCollagePill();
  }

  /* Caption generator */
  function generatePromoCaption(selectedCards) {
    const n = selectedCards.length;
    const url = window.location.origin;

    const cats = selectedCards.map(c => c.dataset.category || "").filter(Boolean);
    let catWord = "promo code";
    if (cats.length) {
      const freq = {};
      cats.forEach(c => { freq[c] = (freq[c] || 0) + 1; });
      const topCat = Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0];
      catWord = topCat + " promo code";
    }

    const templates = [
      `These ${n} promo code deals are live *today* â€” prices and codes can change at any time ðŸ‘‡ Shop them here: ${url}`,
      `Stack your savings while these promo code deals are still active ðŸ”¥ They update daily, so peek before they disappear: ${url}`,
      `If you love catching ${catWord} deals *before* they're gone, don't skip these ${n} picks ðŸ‘‡ They won't all be here tomorrow: ${url}`
    ];
    const idx = Math.floor(Math.random() * templates.length);
    return templates[idx];
  }

  /* Collage rendering (square or story) */
  async function renderCollageImage(selectedCards) {
    const canvas = document.getElementById("collageCanvas");
    const ctx = canvas.getContext("2d");

    const isStory = (collageMode === "story");
    const width = 1080;
    const height = isStory ? 1920 : 1080; // story 9:16, square 1:1[web:249][web:252]

    canvas.width = width;
    canvas.height = height;

    ctx.fillStyle = "#f3f3f3";
    ctx.fillRect(0, 0, width, height);

    const imgAreaY = 0;
    const imgAreaHeight = height;

    const imgElements = await Promise.all(
      selectedCards.map(card => {
        const imgEl = card.querySelector("img");
        const src = imgEl ? imgEl.src : "";
        return new Promise(resolve => {
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = () => resolve(img);
          img.onerror = () => resolve(null);
          img.src = src;
        });
      })
    );

    const count = imgElements.length;

    let cols, rows;
    if (isStory) {
      cols = 2;
      rows = Math.ceil(count / cols);
    } else {
      cols = count <= 3 ? count : Math.ceil(Math.sqrt(count));
      rows = Math.ceil(count / cols);
    }

    const cellW = width / cols;
    const cellH = imgAreaHeight / rows;

    imgElements.forEach((img, index) => {
      if (!img) return;
      const col = index % cols;
      const row = Math.floor(index / cols);
      const x = col * cellW;
      const y = imgAreaY + row * cellH;

      const scale = Math.min(cellW / img.width, cellH / img.height);
      const drawW = img.width * scale;
      const drawH = img.height * scale;
      const dx = x + (cellW - drawW) / 2;
      const dy = y + (cellH - drawH) / 2;

      ctx.drawImage(img, dx, dy, drawW, drawH);
    });

    const dataUrl = canvas.toDataURL("image/png");
    document.getElementById("collagePreview").src = dataUrl;
  }

  function getSelectedCardsForCollage() {
    let selectedCards = collageSelectedAsins.length
      ? collageSelectedAsins.map(asin => document.querySelector(`.card[data-asin="${asin}"]`)).filter(Boolean)
      : [];

    if (!selectedCards.length) {
      const allCards = Array.from(document.querySelectorAll(".card"));
      selectedCards = allCards.slice(0, 4);
    }

    if (selectedCards.length < 2) {
      toast.textContent = "Select at least 2 items for a collage.";
      toast.style.opacity = "1";
      setTimeout(() => toast.style.opacity = "0", 1400);
      return null;
    }
    if (selectedCards.length > 8) {
      selectedCards = selectedCards.slice(0, 8);
    }
    return selectedCards;
  }

  async function createCollageFromSelection() {
    const selectedCards = getSelectedCardsForCollage();
    if (!selectedCards) return;

    await renderCollageImage(selectedCards);

    const caption = generatePromoCaption(selectedCards);
    document.getElementById("collageCaption").textContent = caption;

    document.getElementById("collageModalBackdrop").style.display="flex";
  }

  /* Collage modal + toggle controls */
  (function(){
    const pill = document.getElementById("collageActionPill");
    const backdrop = document.getElementById("collageModalBackdrop");
    const closeBtn = document.getElementById("collageCloseBtn");
    const copyCaptionBtn = document.getElementById("collageCopyCaptionBtn");
    const downloadBtn = document.getElementById("collageDownloadBtn");
    const sizeToggle = document.getElementById("collageSizeToggle");

    pill.addEventListener("click", createCollageFromSelection);

    function closeCollageModal() {
      backdrop.style.display="none";
      clearCollageSelection();
    }

    closeBtn.addEventListener("click", closeCollageModal);
    backdrop.addEventListener("click", e => {
      if (e.target === backdrop) {
        closeCollageModal();
      }
    });

    sizeToggle.addEventListener("click", async (e) => {
      const opt = e.target.closest(".toggle-option");
      if (!opt) return;
      const mode = opt.getAttribute("data-mode");
      if (!mode || mode === collageMode) return;
      collageMode = mode;

      sizeToggle.querySelectorAll(".toggle-option").forEach(el => el.classList.remove("active"));
      opt.classList.add("active");

      const selectedCards = getSelectedCardsForCollage();
      if (!selectedCards) return;

      await renderCollageImage(selectedCards);
    });

    copyCaptionBtn.addEventListener("click", () => {
      const caption = document.getElementById("collageCaption").textContent || "";
      if (!caption) return;
      navigator.clipboard.writeText(caption).then(()=>{
        toast.textContent = "Caption copied!";
        toast.style.opacity = "1";
        setTimeout(() => toast.style.opacity = "0", 1200);
      });
    });

    downloadBtn.addEventListener("click", () => {
      const canvas = document.getElementById("collageCanvas");
      const link = document.createElement("a");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,"0");
      const d = String(now.getDate()).padStart(2,"0");
      const dateStr = `${y}${m}${d}`;

      const modeLabel = (collageMode === "story") ? "vertical" : "square";
      link.href = canvas.toDataURL("image/png");
      link.download = `bagthatthangup-${modeLabel}-collage-${dateStr}.png`;
      link.click();
    });
  })();

  /* Collage Intro modal ON EVERY VISIT */
  (function(){
    const backdrop = document.getElementById("collageIntroBackdrop");
    function dismissIntro() {
      backdrop.style.display = "none";
    }
    backdrop.style.display = "flex";
    document.getElementById("collageIntroGotIt").addEventListener("click", dismissIntro);
    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) dismissIntro();
    });
  })();
</script>

<script>
(function () {
  function initShareBtn() {
    const sharePageBtn = document.getElementById("sharePageBtn");
    const toast = document.getElementById("toast");
    if (!sharePageBtn || !toast) return;

    sharePageBtn.addEventListener("click", () => {
      const url = window.location.origin;

      if (navigator.share) {
        navigator.share({ url });
        return;
      }

      navigator.clipboard.writeText(url).then(() => {
        toast.textContent = "Page Link Copied!";
        toast.style.opacity = "1";
        setTimeout(() => (toast.style.opacity = "0"), 1200);
      });
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initShareBtn);
  } else {
    initShareBtn();
  }
})();
</script>

</body>
</html>
