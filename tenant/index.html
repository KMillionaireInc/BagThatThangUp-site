<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Deals</title>
<style>
  :root{--bg:#f6faf9;--ink:#0b1320;--muted:#4d6375;--line:#e8eef5;--surface:#fff;--btn:#0f915a;--btnink:#fff;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:inherit;text-decoration:none} img{max-width:100%;display:block}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
  .header{background:linear-gradient(135deg,var(--brand1,#0ea5a6),var(--brand2,#1e90ff));color:#fff;border-bottom:1px solid #dff1f3}
  .header .in{display:grid;gap:14px;grid-template-columns:64px 1fr;align-items:center}
  .logo{width:64px;height:64px;border-radius:12px;background:#fff;object-fit:contain;border:2px solid rgba(255,255,255,.9)}
  h1{margin:0;font-weight:900;font-size:clamp(20px,3.5vw,32px)}
  .sub{margin:0;color:#eaf7ff}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .pill{background:#fff;color:#083663;border:1px solid #d9e7ff;padding:8px 12px;border-radius:999px;font-weight:800;cursor:pointer}
  .pill.active{background:#083663;color:#fff}
  .toolbar{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:saturate(160%) blur(10px);border-bottom:1px solid var(--line)}
  .tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .search{flex:1;min-width:220px;background:#fff;border:1px solid var(--line);border-radius:999px;display:flex;gap:8px;padding:10px 14px}
  .search input{border:0;outline:0;flex:1;font-size:15px}
  .select{min-width:170px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-weight:700}
  .grid{display:grid;gap:16px;margin:16px 0 36px}
  @media (max-width:599px){ .grid{grid-template-columns:1fr} }
  @media (min-width:600px){ .grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))} }
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 26px rgba(2,24,43,.08);overflow:hidden;display:flex;flex-direction:column}
  .media{display:flex;justify-content:center;align-items:flex-start;overflow:hidden;padding:10px;height:240px;border-bottom:1px solid var(--line);background:#fff}
  .body{padding:12px}
  .tags{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
  .tag{font-size:11px;padding:3px 6px;border-radius:999px;font-weight:700;white-space:nowrap;background:#eef7ff;color:#083663;border:1px solid #cfe6ff}
  .title{font-size:15px;font-weight:800;line-height:1.25;margin:2px 0 6px;min-height:38px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .stars{font-size:14px;color:#f39c12;font-weight:700;margin:4px 0}
  .price{display:flex;gap:8px;align-items:baseline}
  .orig{color:#999;text-decoration:line-through;font-size:13px}
  .deal{color:#0c6e53;font-weight:900;font-size:18px}
  .meta{font-size:12px;color:#0b3d3f;margin-top:6px}
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .btn{display:inline-block;text-align:center;padding:12px;border-radius:12px;border:1px solid #0b7247;background:var(--btn);color:var(--btnink);font-weight:900}
  .btn2{display:inline-block;text-align:center;padding:12px;border-radius:12px;background:#fff;color:#083663;border:1px solid #cfeeee;font-weight:900}
  .empty{display:none;text-align:center;color:#4e6a79;padding:40px 16px}
  .empty.show{display:block}
</style>
</head>
<body>
<header class="header">
  <div class="wrap in">
    <img id="logo" class="logo" src="" alt="" onerror="this.style.display='none'"/>
    <div>
      <h1 id="title">Deals</h1>
      <p id="subtitle" class="sub">Daily Amazon promo codes and coupons.</p>
      <div class="tabs">
        <button class="pill active" data-src="today">Today</button>
        <button class="pill" data-src="yesterday">Yesterday</button>
        <button class="pill" data-src="almost">Almost Gone</button>
      </div>
    </div>
  </div>
</header>

<div class="toolbar">
  <div class="wrap">
    <div class="tools">
      <div class="search">
        <input id="q" placeholder="Search products… e.g., sweaters, leggings, kitchen"/>
      </div>
      <select id="cat" class="select"><option value="__all__">All categories</option></select>
      <select id="sort" class="select">
        <option value="newest">Newest</option>
        <option value="pricelow">Price: Low → High</option>
        <option value="pricehigh">Price: High → Low</option>
      </select>
    </div>
  </div>
</div>

<main class="wrap">
  <div id="grid" class="grid"><p>Loading…</p></div>
  <div id="empty" class="empty">No items match your search/filter.</div>
</main>

<script>
/* ====== CONFIG: CSV sources ====== */
const CSV_TODAY     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=23655256&single=true&output=csv";
const CSV_YESTERDAY = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=1955863351&single=true&output=csv";
const CSV_ALMOST    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=499142778&single=true&output=csv";

const SUBSCRIBERS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_hOlderdV0ABENcLrWMZFl8zXEqXii-3TnA55f13uVNMArQJjDw9OskRH1gLLQLIivHl5zOeH0yKb/pub?gid=0&single=true&output=csv";
const DOMAIN = "bagthatthangup.com";

/* ====== helpers ====== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function parseCSV(text){
  const rows=[]; let row=[], cell="", inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], nx=text[i+1];
    if(inQ){ if(ch==='"'&&nx==='"'){cell+='"';i++;} else if(ch==='"'){inQ=false;} else{cell+=ch;} }
    else { if(ch==='"'){inQ=true;} else if(ch===','){row.push(cell);cell="";}
           else if(ch==='\r'&&nx==='\n'){row.push(cell);rows.push(row);row=[];cell="";i++;}
           else if(ch==='\n'){row.push(cell);rows.push(row);row=[];cell="";} else{cell+=ch;} }
  }
  if(cell!==""||row.length){row.push(cell);rows.push(row);}
  return rows.filter(r=>r.length>1);
}
function toObjects(rows){
  if(!rows.length) return [];
  const headers = rows[0].map(h=>String(h||"").trim());
  const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));
  return rows.slice(1).map((r,ix)=>{
    const o={ _ix: ix };
    for(const [h,i] of Object.entries(idx)) o[h]=(r[i]||"").toString().trim();
    return o;
  });
}
function moneyNum(s){ const m=String(s||'').replace(/[, $]/g,'').match(/(\d+(?:\.\d+)?)/); return m?parseFloat(m[1]):NaN; }
function toMoney(n){ return isFinite(n) ? "$"+Number(n).toFixed(2) : ""; }
function replaceTag(url, tag){
  if(!url) return "";
  const u = new URL(url.replace(/^http:/,'https:'));
  u.searchParams.delete('tag');
  if(tag) u.searchParams.append('tag', tag);
  return u.toString();
}
function appendTagFromAsin(asin, tag){
  if(!/^[A-Z0-9]{10}$/.test(String(asin))) return "";
  const u = new URL("https://www.amazon.com/dp/"+asin);
  if(tag) u.searchParams.set("tag", tag);
  return u.toString();
}
function getSubdomain(){
  const host = location.host.toLowerCase();
  if (host.endsWith("."+DOMAIN)) return host.slice(0, -(DOMAIN.length+1)); // foo.bagthatthangup.com
  const qs=new URLSearchParams(location.search).get("sub");
  return qs ? String(qs).toLowerCase() : "";
}

/* ====== UI pieces ====== */
function setBrand(c1, c2, name, logo){
  if(c1) document.documentElement.style.setProperty('--brand1', c1);
  if(c2) document.documentElement.style.setProperty('--brand2', c2);
  if(name) { $('#title').textContent=name; document.title=name+" — Deals"; }
  if(logo){ const el=$('#logo'); el.src=logo; el.style.display='block'; }
}

/* ====== Cards ====== */
function computePrices(d){
  const deal = moneyNum(d.DiscountPrice || d.Price);
  const orig = moneyNum(d.OriginalPrice || d.ListPrice || d.MSRP || d.WasPrice || d.OrigPrice || "");
  const dealStr = isFinite(deal) ? toMoney(deal) : "";
  const origStr = (isFinite(orig) && isFinite(deal) && orig > deal + 0.01) ? toMoney(orig) : "";
  return {dealStr, origStr};
}
function pickImage(d){
  const raw = d.ImageURL_raw || d.ImageURL_clean || d.ImageURL_generated || d.Image || "";
  return raw ? raw.replace(/^http:/,'https:') : "";
}
function cardHTML(d, tag){
  const asin = (d.ASIN_Text||d.ASIN||"").toUpperCase();
  const title = d.Title || d.ProductTitle || "";
  const promo = (d.PromoCode || d.Promo || "").trim();
  const hasCoupon = /^(true|1|yes)$/i.test(String(d.HasCoupon||""));
  const autoApplies = /amazon\.com\/promocode\//i.test(String(d.TaggedLink||d.Link||""));
  // Link: prefer promo page or tagged, but normalize tag to tenant
  let href = d.TaggedLink || d.Link || "";
  if (href) href = replaceTag(href, tag);
  if (!href) href = appendTagFromAsin(asin, tag);

  const img = pickImage(d);
  const {dealStr, origStr} = computePrices(d);
  const cat = d.Category || "";
  const stars = d.Stars ? `<div class="stars">${d.Stars} ⭐</div>` : "";
  const meta = autoApplies ? (promo ? `Promo auto-applies — ${promo}` : `Auto-applied discount`)
                           : (promo ? `Copy promo code — ${promo}` : (hasCoupon ? `Clip coupon on product page` : `No promo code needed`));
  return `
  <article class="card" data-cat="${(cat||'').toLowerCase()}" data-search="${(title+' '+cat+' '+asin+' '+(promo||'')).toLowerCase()}">
    <div class="media">${img ? `<img src="${img}" alt="">` : ``}</div>
    <div class="body">
      <div class="tags">
        ${asin ? `<span class="tag">ASIN ${asin}</span>`:''}
        ${cat ? `<span class="tag">${cat}</span>`:''}
      </div>
      <div class="title">${title}</div>
      ${stars}
      ${(origStr || dealStr) ? `<div class="price"><span class="orig">${origStr}</span><span class="deal">${dealStr}</span></div>`:``}
      <div class="meta">${meta}</div>
      <div class="actions">
        ${href ? `<a class="btn" href="${href}" target="_blank" rel="nofollow noopener">Go to Amazon</a>`:''}
        ${promo ? `<button class="btn2" onclick="navigator.clipboard.writeText('${promo}')">Copy Code</button>`:''}
      </div>
    </div>
  </article>`;
}

/* ====== Load + Render ====== */
let ALL=[], SOURCE='today', QUERY='', CAT='__all__', SORT='newest', TENANT=null;

function render(){
  let rows = ALL;
  if (QUERY){ const q=QUERY.toLowerCase(); rows = rows.filter(d => (d._search||'').includes(q)); }
  if (CAT !== '__all__'){ rows = rows.filter(d => (d.Category||'').toLowerCase() === CAT.toLowerCase()); }
  if (SORT==='pricelow'){ rows = rows.slice().sort((a,b)=>(moneyNum(a.DiscountPrice||a.Price)||1e9)-(moneyNum(b.DiscountPrice||b.Price)||1e9)); }
  if (SORT==='pricehigh'){ rows = rows.slice().sort((a,b)=>(moneyNum(b.DiscountPrice||b.Price)||-1e9)-(moneyNum(a.DiscountPrice||a.Price)||-1e9)); }
  const g=$("#grid"), empty=$("#empty");
  if (!rows.length) { g.innerHTML=""; empty.classList.add('show'); return; }
  empty.classList.remove('show');
  g.innerHTML = rows.map(d => cardHTML(d, TENANT.amazon_tag)).join("");
}

function fillCategories(rows){
  const cats = Array.from(new Set(rows.map(r=>(r.Category||'').trim()).filter(Boolean))).sort();
  const sel = $("#cat");
  sel.innerHTML = `<option value="__all__">All categories</option>` + cats.map(c=>`<option>${c}</option>`).join('');
}

async function fetchCSV(url){
  const res = await fetch(url + "&cb=" + Date.now(), {cache:'no-store'});
  if(!res.ok) throw new Error('fetch failed');
  const text = await res.text();
  return toObjects(parseCSV(text));
}

async function loadDeals(src){
  SOURCE = src;
  $$(".pill").forEach(b=>b.classList.toggle('active', b.dataset.src===src));
  const [today,yest,almost] = await Promise.all([fetchCSV(CSV_TODAY), fetchCSV(CSV_YESTERDAY), fetchCSV(CSV_ALMOST)]);
  let set = src==='today' ? today : src==='yesterday' ? yest : almost;
  // Precompute search field
  set = set.map(d => { d._search=((d.Title||'')+' '+(d.Category||'')+' '+(d.ASIN_Text||'')+' '+(d.PromoCode||'')).toLowerCase(); return d; });
  ALL = set;
  fillCategories(ALL);
  render();
}

async function loadTenant(){
  const sub = getSubdomain();
  if (!sub){ document.title="Site not found"; $("#grid").innerHTML="<p>Missing subdomain.</p>"; return; }

  // Pull Subscribers CSV and find this tenant
  const list = await fetchCSV(SUBSCRIBERS_CSV);
  const row = list.find(r => String(r.subdomain||'').toLowerCase()===sub && !/^canceled|deleted$/i.test(String(r.status||'')));
  if (!row){ document.title="Site not found"; $("#grid").innerHTML="<p>Site not found. Please complete onboarding.</p>"; return; }

  // Bind tenant config
  TENANT = {
    subdomain: sub,
    name: row.site_display_name || sub,
    amazon_tag: row.amazon_tag || '',
    color1: row.color_primary || '',
    color2: row.color_secondary || '',
    logo: row.logo_url || '',
    layout: row.layout || 'grid'
  };

  setBrand(TENANT.color1, TENANT.color2, TENANT.name, TENANT.logo);
  await loadDeals('today');
}

/* ====== Events ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  $("#q").addEventListener('input', e=>{ QUERY=e.target.value; render(); });
  $("#cat").addEventListener('change', e=>{ CAT=e.target.value; render(); });
  $("#sort").addEventListener('change', e=>{ SORT=e.target.value; render(); });
  document.addEventListener('click', e=>{ const btn=e.target.closest('.pill'); if(btn){ loadDeals(btn.dataset.src); } });
  loadTenant().catch(err=>{ console.error(err); $("#grid").innerHTML="<p>Could not load site.</p>"; });
});
</script>
</body>
</html>
