<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title id="siteTitle">BagThat Storefront</title>
<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 0;
    background: var(--bg,#f6faf9);
    color: #0b1320;
  }
  header {
    text-align: center;
    padding: 20px 10px;
    background: var(--primary,#0f915a);
    color: #fff;
  }
  header img {max-height:60px;margin-bottom:10px}
  main {
    display: grid;
    gap: 16px;
    padding: 20px;
  }
  .deal {
    background:#fff;
    border-radius:16px;
    box-shadow:0 4px 14px rgba(0,0,0,.06);
    padding:16px;
    text-align:center;
  }
  .deal img {max-width:100%;border-radius:12px}
  .btn-extra {
    display:inline-block;
    background: var(--accent,#1e90ff);
    color:#fff;
    padding:10px 18px;
    border-radius:10px;
    text-decoration:none;
    font-weight:600;
    margin:10px auto;
  }
  .disclosure{position:fixed;top:0;left:0;width:100%;background:#0f915a;color:#fff;text-align:center;font-size:14px;font-weight:500;padding:6px 10px;z-index:1000}
  body{margin-top:40px}
</style>
</head>
<body>
<div class="disclosure">As an Amazon Associate I earn from qualifying purchases.</div>
<header>
  <img id="logo" alt="" style="display:none">
  <h1 id="storeName">Loading...</h1>
  <a id="extraBtn" class="btn-extra" href="#" target="_blank" style="display:none"></a>
</header>
<main id="deals"></main>

<script>
const GAS="https://script.google.com/macros/s/AKfycbytm-ntU4HHZq4PDXpwr4qoflZUy8Hcg-7GFLT0RFUJGuKIG0Zy3lIDEYTRBt7UVqkK/exec";

// detect subdomain + plan
const host=location.hostname;
const sub=host.split('.')[0];
const plan=(sub==='www'||sub==='bagthatthangup')?'basic':'custom';

async function loadTenant(){
  const url=`${GAS}?action=getTenant&subdomain=${sub}&plan=${plan}&callback=cb`;
  const res=await fetch(url);
  const txt=await res.text();
  const match=txt.match(/\((.*)\)$/);
  const json=match?JSON.parse(match[1]):null;
  if(!json||!json.ok){document.getElementById('storeName').textContent='Not found';return;}
  
  // Apply branding
  document.title=json.site_display_name || 'BagThat';
  document.getElementById('storeName').textContent=json.site_display_name || 'BagThat';
  if(json.logo_url){
    const logo=document.getElementById('logo');
    logo.src=json.logo_url;
    logo.style.display='block';
  }
  if(json.color_primary){
    document.documentElement.style.setProperty('--primary',json.color_primary);
  }
  if(json.color_secondary){
    document.documentElement.style.setProperty('--accent',json.color_secondary);
  }
  if(json.extra_button_label && json.extra_button_url){
    const btn=document.getElementById('extraBtn');
    btn.textContent=json.extra_button_label;
    btn.href=json.extra_button_url;
    btn.style.display='inline-block';
  }
  // load deals CSV
  loadDeals(json.amazon_tag);
}

async function loadDeals(tag){
  // Fetch sample deals CSV from your master source (replace as needed)
  const url='https://docs.google.com/spreadsheets/d/e/2PACX-1vSAMPLE123/pub?output=csv';
  const res=await fetch(url);
  const txt=await res.text();
  const rows=txt.split('\n').slice(1,6); // sample 5
  const html=rows.map(r=>{
    const cols=r.split(',');
    const link=cols[2]?(cols[2].trim()+`&tag=${tag}`):'#';
    return `<div class="deal"><img src="${cols[1]}" alt=""><p>${cols[0]}</p><a href="${link}" target="_blank">Shop Now</a></div>`;
  }).join('');
  document.getElementById('deals').innerHTML=html;
}

loadTenant();
</script>
</body>
</html>
