<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BagThat Storefront</title>
  <meta name="description" content="Your personal Amazon deals storefront powered by BagThat.">
  <style>
    :root {
      --ink:#0b1320; --accent:#0b403b; --muted:#4d6375;
      --bg:#f6faf9; --card:#fff; --radius:14px;
      --shadow:0 4px 14px rgba(0,0,0,0.08);
    }
    body {margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    header {background:var(--accent);color:#fff;text-align:center;padding:1.75rem;}
    h1 {margin:0;font-size:1.9rem;font-weight:700;}
    nav {display:flex;justify-content:center;gap:1rem;margin-top:.75rem;flex-wrap:wrap;}
    nav button {background:#fff;color:var(--accent);border:none;padding:.6rem 1.2rem;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s;}
    nav button:hover {background:#dceeea;}
    nav button.active {background:var(--accent);color:#fff;}
    .grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1.25rem;padding:2rem;}
    .card {background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform .2s;}
    .card:hover {transform:translateY(-4px);}
    .card img {width:100%;height:230px;object-fit:cover;}
    .card-content {padding:1rem;display:flex;flex-direction:column;flex:1;}
    .title {font-weight:600;margin-bottom:.5rem;line-height:1.3;flex:1;}
    .stars {color:#f5a623;font-size:1rem;margin-bottom:.4rem;}
    .price {color:var(--accent);font-weight:700;margin-bottom:.3rem;}
    .original {text-decoration:line-through;color:#999;font-size:.9rem;margin-bottom:.6rem;}
    .promo {font-size:.9rem;color:#e53935;margin-bottom:.6rem;}
    .category {font-size:.85rem;color:var(--muted);margin-bottom:.8rem;}
    .btn {text-align:center;background:var(--accent);color:#fff;padding:.6rem;border-radius:8px;text-decoration:none;font-weight:600;}
  </style>
</head>
<body>
  <header>
    <h1 id="storeName">BagThat Storefront</h1>
    <nav>
      <button class="active" data-tab="today">Today’s Deals</button>
      <button data-tab="yesterday">Yesterday</button>
      <button data-tab="almost">Almost Gone</button>
    </nav>
  </header>
  <main>
    <div id="dealGrid" class="grid"></div>
  </main>

  <script type="module">
    const supabaseUrl = "https://gmsjqunfsffjiksffvem.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtc2pxdW5mc2Zmamlrc2ZmdmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NzIxNTgsImV4cCI6MjA3NjQ0ODE1OH0.7qEXKk8f8Sd3G2y8KyQ0XbeCyG8ieD-8WV18-_JkRGc";
    const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
    const supabase = createClient(supabaseUrl, supabaseKey);

    const host = window.location.hostname;
    const subdomain = host.split('.')[0];
    let amazonId = "azillionaires-20";

    const sources = {
      today:'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=23655256&single=true&output=csv',
      yesterday:'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=1955863351&single=true&output=csv',
      almost:'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=499142778&single=true&output=csv'
    };

    async function loadTenant(){
      try{
        const {data} = await supabase.from("Users").select("*").eq("subdomain",subdomain).single();
        if(data){
          document.getElementById("storeName").textContent = data.site_name || "BagThat Storefront";
          amazonId = data.amazon_id || amazonId;
        }
      }catch{console.warn("Using default tag.");}
    }

    async function fetchDeals(tab){
      const grid=document.getElementById("dealGrid");
      grid.innerHTML="<p>Loading deals...</p>";
      const res=await fetch(sources[tab]);
      const text=await res.text();
      const rows=text.split("\n").slice(1);
      grid.innerHTML="";
      rows.forEach(row=>{
        const cols=row.split(",");
        const [img,,price,promo,, ,link,,,, ,title,category,stars,orig]=cols;
        if(!title)return;
        const tagged=link.includes("tag=")?link:link+(link.includes("?")?"&":"?")+"tag="+amazonId;
        const starRating=parseFloat(stars)||4.5;
        const starsHtml="★".repeat(Math.floor(starRating))+"☆".repeat(5-Math.floor(starRating));
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <img src="${img||'/assets/images/feature1.jpg'}" alt="${title}">
          <div class="card-content">
            <div class="title">${title}</div>
            <div class="stars">${starsHtml}</div>
            ${orig?`<div class="original">${orig}</div>`:""}
            <div class="price">${price||""}</div>
            ${promo?`<div class="promo">${promo}</div>`:""}
            ${category?`<div class="category">${category}</div>`:""}
            <a class="btn" href="${tagged}" target="_blank">Go to Amazon</a>
          </div>`;
        grid.appendChild(card);
      });
    }

    document.querySelectorAll("nav button").forEach(btn=>{
      btn.addEventListener("click",e=>{
        document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
        e.target.classList.add("active");
        fetchDeals(e.target.dataset.tab);
      });
    });

    await loadTenant();
    fetchDeals("today");
  </script>
</body>
</html>
