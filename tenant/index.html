<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Deals — Powered by BagThat</title>
<meta name="description" content="Daily Amazon promo codes & deals — auto-updated and tagged for your associate ID.">
<link rel="icon" href="/favicon.png" sizes="32x32">
<link rel="apple-touch-icon" href="/favicon.png">

<!-- ====== Base + Polish Styles ====== -->
<style>
  :root{
    /* design tokens */
    --brand:#0ea5a6; --accent:#1e90ff;
    --ink:#0b1320; --muted:#4b6373;
    --bg:#f7fafc; --surface:#fff; --line:#e8eef5;
    --ok:#0c6e53; --warn:#ff8a1f;
    --shadow-sm: 0 6px 14px rgba(2,24,43,.08);
    --shadow-md: 0 14px 34px rgba(2,24,43,.12);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  a{color:inherit;text-decoration:none}
  img{display:block;max-width:100%}

  /* Top chips */
  .topbar{
    background:#ffffffcc;
    backdrop-filter:saturate(180%) blur(10px);
    border-bottom:1px solid #e8eff0;
    font-size:12px;
  }
  .topbar .inner{
    max-width:1200px;margin:0 auto;padding:8px 14px;
    display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-start;
  }
  .chip{
    background:#eef7ff;color:#083663;border:1px solid #d9e7ff;
    padding:6px 10px;border-radius:999px;font-weight:800
  }

  /* Hero */
  .hero{
    background:linear-gradient(145deg, var(--brand), var(--accent));
    color:#fff;border-bottom:1px solid #dfeaf2
  }
  .hero .inner{
    max-width:1200px;margin:0 auto;
    padding:18px 16px;
    display:grid;gap:14px;grid-template-columns:56px 1fr;align-items:center;
  }
  .avatar{
    width:56px;height:56px;border-radius:999px;border:2px solid rgba(255,255,255,.9);
    object-fit:cover;background:#fff
  }
  .h1{margin:0 0 2px;font-size:clamp(22px,2.2vw,32px);font-weight:900}
  .sub{margin:0 0 8px;color:#eaf7ff}
  .hero .actions{display:flex;gap:10px;flex-wrap:wrap}
  .pill{
    background:#fff;color:#083663;border:1px solid #d9e7ff;
    padding:8px 12px;border-radius:999px;font-weight:800;cursor:pointer
  }
  .pill.primary{background:#06345a;color:#fff;border-color:#06345a}

  /* Toolbar */
  .toolbar{position:sticky;top:0;z-index:80;background:#f6faf9cc;backdrop-filter:saturate(160%) blur(10px);border-bottom:1px solid #e8eef5}
  .toolbar .wrap{max-width:1200px;margin:0 auto;padding:10px 16px;display:grid;gap:10px}
  .toolbar-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .search{
    flex:1;min-width:220px;background:#fff;border:1px solid var(--line);border-radius:999px;
    display:flex;gap:8px;padding:10px 14px;box-shadow:var(--shadow-sm)
  }
  .search input{border:0;outline:0;flex:1;font-size:15px;color:#0d2530}
  .select{min-width:170px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-weight:700;color:#083663}
  .ghost{padding:10px 12px;border-radius:10px;background:#e9f8f7;border:1px solid #cfeeee;font-weight:800;cursor:pointer}

  /* Main */
  .wrap{max-width:1200px;margin:0 auto;padding:0 16px}

  /* Grid + Cards */
  .grid{display:grid;gap:16px;margin:16px 0 36px}
  @media (max-width:599px){ .grid{grid-template-columns:1fr} }
  @media (min-width:600px){ .grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))} }

  .card{
    display:flex;flex-direction:column;background:var(--surface);
    border:1px solid var(--line);border-radius:16px;
    box-shadow:var(--shadow-sm);
    transition: transform .08s ease, box-shadow .2s ease;
    min-height:100%;
  }
  .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
  .media{
    background:#fff;border-bottom:1px solid var(--line);
    display:flex;justify-content:center;align-items:flex-start;overflow:hidden;padding:10px;height:240px
  }
  @media (max-width:599px){ .media{height:220px} }
  .media img{max-width:100%;max-height:100%;height:auto;width:auto;object-fit:contain;object-position:top center}
  .body{padding:12px;display:flex;flex-direction:column;gap:8px}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin:0}
  .tag{
    font-size:10.5px;padding:3px 6px;border-radius:999px;font-weight:700;white-space:nowrap;
    background:#eef7ff;color:#083663;border:1px solid #cfe6ff
  }
  .cc{background:#e9fbf1;border:1px solid #b9efd1;color:#0b4c2f}
  .title-line{font-size:15px;font-weight:800;line-height:1.25;margin:2px 0 4px}
  .stars{font-size:14px;color:#f39c12;font-weight:700}
  .price-box{display:flex;align-items:baseline;gap:8px}
  .original-price{color:#8aa0ad;text-decoration:line-through;font-size:12.5px}
  .deal-price{color:var(--ok);font-weight:900;font-size:18px;letter-spacing:.1px}
  .meta2{display:flex;gap:8px;flex-wrap:wrap;font-size:12.5px;color:#0b3d3f}
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
  @media (max-width:599px){ .actions{grid-template-columns:1fr} }
  .btn{
    display:inline-block;text-align:center;padding:12px;border-radius:12px;border:1px solid #0b7247;background:var(--ok);color:#fff;font-weight:900;
    transition:filter .15s ease, transform .04s ease
  }
  .btn:hover{filter:brightness(.96)} .btn:active{transform:translateY(1px)}
  .btn-code{
    display:inline-block;text-align:center;padding:12px;border-radius:12px;background:#fff;color:#083663;border:1px solid #cfeeee;font-weight:900
  }
  .btn-share{
    display:inline-grid;grid-auto-flow:column;place-content:center;gap:8px;padding:12px;border-radius:12px;border:1px solid #ffd7b0;background:#ff9a1f;color:#fff;font-weight:900
  }
  .actions > *{min-width:0;max-width:100%}

  .empty{display:none;text-align:center;color:#4e6a79;padding:40px 16px}
  .empty.show{display:block}

  .errbox{max-width:900px;margin:40px auto;padding:18px;border:2px solid #ffd2d2;background:#fff6f6;border-radius:14px;color:#8a1f1f}

  footer{color:#4e6a79;border-top:1px solid #e8eef5;padding:24px 0;margin-top:16px}

  /* Focus states */
  .card a:focus,.btn:focus,.btn-code:focus,.pill:focus{
    outline:2px solid #fff; outline-offset:2px; box-shadow:0 0 0 3px rgba(14,165,166,.45);
  }

  /* Slightly tighter on very small screens */
  @media (max-width:420px){
    .title-line{font-size:14px}
    .deal-price{font-size:17px}
    .media{height:200px}
  }
</style>
</head>
<body>
  <div id="fatal" class="errbox" style="display:none"></div>

  <!-- Chips row -->
  <div class="topbar">
    <div class="inner">
      <span id="siteChip" class="chip">Loading site…</span>
      <span id="lastUpdated" class="chip">Last updated: —</span>
      <span id="dealCount" class="chip">Deals shown: —</span>
    </div>
  </div>

  <!-- Hero -->
  <header class="hero">
    <div class="inner">
      <img id="logo" class="avatar" src="" alt="Logo" onerror="this.style.display='none'">
      <div>
        <h1 id="headline" class="h1">Deals</h1>
        <p class="sub" id="subhead">Daily promo codes, coupons and finds.</p>
        <div class="actions">
          <button class="pill primary tab" data-src="today">Today's Deals</button>
          <button class="pill tab" data-src="yesterday">Yesterday</button>
          <button class="pill tab" data-src="almost">Almost Gone</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="wrap">
      <div class="toolbar-row">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#4e6a79" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="search" type="search" placeholder="Search products… e.g., sweaters, leggings, kitchen" aria-label="Search deals"/>
        </div>
        <select id="category" class="select" aria-label="Filter by category">
          <option value="__all__" selected>All categories</option>
        </select>
        <select id="sort" class="select" aria-label="Sort deals">
          <option value="newest" selected>Newest</option>
          <option value="pricelow">Price: Low → High</option>
          <option value="pricehigh">Price: High → Low</option>
        </select>
        <button id="reset" class="ghost" type="button">Reset</button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <main id="main" class="wrap">
    <div id="grid" class="grid"><p>Loading deals…</p></div>
    <div id="empty" class="empty">No items match your search/filter. Try a different keyword.</div>
  </main>

  <footer class="wrap">
    <p><b>Disclosure:</b> As an Amazon Associate I earn from qualifying purchases. Promo codes, coupons, and prices can change at any time.</p>
  </footer>

<script>
(function(){
  /* ====== STATIC SOURCES (same as your existing) ====== */
  const CSV_TODAY     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=23655256&single=true&output=csv";
  const CSV_YESTERDAY = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=1955863351&single=true&output=csv";
  const CSV_ALMOST    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8B3eTxf5t0-v2m2NNicpty89ci6LRrJlGnwauS0sLZa8VyAjpnHI1h15s0le8hEsqRbcS9BB0VwFm/pub?gid=499142778&single=true&output=csv";

  // Subscribers CSV (public) to resolve per-tenant config
  const SUBSCRIBERS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_hOlderdV0ABENcLrWMZFl8zXEqXii-3TnA55f13uVNMArQJjDw9OskRH1gLLQLIivHl5zOeH0yKb/pub?gid=0&single=true&output=csv";

  /* ====== DOM ====== */
  const $ = s => document.querySelector(s);
  const grid = $("#grid"), empty = $("#empty");
  const chipSite = $("#siteChip"), lastUpdated = $("#lastUpdated"), dealCount = $("#dealCount");
  const headline = $("#headline"), subhead = $("#subhead"), logo = $("#logo");

  /* ====== UTILS ====== */
  const esc = s => String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const toMoney = n => (isFinite(n) ? "$"+Number(n).toFixed(2) : "");
  const moneyNum = s => { const m = String(s||'').replace(/[, ]/g,'').match(/(\d+(?:\.\d+)?)/); return m?parseFloat(m[1]):NaN; };
  const percentNum = s => { const m = String(s||'').match(/(\d+(?:\.\d+)?)\s*%/); return m?parseFloat(m[1]):NaN; };

  function parseCSV(text){
    const rows=[]; let row=[], cell="", inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i], nx=text[i+1];
      if(inQ){
        if(ch==='"'&&nx==='"'){cell+='"';i++;}
        else if(ch==='"'){inQ=false;}
        else{cell+=ch;}
      }else{
        if(ch==='"'){inQ=true;}
        else if(ch===','){row.push(cell);cell="";}
        else if(ch==='\r'&&nx==='\n'){row.push(cell);rows.push(row);row=[];cell="";i++;}
        else if(ch==='\n'){row.push(cell);rows.push(row);row=[];cell="";}
        else{cell+=ch;}
      }
    }
    if(cell!==""||row.length){row.push(cell);rows.push(row);}
    return rows.filter(r=>r.length>1);
  }
  function toObjects(rows){
    if(!rows.length) return [];
    const headers = rows[0].map(h=>String(h||"").trim());
    const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));
    return rows.slice(1).map((r,ix)=>{
      const o={ _ix: ix};
      for(const [h,i] of Object.entries(idx)){ o[h]=(r[i]||"").toString().trim(); }
      return o;
    });
  }
  async function fetchCSV(url){
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('CSV fetch failed');
    const text = await res.text();
    return toObjects(parseCSV(text));
  }
  function setTheme(primary, secondary){
    if (primary) document.documentElement.style.setProperty('--brand', primary);
    if (secondary) document.documentElement.style.setProperty('--accent', secondary);
  }
  function retagURL(url, tag){
    if (!url) return "";
    try{
      const u = new URL(url.replace(/^http:/,'https:'));
      if (u.hostname.endsWith("amazon.com")){
        // remove existing tag and set new one
        u.searchParams.delete('tag');
        u.searchParams.set('tag', tag);
        return u.toString();
      }
      return url;
    }catch(_){ return url; }
  }
  function buildAmazonLink(obj, tag){
    const asin = (obj.ASIN_Text||obj.ASIN||"").toUpperCase();
    let href  = obj.TaggedLink || obj.Link || "";
    const promoAuto = /amazon\.com\/promocode\//i.test(href);
    if (!href){
      if (/^[A-Z0-9]{10}$/.test(asin)) href = `https://www.amazon.com/dp/${asin}`;
    }
    if (href) href = retagURL(href, tag);
    return { href, promoAuto };
  }
  function computePrices(d){
    const deal = (isFinite(moneyNum(d.DiscountPrice)) ? moneyNum(d.DiscountPrice)
                 : isFinite(moneyNum(d.Price)) ? moneyNum(d.Price) : NaN);
    const candidates = [d.OriginalPrice,d.ListPrice,d.MSRP,d.WasPrice,d.OrigPrice,d.CompareAt]
      .map(moneyNum).filter(x=>isFinite(x));
    let orig = candidates.length ? candidates[0] : NaN;
    if(!isFinite(orig)){
      const pct = percentNum(d.Discount||d.PercentOff||d.PctOff);
      if (isFinite(deal) && isFinite(pct) && pct>0 && pct<100) orig = deal/(1-pct/100);
    }
    if(!isFinite(orig)){
      const priceField = moneyNum(d.Price);
      if (isFinite(deal) && isFinite(priceField) && priceField > deal + 0.01) orig = priceField;
    }
    const dealStr = isFinite(deal) ? toMoney(deal) : "";
    const origStr = (isFinite(orig) && isFinite(deal) && orig > deal + 0.01) ? toMoney(orig) : "";
    return { dealStr, origStr };
  }
  function pickImage(o){
    const raw=o.ImageURL_raw||"", clean=o.ImageURL_clean||"", gen=o.ImageURL_generated||"", fallback=o.Image||"";
    const cand = raw || clean || gen || fallback;
    return cand ? cand.replace(/^http:/i,"https:") : "";
  }

  /* ====== RENDER ====== */
  function cardHTML(d, tag){
    const asin = (d.ASIN_Text||d.ASIN||"").toUpperCase();
    const title = d.Title || d.ProductTitle || "";
    const img = pickImage(d);
    const promo = (d.PromoCode || d.Promo || "").trim();
    const { href, promoAuto } = buildAmazonLink(d, tag);
    const hasCoupon   = /^(true|1|yes)$/i.test(String(d.HasCoupon||""));
    const ccFlag = String(d.CCFlag||"").trim().toLowerCase().startsWith('y');
    const stars = d.Stars ? `<div class="stars">${esc(d.Stars)} ⭐</div>` : "";
    const thecat = d.Category || "";
    const { dealStr, origStr } = computePrices(d);

    const dealLine = promoAuto
      ? (promo ? `Promo code auto applies — ${esc(promo)}` : `Auto-applied discount`)
      : (promo ? `Copy promo code — ${esc(promo)}` : (hasCoupon ? `Clip coupon on product page` : `No promo code needed`));

    const btns = [];
    if (promo){ btns.push(`<button class="btn-code" onclick="navigator.clipboard.writeText('${esc(promo)}')">Copy Code</button>`); }
    if (href){ btns.push(`<a class="btn" href="${esc(href)}" target="_blank" rel="nofollow noopener noreferrer">Go to Amazon</a>`); }

    return `
      <article class="card" data-cat="${esc(thecat)}" data-search="${(title+' '+thecat+' '+asin+' '+(promo||'')).toLowerCase()}">
        <div class="media">${img ? `<img src="${esc(img)}" alt="${esc(title||'Amazon product')}">` : ``}</div>
        <div class="body">
          <div class="tags">
            ${asin ? `<span class="tag">ASIN ${esc(asin)}</span>`:''}
            ${thecat ? `<span class="tag">${esc(thecat)}</span>`:''}
            ${ccFlag ? `<span class="tag cc">✓ CC</span>`:''}
          </div>
          ${title ? `<div class="title-line">${esc(title)}</div>`:''}
          ${stars}
          ${(origStr || dealStr) ? `
            <div class="price-box" aria-label="Price">
              ${origStr ? `<span class="original-price" aria-hidden="true">${esc(origStr)}</span>`:''}
              ${dealStr ? `<span class="deal-price">${esc(dealStr)}</span>`:''}
            </div>` : ``}
          <div class="meta2">${dealLine}</div>
          <div class="actions">${btns.join('')}</div>
        </div>
      </article>`;
  }

  function render(list, tag){
    if(!list.length){ grid.innerHTML=""; empty.classList.add("show"); dealCount.textContent="Deals shown: 0"; return; }
    empty.classList.remove("show");
    grid.innerHTML = list.map(d=>cardHTML(d, tag)).join("");
    dealCount.textContent = "Deals shown: " + list.length;
  }

  /* ====== FILTERS ====== */
  let ALL=[], SOURCE='today', QUERY='', CAT='__all__', SORT='newest', ASSOC_TAG='';
  function applyFilters(){
    let rows = ALL;
    if (QUERY){
      const q = QUERY.toLowerCase();
      rows = rows.filter(d => ((d.Title||'')+' '+(d.Category||'')+' '+(d.ASIN_Text||'')+' '+(d.PromoCode||'')).toLowerCase().includes(q));
    }
    if (CAT !== '__all__'){ rows = rows.filter(d => (d.Category||'').toLowerCase() === CAT.toLowerCase()); }
    if (SORT==='pricelow'){
      rows = rows.slice().sort((a,b)=>(moneyNum(a.DiscountPrice||a.Price)||1e9)-(moneyNum(b.DiscountPrice||b.Price)||1e9));
    } else if (SORT==='pricehigh'){
      rows = rows.slice().sort((a,b)=>(moneyNum(b.DiscountPrice||b.Price)||-1e9)-(moneyNum(a.DiscountPrice||a.Price)||-1e9));
    }
    render(rows, ASSOC_TAG);
  }
  function fillCategories(rows){
    const cats = Array.from(new Set(rows.map(r=>(r.Category||'').trim()).filter(Boolean))).sort();
    const sel = document.getElementById("category");
    sel.innerHTML = `<option value="__all__" selected>All categories</option>` + cats.map(c=>`<option>${esc(c)}</option>`).join('');
  }

  /* ====== TENANT CONFIG (by subdomain) ====== */
  function currentSubdomain(){
    const host = location.host; // e.g., demo1.bagthatthangup.com
    const parts = host.split('.');
    if (parts.length < 3) return ''; // apex or unexpected
    return parts[0].toLowerCase();
  }
  async function loadTenant(){
    const sub = currentSubdomain();
    if (!sub){
      throw new Error("This page must be accessed via your subdomain, e.g., demo1.bagthatthangup.com");
    }
    const rows = await fetchCSV(SUBSCRIBERS_CSV);
    const row = rows.find(r => String(r.subdomain||'').toLowerCase()===sub && !/^canceled|deleted$/i.test(String(r.status||'')));
    if (!row) throw new Error("Site not found or inactive. If you just signed up, finish onboarding.");
    const siteName = row.site_display_name || sub;
    const color1 = (row.color_primary||'').trim();
    const color2 = (row.color_secondary||'').trim();
    const logoURL = (row.logo_url||'').trim();
    const plan = (row.plan||'').trim();
    const layout = (row.layout||'').trim();
    const tag = (row.amazon_tag||'').trim();

    if (!tag) console.warn("No amazon_tag set for tenant:", sub);

    ASSOC_TAG = tag;
    headline.textContent = siteName;
    chipSite.textContent = siteName;
    if (logoURL) { logo.src = logoURL; logo.style.display='block'; }
    setTheme(color1, color2);

    // Optional: tweak layout choices by plan (kept simple here)
    document.body.dataset.layout = layout || (plan==='Basic' ? 'rows' : 'grid');

    return { sub, siteName, tag };
  }

  /* ====== DEALS LOAD ====== */
  async function loadDeals(src){
    SOURCE = src;
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('primary', b.dataset.src===src));

    const [today, yest, almost] = await Promise.all([
      fetchCSV(CSV_TODAY), fetchCSV(CSV_YESTERDAY), fetchCSV(CSV_ALMOST)
    ]);
    if (src==='today') ALL = today;
    else if (src==='yesterday') ALL = yest;
    else if (src==='almost') ALL = almost;
    else ALL = [...today, ...yest, ...almost];

    // Update chips
    lastUpdated.textContent = "Last updated: " + new Date().toLocaleString();

    fillCategories(ALL);
    applyFilters();
  }

  /* ====== INIT ====== */
  document.addEventListener('DOMContentLoaded', async ()=>{
    try{
      const { tag } = await loadTenant();

      // controls
      document.getElementById("search").addEventListener('input', e=>{ QUERY=e.target.value; applyFilters(); });
      document.getElementById("category").addEventListener('change', e=>{ CAT=e.target.value; applyFilters(); });
      document.getElementById("sort").addEventListener('change', e=>{ SORT=e.target.value; applyFilters(); });
      document.getElementById("reset").addEventListener('click', ()=>{ QUERY=''; CAT='__all__'; SORT='newest';
        document.getElementById("search").value=''; document.getElementById("category").value='__all__'; document.getElementById("sort").value='newest'; applyFilters();
      });
      document.addEventListener('click', e=>{
        const btn = e.target.closest('.tab[data-src]');
        if (btn) loadDeals(btn.dataset.src);
      });

      await loadDeals('today');
    }catch(err){
      const box = document.getElementById('fatal');
      box.textContent = String(err.message || err);
      box.style.display = 'block';
      document.querySelector('.topbar').style.display='none';
      document.querySelector('.hero').style.display='none';
      document.querySelector('.toolbar').style.display='none';
      document.querySelector('main').style.display='none';
      document.querySelector('footer').style.display='none';
    }
  });
})();
</script>
</body>
</html>
