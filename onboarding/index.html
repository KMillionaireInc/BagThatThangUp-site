<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Finish Onboarding · BagThat</title>
  <meta name="color-scheme" content="light only">
  <style>
    :root{--ink:#0b1320;--muted:#4f6475;--bg:#f6faf9;--surface:#fff;--line:#e8eef5;--brand:#0b72f0;--good:#0c7a43;--bad:#b00020}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:34px auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:34px}
    .sub{margin:0 0 22px;color:var(--muted)}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:0 14px 34px rgba(2,24,43,.08);padding:18px}
    form{display:grid;gap:14px}
    label{font-weight:800;font-size:14px;margin-bottom:4px;display:block}
    .row{display:grid;gap:12px}
    @media (min-width:760px){ .row.two{grid-template-columns:1fr 1fr} }
    input,select{width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:12px;font-weight:600}
    .help{color:var(--muted);font-size:12px;margin-top:6px}
    .chip{display:inline-grid;grid-auto-flow:column;align-items:center;gap:10px;padding:8px 12px;border:1px solid #d9e7ff;background:#eef6ff;border-radius:999px;font-weight:900;color:#053a83}
    .hint{color:var(--muted);font-size:13px}
    .btn{display:inline-grid;grid-auto-flow:column;place-content:center;gap:10px;padding:12px 16px;border-radius:12px;border:1px solid #0b7247;background:#11835a;color:#fff;font-weight:900;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .ghost{padding:10px 12px;border-radius:10px;background:#e9f8f7;border:1px solid #cfeeee;font-weight:800}
    .status{font-size:13px;font-weight:800;margin-top:6px}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .errbox{margin:18px 0 0;padding:14px;border:2px solid #ffd2d2;background:#fff6f6;border-radius:14px;color:#8a1f1f;display:none}
    .okbox{margin:18px 0 0;padding:14px;border:2px solid #c9f2d8;background:#effbf4;border-radius:14px;color:#0b4c2f;display:none}
    .sep{height:1px;background:var(--line);margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Let’s set up your site</h1>
    <p class="sub">Payment succeeded (or you came here directly). Complete this quick one-time setup.</p>

    <div id="fatal" class="errbox"></div>

    <div class="card" id="gate">
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap">
        <div>
          <div class="chip">Selected plan: <span id="planName">—</span></div>
          <div class="hint" id="planHint" style="margin-top:8px"></div>
        </div>
        <a class="ghost" href="/pricing/">Choose a different plan</a>
      </div>
      <div class="sep"></div>

      <form id="form">
        <div class="row two">
          <div>
            <label for="display_name">Store display name</label>
            <input id="display_name" name="display_name" placeholder="Demo Deals" required>
          </div>
          <div>
            <label for="email">Contact email</label>
            <input id="email" name="email" type="email" placeholder="you@example.com" required>
          </div>
        </div>

        <div>
          <label for="subdomain">Site URL (subdomain)</label>
          <div class="row two">
            <input id="subdomain" name="subdomain" placeholder="yourname" required>
            <input value=".bagthatthangup.com" disabled>
          </div>
          <div id="subStatus" class="status"></div>
          <div class="help">Lowercase letters, numbers, and hyphens only. Example: <b>freshdemo27</b></div>
        </div>

        <div>
          <label for="amazon_tag">Amazon Associates ID</label>
          <input id="amazon_tag" name="amazon_tag" placeholder="yourtag-20">
          <div class="help">Optional for now — add it later in settings if you don’t have one yet.</div>
        </div>

        <div class="row two">
          <div>
            <label for="color_primary">Primary color (optional)</label>
            <input id="color_primary" name="color_primary" placeholder="#0ea5a6">
          </div>
          <div>
            <label for="color_secondary">Accent color (optional)</label>
            <input id="color_secondary" name="color_secondary" placeholder="#1e90ff">
          </div>
        </div>

        <div>
          <label for="logo_url">Logo URL (optional)</label>
          <input id="logo_url" name="logo_url" placeholder="https://…/logo.png">
        </div>

        <div class="sep"></div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="submitBtn" type="submit">Submit onboarding</button>
          <span class="hint">We’ll create your site and email your link.</span>
        </div>

        <div id="err" class="errbox"></div>
        <div id="ok" class="okbox"></div>
      </form>
    </div>
  </div>

  <script>
  // ---------- CONFIG ----------
  const MAIN_DOMAIN = "bagthatthangup.com";

  // Your Google Apps Script Web App URL (new deployment):
  const GAS_URL = "https://script.google.com/macros/s/AKfycbytm-ntU4HHZq4PDXpwr4qoflZUy8Hcg-7GFLT0RFUJGuKIG0Zy3lIDEYTRBt7UVqkK/exec";

  // ONLY accept these hard-to-guess plan keys (must match the keys you set in Stripe redirects)
  const PLAN_KEYS = {
    "btb_a1d4f8c93e2b47f6a8d9c0e2f3b1c5d7": { code: "Basic",  hint: "Ready-made template · One-click setup · Email support" },
    "btc_f9a4c7e2d1b0a6c3e8f4d2b7a1c9e0f5": { code: "Custom", hint: "Choose colors & layout · CSV import · Priority support" },
    "btp_7c2e9a5f1d3b4a8c6e0f2d9b1a4c7e3f": { code: "Pro",    hint: "Advanced layouts · Logo & featured slots · Concierge support" }
  };

  // Subdomain names we will not allow
  const RESERVED = new Set(["www","start","pricing","stripe","success","tenant","onboarding","api","assets","static","img","admin","root","dev","test"]);

  // ---------- UTILS ----------
  const $ = s => document.querySelector(s);
  function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function getParam(name){ return new URLSearchParams(location.search).get(name) || ""; }

  // Small JSONP helper for Apps Script (no CORS headache)
  function jsonp(url, timeoutMs=15000){
    return new Promise((resolve,reject)=>{
      const cb = "cb_"+Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cb;
      let done = false;
      window[cb] = (data)=>{ if(done) return; done = true; cleanup(); resolve(data); };
      s.onerror = ()=>{ if(done) return; done = true; cleanup(); reject(new Error("Network error")); };
      const to = setTimeout(()=>{ if(done) return; done = true; cleanup(); reject(new Error("Timeout")); }, timeoutMs);
      function cleanup(){ clearTimeout(to); delete window[cb]; s.remove(); }
      document.body.appendChild(s);
    });
  }

  // ---------- PLAN GATE ----------
  const planKey = getParam("plan_key").trim();
  const planInfo = PLAN_KEYS[planKey];

  function block(reason){
    const fatal = $("#fatal");
    fatal.style.display = "block";
    fatal.innerHTML = reason + ' <div class="help" style="margin-top:8px">Go back to <a href="/pricing/">pricing</a> to pick a plan.</div>';
    $("#gate").style.display = "none";
  }

  if(!planInfo){
    block("Could not verify your plan. (Missing or invalid plan key.)");
  }else{
    $("#planName").textContent = planInfo.code;
    $("#planHint").textContent = planInfo.hint;
  }

  // ---------- SUBDOMAIN CHECK ----------
  const subInput = $("#subdomain");
  const subStatus = $("#subStatus");
  let subTimer = null;

  function sanitizeSub(s){
    return String(s||"").toLowerCase().replace(/[^a-z0-9-]/g,"").replace(/^-+|-+$/g,"").slice(0,63);
  }

  async function checkSub(){
    const raw = subInput.value;
    const sub = sanitizeSub(raw);
    if(raw !== sub) subInput.value = sub;
    if(!sub){ subStatus.textContent=""; return; }
    if(RESERVED.has(sub)){
      subStatus.innerHTML = `<span class="bad">Sorry, that name is reserved.</span>`;
      return;
    }
    subStatus.textContent = "Checking availability…";
    try{
      const url = `${GAS_URL}?check=1&subdomain=${encodeURIComponent(sub)}`;
      const res = await jsonp(url);
      if(res && res.ok){
        if(res.exists){
          subStatus.innerHTML = `<span class="bad">That site URL is taken. Try another.</span>`;
        }else{
          subStatus.innerHTML = `<span class="good">Great — that site URL is available.</span>`;
        }
      }else{
        subStatus.innerHTML = `<span class="bad">Error checking name. Try again.</span>`;
      }
    }catch(_){
      subStatus.innerHTML = `<span class="bad">Network error while checking name.</span>`;
    }
  }

  subInput.addEventListener("input", ()=>{
    clearTimeout(subTimer);
    subTimer = setTimeout(checkSub, 500);
  });

  // ---------- SUBMIT ----------
  const form = $("#form");
  const btn = $("#submitBtn");
  const okBox = $("#ok");
  const errBox = $("#err");

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    errBox.style.display="none";
    okBox.style.display="none";

    if(!planInfo){ return block("Missing or invalid plan key."); }

    const display_name = $("#display_name").value.trim();
    const email        = $("#email").value.trim();
    const subdomain    = sanitizeSub($("#subdomain").value);
    const amazon_tag   = $("#amazon_tag").value.trim();
    const color_primary= $("#color_primary").value.trim();
    const color_secondary=$("#color_secondary").value.trim();
    const logo_url     = $("#logo_url").value.trim();

    if(!display_name || !email || !subdomain){
      errBox.style.display="block";
      errBox.textContent="Please complete all required fields.";
      return;
    }
    if(RESERVED.has(subdomain)){
      errBox.style.display="block";
      errBox.textContent="That subdomain is reserved. Choose another.";
      return;
    }

    btn.disabled = true; btn.textContent = "Submitting…";

    try{
      // Re-check just before writing
      const chk = await jsonp(`${GAS_URL}?check=1&subdomain=${encodeURIComponent(subdomain)}`);
      if(!(chk && chk.ok) || chk.exists){
        throw new Error("That site URL is taken. Pick a different one.");
      }

      const qs = new URLSearchParams({
        beacon: "1",
        plan: planInfo.code,
        site_display_name: display_name,
        email,
        subdomain,
        amazon_tag,
        color_primary,
        color_secondary,
        logo_url,
        layout: "", // optional
        featured_asins: "", // optional
        extra_page_enabled: "false",
        status: "active"
      });

      const res = await jsonp(`${GAS_URL}?${qs.toString()}`);
      if(!(res && res.ok)){
        throw new Error(res && res.error ? String(res.error) : "Unexpected error while saving.");
      }

      const siteURL = `https://${subdomain}.${MAIN_DOMAIN}/`;
      okBox.style.display="block";
      okBox.innerHTML = `Submitted. Your site will be available at <a href="${siteURL}">${siteURL}</a>. Bookmark and share your link.`;

      btn.textContent = "Submitted";
      setTimeout(()=>{ location.href = siteURL; }, 1200);

    }catch(err){
      errBox.style.display="block";
      errBox.textContent = String(err.message || err);
      btn.disabled = false; btn.textContent = "Submit onboarding";
    }
  });

  // If gate failed earlier, stop here.
  if(!planInfo){ /* blocked above */ }
  </script>
</body>
</html>
