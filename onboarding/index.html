<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Finish onboarding · BagThat</title>
  <meta name="color-scheme" content="light only">
  <style>
    :root{
      --ink:#0b1320;--muted:#5a6b7a;--line:#e8eef5;--bg:#f7fafc;--surface:#fff;--brand:#0b72f0;--bad:#c62828;--good:#126e3a;
      --shadow:0 18px 40px rgba(11,19,32,.08)
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:880px;margin:36px auto;padding:0 16px}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:var(--shadow)}
    h1{font-size:36px;margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 18px}
    .plan{display:inline-block;font:700 12px/1.1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#eef4ff;border:1px solid #d7e3ff;color:#0b2e6e;border-radius:999px;padding:6px 10px;margin-left:8px;vertical-align:middle}
    label{display:block;font-weight:700;margin:14px 0 6px}
    input[type=text], input[type=email]{width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:12px;font:inherit}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted)}
    .help{font-size:12px;color:var(--muted);margin-top:6px}
    .hostline{font-size:14px;margin-top:6px}
    .bad{color:var(--bad)} .good{color:var(--good)}
    .actions{margin-top:18px}
    .btn{display:inline-block;background:var(--brand);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .alert{display:none;margin-bottom:14px;padding:12px;border-radius:12px;border:1px solid #ffe0e0;background:#fff6f6;color:#7a2222}
    .done{display:none;margin-top:14px;border:1px solid #dff2e6;background:#f4fbf7;color:#0a4f30;padding:14px;border-radius:12px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Great choice! Let’s set up your site
      <span id="planBadge" class="plan" style="display:none"></span>
    </h1>
    <p class="sub">Payment succeeded (or you came here directly). Complete this one-time setup.</p>

    <div id="alert" class="alert" role="alert"></div>

    <form id="f" autocomplete="on" novalidate>
      <label for="site_display_name">Store display name</label>
      <input id="site_display_name" name="site_display_name" type="text" placeholder="Demo Deals" required>

      <div class="row">
        <div>
          <label for="email">Contact email</label>
          <input id="email" name="email" type="email" inputmode="email" placeholder="you@example.com" required>
        </div>
        <div>
          <label for="subdomain">Site URL (subdomain)</label>
          <input id="subdomain" name="subdomain" type="text" inputmode="lowercase" placeholder="yourname" required>
          <div id="hostPrev" class="hostline muted">Your site will be: —</div>
        </div>
      </div>

      <label for="amazon_tag">Amazon Associates ID</label>
      <input id="amazon_tag" name="amazon_tag" type="text" placeholder="yourtag-20">

      <div class="actions">
        <button id="go" class="btn" type="submit">Submit onboarding</button>
      </div>
    </form>

    <div id="done" class="done" role="status"></div>
  </div>
</div>

<script>
(function(){
  /* ======= CONFIG ======= */
  const DOMAIN  = "bagthatthangup.com";             // your domain
  const GAS_URL = "https://script.google.com/macros/s/AKfycbytm-ntU4HHZq4PDXpwr4qoflZUy8Hcg-7GFLT0RFUJGuKIG0Zy3lIDEYTRBt7UVqkK/exec";

  /* ======= Elements ======= */
  const $ = s => document.querySelector(s);
  const f = $("#f"), alertBox=$("#alert"), planBadge=$("#planBadge"), done=$("#done"),
        subInp=$("#subdomain"), emailInp=$("#email"), nameInp=$("#site_display_name"),
        tagInp=$("#amazon_tag"), hostPrev=$("#hostPrev"), goBtn=$("#go");

  /* ======= Utils ======= */
  function showAlert(msg){ alertBox.textContent=msg; alertBox.style.display='block'; }
  function hideAlert(){ alertBox.style.display='none'; alertBox.textContent=''; }
  function sanitizeSub(v){
    return String(v||'')
      .toLowerCase()
      .replace(/[^a-z0-9-]/g,'')
      .replace(/^-+|-+$/g,'')
      .slice(0,63);
  }
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb="cb_"+Math.random().toString(36).slice(2);
      const s=document.createElement("script");
      const cleanup=()=>{ try{ delete window[cb]; }catch(_){ } s.remove(); };
      window[cb]=data=>{ cleanup(); resolve(data); };
      s.onerror=()=>{ cleanup(); reject(new Error("network")); };
      s.src=url + (url.includes("?")?"&":"?") + "callback=" + cb;
      document.head.appendChild(s);
    });
  }

  /* ======= Plan badge handling ======= */
  const usp = new URLSearchParams(location.search);
  const plan = usp.get("plan") || "";
  const planKey = usp.get("plan_key") || "";
  if (plan || planKey) {
    planBadge.textContent = plan || "Selected";
    planBadge.style.display = "inline-block";
  }

  /* ======= Subdomain preview + availability check ======= */
  let lastCheck = 0;
  function updatePreview(){
    const sub = sanitizeSub(subInp.value);
    subInp.value = sub;
    hostPrev.textContent = sub ? `Your site will be: ${sub}.${DOMAIN}` : "Your site will be: —";

    if (!sub) return;

    const now = Date.now();
    if (now - lastCheck < 350) return; // throttle
    lastCheck = now;

    const url = `${GAS_URL}?exists=1&sub=${encodeURIComponent(sub)}&t=${now}`;
    jsonp(url).then(res=>{
      // Service returns { ok:true, exists:false } or similar
      if (!res || res.ok === false) {
        hostPrev.innerHTML = `<span class="bad">Could not verify availability. We will enforce on submit.</span>`;
        return;
      }
      if (res.exists) {
        hostPrev.innerHTML = `<span class="bad">That site URL is already taken. Try another.</span>`;
      } else {
        hostPrev.innerHTML = `<span class="good">Available!</span> ${sub}.${DOMAIN}`;
      }
    }).catch(_=>{
      hostPrev.innerHTML = `<span class="bad">Could not verify availability. We will enforce on submit.</span>`;
    });
  }
  subInp.addEventListener("input", updatePreview);
  updatePreview();

  /* ======= Submit ======= */
  function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||"").trim()); }

  f.addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideAlert();

    const site_display_name = String(nameInp.value||"").trim();
    const email            = String(emailInp.value||"").trim();
    const subdomain        = sanitizeSub(subInp.value);
    const amazon_tag       = String(tagInp.value||"").trim();

    if (!site_display_name) { showAlert("Please enter your store display name."); return; }
    if (!validEmail(email)) { showAlert("Enter a valid contact email."); return; }
    if (!subdomain)         { showAlert("Choose a subdomain."); return; }

    goBtn.disabled = true; goBtn.textContent = "Submitting…";

    try{
      // Final server-side check and write
      const params = new URLSearchParams({
        beacon:"1",
        site_display_name, email, subdomain, amazon_tag,
        plan: plan || "",
        status: "active"
      });
      const res = await jsonp(`${GAS_URL}?${params.toString()}`);
      if (!res || res.ok !== true){
        throw new Error(res && res.error ? res.error : "Save failed");
      }

      // Success → link straight to storefront
      const url = `https://${subdomain}.${DOMAIN}/tenant/`;
      f.style.display = "none";
      done.style.display = "block";
      done.innerHTML = `Submitted. Your site is ready at <a href="${url}">${url}</a>.`;
    }catch(err){
      showAlert(String(err.message || err));
    }finally{
      goBtn.disabled = false; goBtn.textContent = "Submit onboarding";
    }
  });
})();
</script>
</body>
</html>
