<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Finish Onboarding</title>
<style>
  :root{--ink:#0b1320;--muted:#5a6b7a;--line:#e8eef5;--bg:#f6f9fc;--surface:#fff;--brand:#0b72f0}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:840px;margin:36px auto;padding:20px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 26px rgba(2,24,43,.06);padding:22px}
  h1{margin:0 0 6px;font-size:28px} .sub{color:var(--muted);margin:0 0 16px}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#194bfb;font-size:12px;margin-left:8px}
  .lock{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center;margin-bottom:16px}
  .lock svg{opacity:.7}
  form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .full{grid-column:1/-1}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 110px;gap:10px} /* text + color chip */
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:700}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .ok{padding:14px;border:1px solid #bfeee8;background:#ebfbf8;border-radius:12px;margin-top:16px}
  .err{padding:12px;border:1px solid #ffd2d2;background:#fff3f3;border-radius:10px;color:#8a1f1f;margin-bottom:12px}
  .warn{font-size:12px;color:#8a1f1f;margin-top:6px}
  .hide{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Great choice! Let’s set up your site <span id="planBadge" class="badge"></span></h1>
    <p class="lock">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M7 10V7a5 5 0 0 1 10 0v3m-9 4v3m10-7H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2Z" stroke="#5a6b7a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Secure setup • You can change these later
    </p>
    <p class="sub">Payment succeeded. Complete this one-time setup.</p>

    <div id="alert" class="err hide"></div>

    <form id="f" novalidate>
      <div class="full">
        <label>Store display name</label>
        <input id="site_display_name" placeholder="Demo Deals" autocomplete="organization"/>
      </div>

      <div>
        <label>Contact email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
      </div>

      <div>
        <label>Site URL (subdomain)</label>
        <input id="subdomain" placeholder="yourbrand" autocomplete="off"/>
        <div class="hint">Your site will be: <b id="hostPrev">—</b></div>
        <div id="subWarn" class="warn hide"></div>
      </div>

      <div class="full">
        <label>Amazon Associates ID</label>
        <input id="amazon_tag" placeholder="yourtag-20" autocomplete="off"/>
      </div>

      <!-- Custom & Pro: brand colors + extra button -->
      <div id="customBlock" class="full hide">
        <div class="row">
          <div>
            <label>Primary color</label>
            <input id="color_primary_hex" placeholder="#0ea5a6" />
          </div>
          <div>
            <label>&nbsp;</label>
            <input id="color_primary" type="color" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Secondary color</label>
            <input id="color_secondary_hex" placeholder="#1e90ff" />
          </div>
          <div>
            <label>&nbsp;</label>
            <input id="color_secondary" type="color" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Extra button label (optional)</label>
            <input id="extra_btn_label" placeholder="Visit our Facebook group"/>
          </div>
          <div>
            <label>Extra button URL</label>
            <input id="extra_btn_url" placeholder="https://facebook.com/…"/>
          </div>
        </div>
      </div>

      <!-- Pro-only keeps your existing optional fields -->
      <div id="proOnly" class="full hide">
        <label>Logo URL (optional)</label>
        <input id="logo_url" placeholder="https://.../logo.png"/>
        <div class="row" style="margin-top:12px">
          <div class="full">
            <label>Featured ASINs (comma-separated)</label>
            <input id="featured_asins" placeholder="B0C123ABCD,B0D456EFGH"/>
          </div>
        </div>
      </div>

      <!-- Layout (Custom & Pro) -->
      <div class="full hide" id="layWrap">
        <label>Layout</label>
        <select id="layout"></select>
      </div>

      <div class="full">
        <button id="go" class="btn" type="submit">Submit onboarding</button>
      </div>

      <input type="hidden" id="plan"/>
      <input type="hidden" id="plan_key"/>
    </form>

    <div id="done" class="ok hide">
      <b>Submitted.</b> Your site will be available at <a id="link" href="#" target="_blank" rel="noopener"></a>.
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== CONFIG ===== */
  const DOMAIN = "bagthatthangup.com";
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbytm-ntU4HHZq4PDXpwr4qoflZUy8Hcg-7GFLT0RFUJGuKIG0Zy3lIDEYTRBt7UVqkK/exec";
  const SUBSCRIBERS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_hOlderdV0ABENcLrWMZFl8zXEqXii-3TnA55f13uVNMArQJjDw9OskRH1gLLQLIivHl5zOeH0yKb/pub?gid=0&single=true&output=csv";
  const VALID_KEYS = {
    Basic:  "btb_7vRyKQ6mP2wTg8nC4aZJd9sLq3Xe0Uh",
    Custom: "btc_R3mXn8qJ0vWk2pY5sHa4Lu9Td6Bf1Zo",
    Pro:    "btp_9hNsR3eL8kV5wC2mT1qXy4dJz7aF0Gb"
  };

  /* ===== Elements ===== */
  const q = id => document.getElementById(id);
  const alertBox = q('alert'), form = q('f'), done = q('done'), link = q('link');
  const planBadge = q('planBadge'), subWarn = q('subWarn'), hostPrev = q('hostPrev'), goBtn = q('go');
  const fields = {
    site_display_name:q('site_display_name'), email:q('email'), subdomain:q('subdomain'), amazon_tag:q('amazon_tag'),
    color_primary:q('color_primary'), color_secondary:q('color_secondary'),
    color_primary_hex:q('color_primary_hex'), color_secondary_hex:q('color_secondary_hex'),
    extra_btn_label:q('extra_btn_label'), extra_btn_url:q('extra_btn_url'),
    layout:q('layout'), logo_url:q('logo_url'), featured_asins:q('featured_asins')
  };
  const customBlock = q('customBlock');
  const proOnly = q('proOnly');
  const layWrap = q('layWrap');

  /* ===== Utils ===== */
  const sanitizeSub = s => String(s||'').toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(0,63);
  const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim());
  const normHex = v => { v=String(v||'').trim().replace(/^#/,''); return /^[0-9a-f]{6}$/i.test(v) ? '#'+v.toLowerCase() : ''; };
  function showError(msg){ alertBox.textContent = msg; alertBox.classList.remove('hide'); }
  function hideError(){ alertBox.classList.add('hide'); }
  function setBusy(b){ goBtn.disabled=b; goBtn.textContent=b?'Submitting…':'Submit onboarding'; }
  function updatePrev(){ const s = sanitizeSub(fields.subdomain.value); hostPrev.textContent = s ? `${s}.${DOMAIN}` : `yourbrand.${DOMAIN}`; }

  // keep color picker <-> hex in sync
  function syncColorPair(hexInput, colorInput, fallbackHex){
    function hexToColor(v){ const n = normHex(v); if(n){ colorInput.value = n; } }
    function colorToHex(v){ fields[hexInput.id].value = v.toLowerCase(); }
    hexInput.addEventListener('input', e=>hexToColor(e.target.value||fallbackHex));
    colorInput.addEventListener('input', e=>colorToHex(e.target.value));
    // initialize
    if (hexInput.value) hexToColor(hexInput.value);
    else if (colorInput.value) colorToHex(colorInput.value);
    else { hexInput.value = fallbackHex; colorInput.value = fallbackHex; }
  }

  /* ===== CSV duplicate check ===== */
  async function checkTakenViaCSV(sub){
    const url = SUBSCRIBERS_CSV + "&cb=" + Date.now();
    const res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw new Error('csv_fetch_failed');
    const text = await res.text();
    const rows = parseCSV(text);
    const objs = toObjects(rows);
    for (const r of objs){
      const s  = String(r.subdomain||'').trim().toLowerCase();
      const st = String(r.status||'').trim().toLowerCase();
      if (s && s===sub && st!=='canceled' && st!=='deleted') return true;
    }
    return false;
  }

  /* ===== JSONP fallback check to GAS ===== */
  function checkTakenViaJSONP(sub){
    return new Promise((resolve,reject)=>{
      const cb = 'btb_cb_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');
      const url = `${GAS_ENDPOINT}?check=1&subdomain=${encodeURIComponent(sub)}&callback=${cb}&ts=${Date.now()}`;
      const timeout = setTimeout(()=>{ cleanup(); reject(new Error('check_timeout')); }, 8000);
      function cleanup(){
        clearTimeout(timeout);
        try{ delete window[cb]; }catch(_){}
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }
      window[cb] = function(resp){
        cleanup();
        if (resp && resp.ok) return resolve(!!resp.taken || !!resp.exists);
        reject(new Error('check_failed'));
      };
      script.onerror = ()=>{ cleanup(); reject(new Error('check_network')); };
      script.src = url; document.head.appendChild(script);
    });
  }

  /* ===== CSV helpers ===== */
  function parseCSV(text){
    const rows=[]; let row=[], cell="", inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i], nx=text[i+1];
      if(inQ){ if(ch==='"'&&nx==='"'){cell+='"';i++;} else if(ch==='"'){inQ=false;} else{cell+=ch;} }
      else { if(ch==='"'){inQ=true;} else if(ch===','){row.push(cell);cell="";}
             else if(ch==='\r'&&nx==='\n'){row.push(cell);rows.push(row);row=[];cell="";i++;}
             else if(ch==='\n'){row.push(cell);rows.push(row);row=[];cell="";} else{cell+=ch;} }
    }
    if(cell!==""||row.length){row.push(cell);rows.push(row);}
    return rows.filter(r=>r.length>1);
  }
  function toObjects(rows){
    if(!rows.length) return [];
    const headers = rows[0].map(h=>String(h||"").trim());
    const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));
    return rows.slice(1).map((r,ix)=>{
      const o={ _ix: ix };
      for(const [h,i] of Object.entries(idx)) o[h]=(r[i]||"").toString().trim();
      return o;
    });
  }

  /* ===== Plan & UI setup (NO plan switching here) ===== */
  const params = new URLSearchParams(location.search);
  const plan = params.get('plan') || '';
  const plan_key = params.get('plan_key') || '';
  const planNames = { Basic:'Basic', Custom:'Custom', Pro:'Pro' };

  // Require a valid plan+key pair
  (function enforcePlan(){
    let ok=false;
    for (const p of Object.keys(VALID_KEYS)) {
      if (p===plan && VALID_KEYS[p]===plan_key) { ok=true; break; }
    }
    if (!ok) {
      document.getElementById('f').classList.add('hide');
      showError("Invalid or missing plan link. Please return to checkout.");
      return;
    }
    planBadge.textContent = `Selected plan: ${planNames[plan]||plan}`;
    q('plan').value = plan;
    q('plan_key').value = plan_key;

    // Show/hide sections
    const isCustomOrPro = (plan==='Custom' || plan==='Pro');
    const isPro = (plan==='Pro');
    customBlock.classList.toggle('hide', !isCustomOrPro);
    proOnly.classList.toggle('hide', !isPro);
    layWrap.classList.toggle('hide', !isCustomOrPro);

    // Layout choices
    fields.layout.innerHTML = "";
    if (plan==='Custom') ["list","grid"].forEach(x=>fields.layout.add(new Option(x,x)));
    if (plan==='Pro')    ["list","grid","spotlight","magazine"].forEach(x=>fields.layout.add(new Option(x,x)));
  })();

  // Initialize color sync
  syncColorPair(fields.color_primary_hex, fields.color_primary, "#0ea5a6");
  syncColorPair(fields.color_secondary_hex, fields.color_secondary, "#1e90ff");

  /* Live preview + live duplicate check */
  updatePrev();
  let debounceTimer=null;
  fields.subdomain.addEventListener('input', ()=>{
    updatePrev();
    subWarn.classList.add('hide'); subWarn.textContent='';
    const s = sanitizeSub(fields.subdomain.value);
    if (!s || s.length < 3) return;
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async ()=>{
      try{
        const taken = await checkTakenViaCSV(s);
        if (taken){ subWarn.textContent="That site URL is already taken. Try another."; subWarn.classList.remove('hide'); return; }
        try{
          const taken2 = await checkTakenViaJSONP(s);
          if (taken2){ subWarn.textContent="That site URL is already taken. Try another."; subWarn.classList.remove('hide'); }
        }catch(_){}
      }catch(_){
        try{
          const taken = await checkTakenViaJSONP(s);
          if (taken){ subWarn.textContent="That site URL is already taken. Try another."; subWarn.classList.remove('hide'); }
        }catch(_){}
      }
    }, 350);
  });

  /* ===== Submit ===== */
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault(); hideError(); setBusy(true);

    const site_display_name = fields.site_display_name.value.trim();
    const email = fields.email.value.trim();
    const sub = sanitizeSub(fields.subdomain.value);
    const amazon_tag = fields.amazon_tag.value.trim();

    const color_primary = normHex(fields.color_primary_hex?.value||'');
    const color_secondary = normHex(fields.color_secondary_hex?.value||'');
    const layout = (fields.layout?.value||'') || (plan==='Basic' ? 'list' : '');
    const logo_url = (fields.logo_url?.value||'').trim();
    const featured_asins = (fields.featured_asins?.value||'').trim();
    const extra_btn_label = (fields.extra_btn_label?.value||'').trim();
    const extra_btn_url = (fields.extra_btn_url?.value||'').trim();

    if (!site_display_name){ setBusy(false); return showError("Enter a site name."); }
    if (!isEmail(email))   { setBusy(false); return showError("Enter a valid email."); }
    if (!sub || sub.length<3){ setBusy(false); return showError("Enter a valid site URL (3+ chars)."); }
    if (!amazon_tag)       { setBusy(false); return showError("Enter your Amazon Associates ID."); }

    // Ensure plan-gated fields are respected (Basic ignores custom fields)
    if (plan==='Basic'){
      fields.color_primary_hex.value = fields.color_secondary_hex.value = '';
      fields.extra_btn_label.value = fields.extra_btn_url.value = '';
    }

    // Availability check: CSV → JSONP
    try{
      const takenCSV = await checkTakenViaCSV(sub);
      if (takenCSV){ setBusy(false); subWarn.textContent="That site URL is already taken. Try another."; subWarn.classList.remove('hide'); return showError("That site URL is already taken."); }
      try{
        const takenJSONP = await checkTakenViaJSONP(sub);
        if (takenJSONP){ setBusy(false); subWarn.textContent="That site URL is already taken. Try another."; subWarn.classList.remove('hide'); return showError("That site URL is already taken."); }
      }catch(_){}
    }catch(_){
      // warn but continue; server will still enforce duplicate on write
      showError("Could not verify site URL in real time. We’ll attempt to create your site.");
    }

    // Write row via GET beacon (no CORS)
    try{
      const qs = new URLSearchParams({
        beacon: '1',
        timestamp: new Date().toISOString(),
        tenant_id: '',
        email, site_display_name, subdomain: sub, plan,
        amazon_tag, color_primary, color_secondary, logo_url,
        layout, featured_asins,
        extra_btn_label, extra_btn_url,
        extra_page_enabled: 'false',
        status: 'active'
      });
      await fetch(`${GAS_ENDPOINT}?${qs.toString()}`, { method: 'GET', mode: 'no-cors' });

      form.classList.add('hide'); done.classList.remove('hide');
      const url = `https://${sub}.${DOMAIN}`; link.href=url; link.textContent=url;
    }catch(e){
      showError("Network error submitting your setup. Please try again.");
    }finally{
      setBusy(false);
    }
  });
})();
</script>
</body>
</html>
