<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finish Onboarding</title>
<style>
  :root{--ink:#0b1320;--muted:#5a6b7a;--line:#e8eef5;--bg:#f6f9fc;--surface:#fff;--brand:#0b72f0}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:860px;margin:36px auto;padding:20px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 26px rgba(2,24,43,.06);padding:24px}
  h1{margin:0 0 8px;font-size:28px}
  .sub{color:var(--muted);margin:0 0 16px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#194bfb;font-size:12px;margin-left:8px}
  form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .full{grid-column:1/-1}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:700}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .ok{padding:14px;border:1px solid #bfeee8;background:#ebfbf8;border-radius:12px;margin-top:16px}
  .err{padding:12px;border:1px solid #ffd2d2;background:#fff3f3;border-radius:10px;color:#8a1f1f;margin-bottom:12px}
  .warn{font-size:12px;color:#8a1f1f;margin-top:6px}
  .hide{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Great choice! Let’s set up your site <span id="planBadge" class="badge"></span></h1>
    <p class="sub">Payment succeeded (or you came here directly). Complete this one-time setup.</p>

    <div id="alert" class="err hide"></div>

    <form id="f" novalidate>
      <div class="full">
        <label>Store display name</label>
        <input id="site_display_name" placeholder="Demo Deals" autocomplete="organization"/>
      </div>

      <div>
        <label>Contact email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
      </div>

      <div>
        <label>Site URL (subdomain)</label>
        <input id="subdomain" placeholder="yourbrand" autocomplete="off"/>
        <div class="hint">Your site will be: <b id="hostPrev">—</b></div>
        <div id="subWarn" class="warn hide"></div>
      </div>

      <div class="full">
        <label>Amazon Associates ID</label>
        <input id="amazon_tag" placeholder="yourtag-20" autocomplete="off"/>
      </div>

      <!-- Custom/Pro -->
      <div id="p1" class="hide">
        <label>Primary color (hex)</label>
        <input id="color_primary" placeholder="#0ea5a6"/>
      </div>
      <div id="p2" class="hide">
        <label>Secondary color (hex)</label>
        <input id="color_secondary" placeholder="#1e90ff"/>
      </div>
      <div class="full hide" id="layWrap">
        <label>Layout</label>
        <select id="layout"></select>
      </div>

      <!-- Pro-only -->
      <div class="full hide" id="proLogo">
        <label>Logo URL (optional)</label>
        <input id="logo_url" placeholder="https://.../logo.png"/>
      </div>
      <div class="full hide" id="proFeat">
        <label>Featured ASINs (comma-separated)</label>
        <input id="featured_asins" placeholder="B0C123ABCD,B0D456EFGH"/>
      </div>

      <div class="full">
        <button id="go" class="btn" type="submit">Submit onboarding</button>
      </div>
    </form>

    <div id="done" class="ok hide">
      <b>Submitted.</b> Your site will be available at
      <a id="link" href="#" target="_blank" rel="noopener"></a>.
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== CONFIG ===== */
  const DOMAIN = "bagthatthangup.com";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzGCoO7gT7Uwf25T1ODHKTgTfTBXqIfVBh9EFmR66QohwsA9TOzH1J27SnhJrRSJX04/exec";

  /* ===== Elements ===== */
  const $ = id => document.getElementById(id);
  const alertBox = $('alert'), form = $('f'), done = $('done'), link = $('link');
  const planBadge = $('planBadge'), subWarn = $('subWarn'), hostPrev = $('hostPrev'), goBtn = $('go');
  const fields = {
    site_display_name:$('site_display_name'), email:$('email'), subdomain:$('subdomain'), amazon_tag:$('amazon_tag'),
    color_primary:$('color_primary'), color_secondary:$('color_secondary'), layout:$('layout'),
    logo_url:$('logo_url'), featured_asins:$('featured_asins')
  };
  const p1=$('p1'), p2=$('p2'), layWrap=$('layWrap'), proLogo=$('proLogo'), proFeat=$('proFeat');

  /* ===== Utils ===== */
  const sanitizeSub = s => String(s||'').toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(0,63);
  const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim());
  const normHex = v => { v=String(v||'').trim().replace(/^#/,''); return /^[0-9a-f]{6}$/i.test(v) ? '#'+v : ''; };
  function showError(msg){ alertBox.textContent = msg; alertBox.classList.remove('hide'); }
  function hideError(){ alertBox.classList.add('hide'); }
  function setBusy(b){ goBtn.disabled=b; goBtn.textContent=b?'Submitting…':'Submit onboarding'; }
  function updatePrev(){
    const sub = sanitizeSub(fields.subdomain.value);
    hostPrev.textContent = sub ? `${sub}.${DOMAIN}` : '—';
  }

  // Simple JSONP helper with timeout & cleanup
  function jsonp(url, params={}, timeoutMs=6000){
    return new Promise((resolve,reject)=>{
      const cbName = `__jp_${Date.now()}_${Math.random().toString(36).slice(2)}`;
      params.callback = cbName;
      const qs = Object.entries(params).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
      const src = url + (url.includes('?')?'&':'?') + qs;
      const s = document.createElement('script');
      let done = false;
      window[cbName] = (data)=>{ done=true; cleanup(); resolve(data); };
      const to = setTimeout(()=>{ if(!done){ cleanup(); reject(new Error('timeout')); }}, timeoutMs);
      function cleanup(){ delete window[cbName]; s.remove(); clearTimeout(to); }
      s.onerror = ()=>{ if(!done){ cleanup(); reject(new Error('script_error')); } };
      s.src = src;
      document.head.appendChild(s);
    });
  }

  /* ===== Query params & plan badge ===== */
  const usp = new URLSearchParams(location.search);
  const plan = usp.get('plan') || '';          // display only
  const planKey = usp.get('plan_key') || '';   // opaque proof from checkout (if present)
  if (plan) planBadge.textContent = plan; else planBadge.classList.add('hide');

  function configureByPlan(){
    const tier = (plan || '').toLowerCase();
    const isPro = tier === 'pro';
    const isCustom = tier === 'custom';

    [p1,p2,layWrap].forEach(el => el.classList.toggle('hide', !(isCustom || isPro)));
    [proLogo,proFeat].forEach(el => el.classList.toggle('hide', !isPro));

    if (!layWrap.classList.contains('hide')) {
      fields.layout.innerHTML = `
        <option value="grid">Grid</option>
        <option value="masonry">Masonry</option>
        <option value="rows">Rows</option>
      `;
    }
  }
  configureByPlan();

  /* ===== Live preview & availability (soft) ===== */
  fields.subdomain.addEventListener('input', () => {
    fields.subdomain.value = sanitizeSub(fields.subdomain.value);
    updatePrev();
    softCheck();
  });
  updatePrev();

  // Try to verify subdomain via JSONP, but DON'T block if it fails
  let lastChecked = '';
  async function softCheck(){
    const sub = sanitizeSub(fields.subdomain.value);
    if (!sub || sub === lastChecked) return;
    lastChecked = sub;

    subWarn.classList.add('hide'); subWarn.textContent = '';

    try {
      // Try either "exists" or "check"—support both shapes of the GAS you’ve used.
      const p = { subdomain: sub, t: Date.now() };
      let res = await jsonp(GAS_URL, { exists: 1, ...p }, 4500).catch(()=>null);
      if (!res) res = await jsonp(GAS_URL, { check: 1, ...p }, 4500).catch(()=>null);

      if (res && res.ok === true && res.taken === true) {
        subWarn.textContent = 'That subdomain is already taken. Please choose another.';
        subWarn.classList.remove('hide');
      } else if (!res || res.ok === false) {
        subWarn.textContent = 'Could not verify availability (network or endpoint issue). You can still submit; we will enforce on submit.';
        subWarn.classList.remove('hide');
      } // else ok & not taken => do nothing
    } catch(_) {
      subWarn.textContent = 'Could not verify availability (network or endpoint issue). You can still submit; we will enforce on submit.';
      subWarn.classList.remove('hide');
    }
  }

  /* ===== Submit ===== */
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault(); hideError();

    // Basic validation
    const sub = sanitizeSub(fields.subdomain.value);
    if (!isEmail(fields.email.value)) return showError('Please enter a valid email.');
    if (!sub) return showError('Please enter a subdomain.');

    // Enforce uniqueness right before writing (still JSONP, but we’ll block if clearly taken)
    try {
      const existsRes = await jsonp(GAS_URL, { exists: 1, subdomain: sub, t: Date.now() }, 6000).catch(()=>null);
      if (existsRes && existsRes.ok && existsRes.taken) {
        subWarn.textContent = 'That subdomain is already taken. Please choose another.';
        subWarn.classList.remove('hide');
        return;
      }
    } catch(_) {
      // If the check fails, we allow continue—server write is the final source of truth in your sheet.
    }

    setBusy(true);

    // Build payload for sheet
    const payload = {
      beacon: 1,
      email: fields.email.value.trim(),
      site_display_name: fields.site_display_name.value.trim(),
      subdomain: sub,
      plan: plan || '',            // display plan
      plan_key: planKey || '',     // optional opaque key
      amazon_tag: fields.amazon_tag.value.trim(),
      color_primary: normHex(fields.color_primary.value),
      color_secondary: normHex(fields.color_secondary.value),
      logo_url: fields.logo_url.value.trim(),
      layout: fields.layout.value || '',
      featured_asins: fields.featured_asins.value.trim(),
      extra_page_enabled: 'false',
      status: 'active',
      t: Date.now()
    };

    try {
      const res = await jsonp(GAS_URL, payload, 8000);
      if (!res || res.ok !== true) {
        throw new Error(res && res.error ? res.error : 'Write failed');
      }

      // Success UI
      const host = `${sub}.${DOMAIN}`;
      link.href = `https://${host}`;
      link.textContent = host;
      done.classList.remove('hide');
      form.classList.add('hide');

    } catch (err) {
      showError('We could not save your onboarding. Please try again. ' + String(err && err.message || ''));
    } finally {
      setBusy(false);
    }
  });
})();
</script>
</body>
</html>
