<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Finish Onboarding · BagThat</title>
  <meta name="color-scheme" content="light only">
  <style>
    :root{
      --ink:#0b1320; --muted:#5a6b7a; --line:#e8eef5; --bg:#f7fafc; --surface:#fff; --brand:#0b72f0;
      --ok:#0f915a; --bad:#c62828; --shadow:0 18px 40px rgba(11,19,32,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:36px auto;padding:0 16px}
    h1{font-size:32px;margin:0 0 6px}
    .sub{color:var(--muted);margin:0 0 20px}

    .panel{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:800px){ .row{grid-template-columns:1fr} }
    label{display:block;font-weight:700;margin:0 0 6px}
    input[type=text],input[type=email]{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px}
    .help{color:var(--muted);font-size:12px;margin-top:6px}
    .pill{display:inline-block;background:#eef4ff;border:1px solid #d9e7ff;padding:6px 10px;border-radius:999px;font-weight:800;margin-right:8px}
    .err{color:var(--bad);background:#fff6f6;border:1px solid #ffdede;border-radius:10px;padding:10px;margin:12px 0;display:none}
    .ok{color:#0b3d2b;background:#edf9f3;border:1px solid #caeedc;border-radius:10px;padding:10px;margin:12px 0;display:none}

    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.green{background:var(--ok);color:#fff}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .upload{display:grid;grid-template-columns:96px 1fr;gap:14px;align-items:center}
    .avatar{width:96px;height:96px;border-radius:12px;border:1px solid var(--line);background:#fff;object-fit:cover;display:block}
    .color-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-grid;grid-template-columns:28px 1fr;gap:8px;align-items:center;
          border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff}
    .chip input[type=color]{appearance:none;width:22px;height:22px;border:1px solid #c7d3df;border-radius:999px;padding:0}
    .chip input[type=text]{width:110px;border:0;padding:0;font-weight:700}

    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Let’s set up your site</h1>
    <p class="sub">Payment succeeded (or you came here directly). Complete this quick one-time setup.</p>

    <div class="panel">
      <span class="pill" id="planPill">Plan: —</span>
      <span class="pill" id="keyPill" title="Opaque verification key">Key: —</span>
    </div>

    <form id="form" class="panel" novalidate>
      <div id="err" class="err"></div>
      <div id="ok" class="ok"></div>

      <!-- BASIC FIELDS (for all plans) -->
      <div class="row">
        <div>
          <label for="store_name">Store display name</label>
          <input id="store_name" name="store_name" type="text" placeholder="e.g., Daisy’s Deals" required>
        </div>
        <div>
          <label for="email">Contact email</label>
          <input id="email" name="email" type="email" placeholder="you@example.com" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="subdomain">Site URL (subdomain)</label>
          <input id="subdomain" name="subdomain" type="text" placeholder="lowercase-letters-or-hyphen" pattern="[a-z0-9-]+" required>
          <div id="subHelp" class="help">Your site will be: <b id="previewHost">—</b></div>
        </div>
        <div>
          <label for="amazon_id">Amazon Associates ID</label>
          <input id="amazon_id" name="amazon_id" type="text" placeholder="myaffiliate-20">
          <div class="help">Optional — you can add/update it later.</div>
        </div>
      </div>

      <!-- CUSTOM/PRO FIELDS (shown only for Custom & Pro) -->
      <div id="customBlock" class="panel" style="margin:-8px -8px 16px -8px">
        <h3 style="margin:0 0 8px">Branding (Custom & Pro)</h3>

        <!-- Logo upload -->
        <div class="upload" style="margin-bottom:12px">
          <img id="logoPreview" class="avatar" alt="Logo preview" src="" onerror="this.src='';this.style.background='#fff'">
          <div>
            <label for="logo_file">Logo / avatar</label>
            <input id="logo_file" type="file" accept="image/*">
            <div class="help">PNG/JPG, ≤ 1MB recommended. We’ll resize to ~256×256 for you.</div>
            <!-- These two are what get submitted -->
            <input type="hidden" id="logo_data_url" name="brand_logo_data_url" value="">
            <input type="hidden" id="logo_mime" name="brand_logo_mime" value="">
          </div>
        </div>

        <!-- Two colors -->
        <label>Brand colors</label>
        <div class="color-row" style="margin-bottom:12px">
          <span class="chip">
            <input id="c1" type="color" value="#0ea5a6">
            <input id="c1hex" type="text" value="#0ea5a6" name="brand_color_primary">
          </span>
          <span class="chip">
            <input id="c2" type="color" value="#1e90ff">
            <input id="c2hex" type="text" value="#1e90ff" name="brand_color_accent">
          </span>
        </div>

        <!-- Extra link -->
        <div class="row">
          <div>
            <label for="extra_link_label">Extra button label</label>
            <input id="extra_link_label" name="extra_link_label" type="text" placeholder="e.g., My Amazon Storefront">
          </div>
          <div>
            <label for="extra_link_url">Extra button URL</label>
            <input id="extra_link_url" name="extra_link_url" type="text" placeholder="https://amazon.com/shop/yourhandle">
          </div>
        </div>
      </div>
      <!-- /CUSTOM/PRO FIELDS -->

      <div class="actions">
        <button id="submit" class="btn green" type="submit">Submit onboarding</button>
      </div>

      <!-- carried through as submitted fields -->
      <input type="hidden" id="plan" name="plan" value="">
      <input type="hidden" id="plan_key" name="plan_key" value="">
    </form>

    <div id="after" class="panel hidden">
      <h3>Submitted.</h3>
      <p>Your site link will look like <a id="siteLink" href="#" target="_blank" rel="noopener">https://example.bagthatthangup.com</a>.</p>
    </div>
  </div>

  <script>
  (function(){
    const DOMAIN = "bagthatthangup.com";
    const qs = new URLSearchParams(location.search);
    const plan = (qs.get("plan")||"").trim();
    const planKey = (qs.get("plan_key")||"").trim();

    // Fill pills + hidden fields
    document.getElementById("planPill").textContent = "Plan: " + (plan||"—");
    document.getElementById("keyPill").textContent  = planKey ? "Key: ✓" : "Key: —";
    document.getElementById("plan").value = plan;
    document.getElementById("plan_key").value = planKey;

    // Show/hide the custom block
    const customBlock = document.getElementById("customBlock");
    if (plan === "Custom" || plan === "Pro") {
      customBlock.style.display = "";
    } else {
      customBlock.style.display = "none";
    }

    // Subdomain preview
    const subEl = document.getElementById("subdomain");
    const previewHost = document.getElementById("previewHost");
    function updatePreview(){
      const sub = (subEl.value||"").toLowerCase().replace(/[^a-z0-9-]/g,"");
      previewHost.textContent = sub ? (sub + "." + DOMAIN) : "—";
    }
    subEl.addEventListener("input", updatePreview);
    updatePreview();

    // Color pickers keep hex inputs in sync
    const c1 = document.getElementById("c1"), c1hex = document.getElementById("c1hex");
    const c2 = document.getElementById("c2"), c2hex = document.getElementById("c2hex");
    if (c1 && c1hex){
      c1.addEventListener("input", ()=> c1hex.value = c1.value);
      c1hex.addEventListener("input", ()=> { if(/^#?[0-9a-fA-F]{6}$/.test(c1hex.value.replace('#',''))) c1.value = c1hex.value.startsWith('#')?c1hex.value:"#"+c1hex.value;});
      c2.addEventListener("input", ()=> c2hex.value = c2.value);
      c2hex.addEventListener("input", ()=> { if(/^#?[0-9a-fA-F]{6}$/.test(c2hex.value.replace('#',''))) c2.value = c2hex.value.startsWith('#')?c2hex.value:"#"+c2hex.value;});
    }

    // Logo upload → preview + base64 hidden field (small + safe)
    const fileEl = document.getElementById("logo_file");
    const prevEl = document.getElementById("logoPreview");
    const dataEl = document.getElementById("logo_data_url");
    const mimeEl = document.getElementById("logo_mime");

    if (fileEl){
      fileEl.addEventListener("change", async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        if(!/^image\//.test(f.type)){ showErr("Please choose a PNG or JPG image."); fileEl.value = ""; return; }
        if(f.size > 2*1024*1024){ showErr("Image is larger than 2MB. Please pick a smaller file."); fileEl.value = ""; return; }

        try{
          const buf = await f.arrayBuffer();
          const img = new Image();
          img.onload = ()=>{
            // resize to ~256×256 max (keep aspect)
            const MAX = 256;
            let w = img.width, h = img.height;
            if (w>MAX || h>MAX){
              const r = Math.min(MAX/w, MAX/h);
              w = Math.round(w*r); h = Math.round(h*r);
            }
            const c = document.createElement("canvas");
            c.width = w; c.height = h;
            const cx = c.getContext("2d");
            cx.fillStyle = "#ffffff"; cx.fillRect(0,0,w,h); // white bg for JPGs
            cx.drawImage(img,0,0,w,h);
            // Prefer PNG for crisp logos
            const data = c.toDataURL("image/png");
            dataEl.value = data;
            mimeEl.value = "image/png";
            prevEl.src = data;
          };
          img.onerror = ()=> showErr("Could not read image.");
          img.src = URL.createObjectURL(new Blob([buf], {type: f.type}));
        }catch(err){
          showErr("Image processing error.");
        }
      });
    }

    // Submit → we keep your current endpoint logic by submitting everything as standard fields.
    const form = document.getElementById("form");
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideMsg();
      // Minimal client validation we control here
      if(!subEl.value){ return showErr("Please enter a site URL (subdomain)."); }
      if(!document.getElementById("store_name").value){ return showErr("Please enter a store display name."); }
      if(!document.getElementById("email").value){ return showErr("Please enter a contact email."); }

      // Build FormData and POST to the same target your existing flow expects:
      // We post back to *this* page so your existing serverless handler (if any)
      // or static capture can continue to work. If your current form already had
      // an action attribute, you can add it here. For now we'll post to location.href.
      const fd = new FormData(form);

      // Try to submit to any existing receiver on the page origin (update this if you already have an endpoint)
      // If you already wired an endpoint, replace `submitTarget` with it. Otherwise this falls back to normal navigation.
      const submitTarget = (form.getAttribute("action") || "/onboarding/submit");

      try{
        const res = await fetch(submitTarget, { method:"POST", body: fd });
        // If your existing backend responds with JSON containing { ok:true, site:"subdomain" }
        // we’ll use it; otherwise we show a generic success note and rely on your current redirect.
        if(res.ok){
          let site = "";
          try { const j = await res.json(); if (j && j.site) site = j.site; } catch(_){}
          document.getElementById("after").classList.remove("hidden");
          document.getElementById("siteLink").textContent = (site ? `https://${site}.${DOMAIN}` : `https://${(subEl.value||"—")}.${DOMAIN}`);
          document.getElementById("siteLink").href = (site ? `https://${site}.${DOMAIN}` : `https://${(subEl.value||"")}.${DOMAIN}`);
          showOk("Submitted. We’ll create your site and email the link.");
        }else{
          showErr("Network error while submitting. Please try again.");
        }
      }catch(err){
        showErr("Network error while submitting.");
      }
    });

    function showErr(msg){ const el = document.getElementById("err"); el.textContent = msg; el.style.display="block"; }
    function showOk(msg){ const el = document.getElementById("ok"); el.textContent = msg; el.style.display="block"; }
    function hideMsg(){ document.getElementById("err").style.display="none"; document.getElementById("ok").style.display="none"; }
  })();
  </script>
</body>
</html>
