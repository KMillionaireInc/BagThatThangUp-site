<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finish Onboarding</title>
  <style>
    :root{--ink:#0b1320;--muted:#5a6b7a;--line:#e8eef5;--bg:#f6f9fc;--surface:#fff;--brand:#0b72f0}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:820px;margin:36px auto;padding:20px}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 26px rgba(2,24,43,.06);padding:22px}
    h1{margin:0 0 6px;font-size:28px}
    .sub{color:var(--muted);margin:0 0 16px}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#194bfb;font-size:12px;margin-left:8px}
    form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .full{grid-column:1/-1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:700}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ok{padding:14px;border:1px solid #bfeee8;background:#ebfbf8;border-radius:12px;margin-top:16px}
    .err{padding:12px;border:1px solid #ffd2d2;background:#fff3f3;border-radius:10px;color:#8a1f1f;margin-bottom:12px}
    .warn{font-size:12px;color:#8a1f1f;margin-top:6px}
    .hide{display:none!important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Great choice! Let’s set up your site <span id="planBadge" class="badge"></span></h1>
      <p class="sub">Payment succeeded (or you came here directly). Complete this one-time setup.</p>

      <div id="alert" class="err hide"></div>

      <form id="f" novalidate>
        <div class="full">
          <label>Store display name</label>
          <input id="site_display_name" placeholder="Demo Deals" autocomplete="organization" />
        </div>

        <div>
          <label>Contact email</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
        </div>

        <div>
          <label>Site URL (subdomain)</label>
          <input id="subdomain" placeholder="yourbrand" autocomplete="off" />
          <div class="hint">Your site will be: <b id="hostPrev">—</b></div>
          <div id="subWarn" class="warn hide"></div>
        </div>

        <div class="full">
          <label>Amazon Associates ID</label>
          <input id="amazon_tag" placeholder="yourtag-20" autocomplete="off" />
        </div>

        <!-- Custom/Pro -->
        <div id="p1" class="hide">
          <label>Primary color (hex)</label>
          <input id="color_primary" placeholder="#0ea5a6" />
        </div>
        <div id="p2" class="hide">
          <label>Secondary color (hex)</label>
          <input id="color_secondary" placeholder="#1e90ff" />
        </div>
        <div class="full hide" id="layWrap">
          <label>Layout</label>
          <select id="layout"></select>
        </div>

        <!-- Pro-only -->
        <div class="full hide" id="proLogo">
          <label>Logo URL (optional)</label>
          <input id="logo_url" placeholder="https://.../logo.png" />
        </div>
        <div class="full hide" id="proFeat">
          <label>Featured ASINs (comma-separated)</label>
          <input id="featured_asins" placeholder="B0C123ABCD,B0D456EFGH" />
        </div>

        <div class="full">
          <button id="go" class="btn" type="submit">Submit onboarding</button>
        </div>
      </form>

      <div id="done" class="ok hide">
        <b>Submitted.</b> Your site will be available at
        <a id="successLink" href="#" target="_blank" rel="noopener"></a>.
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ---- CONFIG ---- */
    const DOMAIN = "bagthatthangup.com";
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzGCoO7gT7Uwf25T1ODHKTgTfTBXqIfVBh9EFmR66QohwsA9TOzH1J27SnhJrRSJX04/exec";

    /* ---- Elements ---- */
    const $ = id => document.getElementById(id);
    const alertBox = $('alert'), form = $('f'), done = $('done'), successLink = $('successLink');
    const planBadge = $('planBadge'), subWarn = $('subWarn'), hostPrev = $('hostPrev'), goBtn = $('go');
    const fields = {
      site_display_name:$('site_display_name'), email:$('email'), subdomain:$('subdomain'), amazon_tag:$('amazon_tag'),
      color_primary:$('color_primary'), color_secondary:$('color_secondary'), layout:$('layout'),
      logo_url:$('logo_url'), featured_asins:$('featured_asins')
    };
    const p1=$('p1'), p2=$('p2'), layWrap=$('layWrap'), proLogo=$('proLogo'), proFeat=$('proFeat');

    /* ---- Utils ---- */
    const sanitizeSub = s => String(s||'').toLowerCase()
      .replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(0,63);
    const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim());
    const normHex = v => {
      v = String(v||'').trim().replace(/^#/, '');
      return /^[0-9a-f]{6}$/i.test(v) ? '#'+v : '';
    };
    const showError = msg => { alertBox.textContent = msg; alertBox.classList.remove('hide'); };
    const hideError = () => alertBox.classList.add('hide');
    const setBusy = b => { goBtn.disabled=b; goBtn.textContent=b?'Submitting…':'Submit onboarding'; };

    function setPlanBadge(txt) {
      planBadge.textContent = txt;
      planBadge.classList.remove('hide');
    }

    function jsonp(url, params, cb) {
      const id = 'cb_' + Math.random().toString(36).slice(2);
      params = params || {};
      params.callback = id;
      const qs = Object.entries(params).map(([k,v]) => (
        encodeURIComponent(k)+'='+encodeURIComponent(v)
      )).join('&');
      const s = document.createElement('script');
      s.src = url + (url.includes('?')?'&':'?') + qs;
      s.onerror = () => { delete window[id]; s.remove(); cb && cb({ ok:false, error:'network' }); };
      window[id] = (data) => { try { cb && cb(data); } finally { delete window[id]; s.remove(); } };
      document.body.appendChild(s);
    }

    /* ---- Parse plan ---- */
    const usp = new URLSearchParams(location.search);
    const planKey = usp.get('plan_key') || '';
    const urlPlan = usp.get('plan') || '';
    const keyMap = {
      "btb_7vRyKQ6mP2wTg8nC4aZJd9sLq3Xe0Uh":"Basic",
      "btc_9sLg3Xe0UhpY":"Custom",
      "btp_k9QnL2dAk71":"Pro"
    };
    const plan = urlPlan || keyMap[planKey] || '';

    function configureByPlan() {
      const tier = (plan || '').toLowerCase();
      const isPro = tier === 'pro';
      const isCustom = tier === 'custom';

      [p1,p2,layWrap].forEach(el => el.classList.toggle('hide', !(isCustom || isPro)));
      [proLogo,proFeat].forEach(el => el.classList.toggle('hide', !isPro));

      if (!layWrap.classList.contains('ready')) {
        fields.layout.innerHTML = `
          <option value="grid">Grid</option>
          <option value="masonry">Masonry</option>
          <option value="rows">Rows</option>`;
        layWrap.classList.add('ready');
      }

      if (plan) setPlanBadge(plan);
    }

    /* ---- Live preview host ---- */
    function updateHostPreview() {
      const sub = sanitizeSub(fields.subdomain.value);
      hostPrev.textContent = sub ? `${sub}.${DOMAIN}` : '—';
    }

    /* ---- Availability check (debounced) ---- */
    let availTimer = null;
    function queueAvailCheck() {
      clearTimeout(availTimer);
      const sub = sanitizeSub(fields.subdomain.value);
      if (!sub) { subWarn.classList.add('hide'); return; }
      availTimer = setTimeout(() => {
        jsonp(GAS_ENDPOINT, { check:1, subdomain:sub }, res => {
          if (res && res.ok) {
            if (res.taken) {
              subWarn.textContent = 'That subdomain is already taken.';
              subWarn.classList.remove('hide');
            } else {
              subWarn.classList.add('hide');
            }
          } else {
            subWarn.textContent = 'Could not verify availability. Try again.';
            subWarn.classList.remove('hide');
          }
        });
      }, 450);
    }

    /* ---- Submit handler ---- */
    form.addEventListener('submit', e => {
      e.preventDefault();
      hideError();

      const sub = sanitizeSub(fields.subdomain.value);
      if (!sub) return showError('Please enter a valid subdomain (letters, numbers, hyphens).');

      if (!isEmail(fields.email.value)) return showError('Please enter a valid email.');

      const payload = {
        site_display_name: fields.site_display_name.value.trim(),
        email: fields.email.value.trim(),
        subdomain: sub,
        plan: plan || 'Basic',
        amazon_tag: fields.amazon_tag.value.trim(),
        color_primary: normHex(fields.color_primary.value),
        color_secondary: normHex(fields.color_secondary.value),
        logo_url: fields.logo_url.value.trim(),
        layout: fields.layout.value || '',
        featured_asins: fields.featured_asins.value.trim(),
        extra_page_enabled: 'false',
        status: 'active'
      };

      setBusy(true);
      jsonp(GAS_ENDPOINT, Object.assign({ beacon:1 }, payload), res => {
        setBusy(false);
        if (!res || !res.ok) {
          return showError('Could not save your info. Please try again.');
        }
        form.classList.add('hide');
        const host = `${sub}.${DOMAIN}`;
        successLink.textContent = host;
        successLink.href = 'https://' + host;
        done.classList.remove('hide');

        // Optional auto-redirect to your tenant page:
        // setTimeout(() => location.assign('/tenant?host=' + encodeURIComponent(host)), 800);
      });
    });

    /* ---- Wire up inputs ---- */
    fields.subdomain.addEventListener('input', () => { updateHostPreview(); queueAvailCheck(); });
    ['email','site_display_name','amazon_tag','color_primary','color_secondary','logo_url','featured_asins']
      .forEach(k => fields[k].addEventListener('input', hideError));

    // Initial state
    configureByPlan();
    updateHostPreview();
  });
  </script>
</body>
</html>
