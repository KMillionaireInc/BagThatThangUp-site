<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Finish Onboarding</title>
<meta name="color-scheme" content="light only" />
<style>
  :root{
    --ink:#0b1320; --muted:#5a6b7a; --line:#e8eef5; --bg:#f6f9fc; --surface:#fff; --brand:#0b72f0;
    --ok-bg:#ebfbf8; --ok-border:#bfeee8; --err-bg:#fff3f3; --err-border:#ffd2d2;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:860px;margin:40px auto;padding:20px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 26px rgba(2,24,43,.06);padding:22px}
  h1{margin:0 0 6px;font-size:30px}
  .sub{color:var(--muted);margin:0 0 18px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#194bfb;font-size:12px;margin-left:8px}
  form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .full{grid-column:1/-1}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  input:focus,select:focus{outline:2px solid #d8e6ff;border-color:#bcd3ff}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:800}
  .btn:disabled{opacity:.65;cursor:not-allowed}
  .ok{padding:16px;border:1px solid var(--ok-border);background:var(--ok-bg);border-radius:12px;margin-top:16px}
  .err{padding:12px;border:1px solid var(--err-border);background:var(--err-bg);border-radius:10px;color:#8a1f1f;margin-bottom:12px}
  .warn{font-size:12px;color:#8a1f1f;margin-top:6px}
  .hide{display:none!important}

  /* success confetti */
  .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
  .confetti i{
    position:absolute; top:-10px; width:8px; height:14px; border-radius:2px;
    opacity:.9; animation:drop 1.9s linear forwards; transform:rotate(20deg)
  }
  @keyframes drop{ to{ transform:translateY(110vh) rotate(320deg); opacity:1 } }

  @media (max-width:640px){ form{grid-template-columns:1fr;gap:12px} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Great choice! Let’s set up your site <span id="planBadge" class="badge"></span></h1>
    <p class="sub">Payment succeeded. Complete this one-time setup.</p>

    <div id="alert" class="err hide"></div>

    <form id="f" novalidate>
      <div class="full">
        <label>Store display name</label>
        <input id="site_display_name" placeholder="Demo Deals" autocomplete="organization"/>
      </div>

      <div>
        <label>Contact email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
      </div>

      <div>
        <label>Site URL (subdomain)</label>
        <input id="subdomain" placeholder="yourbrand" autocomplete="off"/>
        <div class="hint">Your site will be: <b id="hostPrev">yourbrand.bagthatthangup.com</b></div>
        <div id="subWarn" class="warn hide"></div>
      </div>

      <div class="full">
        <label>Amazon Associates ID</label>
        <input id="amazon_tag" placeholder="yourtag-20" autocomplete="off"/>
      </div>

      <!-- Custom/Pro -->
      <div id="p1" class="hide">
        <label>Primary color (hex)</label>
        <input id="color_primary" placeholder="#0ea5a6"/>
      </div>
      <div id="p2" class="hide">
        <label>Secondary color (hex)</label>
        <input id="color_secondary" placeholder="#1e90ff"/>
      </div>
      <div class="full hide" id="layWrap">
        <label>Layout</label>
        <select id="layout"></select>
      </div>

      <!-- Pro-only -->
      <div class="full hide" id="proLogo">
        <label>Logo URL (optional)</label>
        <input id="logo_url" placeholder="https://.../logo.png"/>
      </div>
      <div class="full hide" id="proFeat">
        <label>Featured ASINs (comma-separated)</label>
        <input id="featured_asins" placeholder="B0C123ABCD,B0D456EFGH"/>
      </div>

      <div class="full">
        <button id="go" class="btn" type="submit">Submit onboarding</button>
      </div>

      <!-- hidden fields populated from query -->
      <input type="hidden" id="plan"/>
      <input type="hidden" id="plan_key"/>
    </form>

    <div id="done" class="ok hide">
      <b>Submitted.</b> Your site is ready at
      <a id="link" href="#" target="_blank" rel="noopener"></a>.
      <div class="hint" style="margin-top:8px">Tip: bookmark it now and share it anywhere.</div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== CONFIG ===== */
  const DOMAIN = "bagthatthangup.com";

  // Your GAS endpoint (supports JSONP ?callback=...):
  const GAS = "https://script.google.com/macros/s/AKfycbytm-ntU4HHZq4PDXpwr4qoflZUy8Hcg-7GFLT0RFUJGuKIG0Zy3lIDEYTRBt7UVqkK/exec";

  // Public CSV for Subscribers (used for a fast duplicate check before asking GAS):
  const SUBSCRIBERS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_hOlderdV0ABENcLrWMZFl8zXEqXii-3TnA55f13uVNMArQJjDw9OskRH1gLLQLIivHl5zOeH0yKb/pub?gid=0&single=true&output=csv";

  // Plan keys (opaque). We accept either plan_key=<opaque> OR plan=Basic|Custom|Pro.
  // If you pass plan_key in the redirect from Stripe, the user can’t just flip a plan name in the URL.
  const PLAN_BY_KEY = {
    // example mapping: "test_btb_basic_123": "Basic"
    // fill in if/when you wire Stripe success URL to include ?plan_key=
  };

  /* ===== ELEMENTS ===== */
  const q = id => document.getElementById(id);
  const alertBox = q('alert'), form = q('f'), done = q('done'), link = q('link');
  const planBadge = q('planBadge'), subWarn = q('subWarn'), hostPrev = q('hostPrev'), goBtn = q('go');
  const fields = {
    site_display_name:q('site_display_name'), email:q('email'), subdomain:q('subdomain'), amazon_tag:q('amazon_tag'),
    color_primary:q('color_primary'), color_secondary:q('color_secondary'), layout:q('layout'),
    logo_url:q('logo_url'), featured_asins:q('featured_asins'), plan:q('plan'), plan_key:q('plan_key')
  };
  const p1=q('p1'), p2=q('p2'), layWrap=q('layWrap'), proLogo=q('proLogo'), proFeat=q('proFeat');

  /* ===== UTILS ===== */
  const sanitizeSub = s => String(s||'').toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(3,66) || String(s||'').toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(0,63); // ensure ≥3 chars when possible
  const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim());
  const normHex = v => { v=String(v||'').trim().replace(/^#/,''); return /^[0-9a-f]{6}$/i.test(v) ? '#'+v : ''; };
  function showError(msg){ alertBox.textContent = msg; alertBox.classList.remove('hide'); }
  function hideError(){ alertBox.classList.add('hide'); }
  function setBusy(b){ goBtn.disabled=b; goBtn.textContent=b?'Submitting…':'Submit onboarding'; }
  function updatePrev(){ const s = sanitizeSub(fields.subdomain.value); hostPrev.textContent = s ? `${s}.${DOMAIN}` : `yourbrand.${DOMAIN}`; }
  function reserved(sub){ return new Set(['www','admin','root','api','test','dev','static','assets','img','tenant','onboarding','start','stripe','success']).has(sub); }

  function spawnConfetti(){
    const colors = ["#0b72f0","#1e90ff","#22c55e","#f59e0b","#ef4444","#a855f7"];
    const wrap = document.createElement('div');
    wrap.className = 'confetti';
    document.body.appendChild(wrap);
    const N = 90;
    for(let i=0;i<N;i++){
      const bit = document.createElement('i');
      bit.style.left = (Math.random()*100)+"vw";
      bit.style.background = colors[Math.floor(Math.random()*colors.length)];
      bit.style.animationDelay = (Math.random()*0.9)+"s";
      bit.style.transform = `translateY(${-40-Math.random()*60}px) rotate(${Math.random()*180}deg)`;
      wrap.appendChild(bit);
    }
    setTimeout(()=>{ wrap.remove(); }, 2600);
  }

  /* ===== CSV parsing (for fast duplicate check) ===== */
  function parseCSV(text){
    const rows=[]; let row=[], cell="", inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i], nx=text[i+1];
      if(inQ){ if(ch==='"'&&nx==='"'){cell+='"';i++;} else if(ch==='"'){inQ=false;} else{cell+=ch;} }
      else { if(ch==='"'){inQ=true;} else if(ch===','){row.push(cell);cell="";}
             else if(ch==='\r'&&nx==='\n'){row.push(cell);rows.push(row);row=[];cell="";i++;}
             else if(ch==='\n'){row.push(cell);rows.push(row);row=[];cell="";} else{cell+=ch;} }
    }
    if(cell!==""||row.length){row.push(cell);rows.push(row);}
    return rows.filter(r=>r.length>1);
  }
  function toObjects(rows){
    if(!rows.length) return [];
    const headers = rows[0].map(h=>String(h||"").trim());
    const idx = Object.fromEntries(headers.map((h,i)=>[h.toLowerCase(),i]));
    return rows.slice(1).map((r,ix)=>{
      const o={ _ix: ix };
      for(const [h,i] of Object.entries(idx)) o[h]=(r[i]||"").toString().trim();
      return o;
    });
  }
  async function csvTaken(sub){
    try{
      const res = await fetch(SUBSCRIBERS_CSV + "&cb=" + Date.now(), { cache:'no-store' });
      if(!res.ok) return null;
      const text = await res.text();
      const objs = toObjects(parseCSV(text));
      const hit = objs.find(r => String(r.subdomain||'').toLowerCase()===sub && !/^canceled|deleted$/i.test(String(r.status||'')));
      return !!hit;
    }catch(_){ return null; }
  }

  /* ===== JSONP helpers (no CORS) ===== */
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = "btb_cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement('script');
      const timer = setTimeout(()=>{ cleanup(); reject(new Error("timeout")); }, 9000);
      function cleanup(){ clearTimeout(timer); try{ delete window[cb]; }catch(_){}
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      window[cb] = function(resp){ cleanup(); resolve(resp); };
      s.onerror = ()=>{ cleanup(); reject(new Error("network")); };
      s.src = url + (url.includes('?')?'&':'?') + "callback=" + cb + "&ts=" + Date.now();
      document.head.appendChild(s);
    });
  }

  async function checkTakenJSONP(sub){
    const u = `${GAS}?exists=${encodeURIComponent(sub)}`;
    const resp = await jsonp(u);
    // Expected shape: { ok:true, exists:boolean }
    if (resp && resp.ok === true && typeof resp.exists === 'boolean') return resp.exists;
    // Legacy shape fallback: { ok:true, taken:boolean }
    if (resp && typeof resp.taken === 'boolean') return resp.taken;
    // Any explicit error?
    if (resp && resp.error) throw new Error(String(resp.error));
    // Unknown → treat as not taken
    return false;
  }

  async function writeRowJSONP(payload){
    const qs = new URLSearchParams({ beacon:'1', ...payload });
    const resp = await jsonp(`${GAS}?${qs.toString()}`);
    if (resp && resp.ok) return true;
    if (resp && resp.error) throw new Error(resp.error);
    throw new Error("write_failed");
  }

  /* ===== Plan detection & UI gating ===== */
  function detectPlan(){
    const p = new URLSearchParams(location.search);
    const planKey = p.get('plan_key') || '';
    const planName = p.get('plan') || '';
    let plan = '';

    if (planKey && PLAN_BY_KEY[planKey]) {
      plan = PLAN_BY_KEY[planKey];
      fields.plan_key.value = planKey;
    } else if (/^(Basic|Custom|Pro)$/i.test(planName)) {
      plan = planName.charAt(0).toUpperCase() + planName.slice(1).toLowerCase();
    }

    fields.plan.value = plan;
    planBadge.textContent = plan || '—';
    // Gate fields by plan
    const isCustom = (plan==='Custom' || plan==='Pro');
    const isPro = (plan==='Pro');
    p1.classList.toggle('hide', !isCustom);
    p2.classList.toggle('hide', !isCustom);
    layWrap.classList.toggle('hide', !isCustom);
    fields.layout.innerHTML='';
    if (plan==='Custom') ["list","grid"].forEach(x=>fields.layout.add(new Option(x,x)));
    if (plan==='Pro') ["list","grid","spotlight","magazine"].forEach(x=>fields.layout.add(new Option(x,x)));
    proLogo.classList.toggle('hide', !isPro);
    proFeat.classList.toggle('hide', !isPro);
  }

  /* ===== LIVE availability check ===== */
  let debounce=null;
  fields.subdomain.addEventListener('input', ()=>{
    updatePrev();
    subWarn.classList.add('hide'); subWarn.textContent='';
    const sub = sanitizeSub(fields.subdomain.value);
    if (!sub || sub.length < 3 || reserved(sub)) return;
    if (debounce) clearTimeout(debounce);
    debounce = setTimeout(async ()=>{
      // CSV first (fast), then JSONP to GAS for authority
      try{
        const csvSays = await csvTaken(sub);
        if (csvSays === true){
          subWarn.textContent="That site URL is already taken. Try another.";
          subWarn.classList.remove('hide');
          return;
        }
        // CSV failed or says free → confirm with GAS
        try{
          const taken = await checkTakenJSONP(sub);
          if (taken){
            subWarn.textContent="That site URL is already taken. Try another.";
            subWarn.classList.remove('hide');
          } else {
            subWarn.textContent="Great! This site URL is available.";
            subWarn.classList.remove('hide');
            subWarn.style.color = '#166534';
          }
        }catch(_){}
      }catch(_){}
    }, 350);
  });

  /* ===== SUBMIT ===== */
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault(); hideError(); setBusy(true);

    const plan = fields.plan.value.trim();
    if (!/^(Basic|Custom|Pro)$/.test(plan)) {
      setBusy(false); return showError("Invalid or missing plan. Please return to the pricing page and start again.");
    }

    const site_display_name = fields.site_display_name.value.trim();
    const email = fields.email.value.trim();
    const sub = sanitizeSub(fields.subdomain.value);
    const amazon_tag = fields.amazon_tag.value.trim();

    const isCustom = (plan==='Custom' || plan==='Pro');
    const isPro = (plan==='Pro');

    const color_primary = isCustom ? normHex(fields.color_primary?.value||'') : '';
    const color_secondary = isCustom ? normHex(fields.color_secondary?.value||'') : '';
    const layout = isCustom ? (fields.layout?.value||'list') : 'list';
    const logo_url = isPro ? (fields.logo_url?.value||'').trim() : '';
    const featured_asins = isPro ? (fields.featured_asins?.value||'').trim() : '';

    if (!site_display_name){ setBusy(false); return showError("Enter a site name."); }
    if (!isEmail(email))   { setBusy(false); return showError("Enter a valid email."); }
    if (!sub || sub.length<3){ setBusy(false); return showError("Enter a valid site URL (3+ chars)."); }
    if (reserved(sub))     { setBusy(false); return showError("That site URL is reserved. Choose another."); }
    if (!amazon_tag)       { setBusy(false); return showError("Enter your Amazon Associates ID."); }

    // Availability check: CSV → GAS (authoritative). If taken, stop.
    try{
      const csvSays = await csvTaken(sub);
      if (csvSays === true){ setBusy(false); subWarn.textContent="That site URL is already taken. Try another."; subWarn.classList.remove('hide'); return showError("That site URL is already taken."); }
      const taken = await checkTakenJSONP(sub);
      if (taken){ setBusy(false); subWarn.textContent="That site URL is already taken. Try another."; subWarn.classList.remove('hide'); return showError("That site URL is already taken."); }
    }catch(_){
      // If checks fail, we still try write; the sheet will reject duplicates server-side.
    }

    // Write (JSONP) — avoids CORS
    try{
      await writeRowJSONP({
        timestamp: new Date().toISOString(),
        tenant_id: '', // let GAS set or keep blank
        email, site_display_name, subdomain: sub, plan,
        amazon_tag, color_primary, color_secondary, logo_url,
        layout, featured_asins,
        extra_page_enabled: 'false',
        status: 'active'
      });

      // Success: show link and confetti
      const url = `https://${sub}.${DOMAIN}`;
      form.classList.add('hide');
      done.classList.remove('hide');
      link.href = url;
      link.textContent = url;
      spawnConfetti();
    }catch(e){
      console.error(e);
      showError("Network or server error. Please try again.");
    }finally{
      setBusy(false);
    }
  });

  /* ===== INIT ===== */
  document.addEventListener('DOMContentLoaded', ()=>{
    detectPlan();
    updatePrev();
  });
})();
</script>
</body>
</html>
