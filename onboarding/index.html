<script>
// ---- Single source of truth: GAS ?exists= via JSONP ----
function checkExistsGAS(sub){
  return new Promise((resolve,reject)=>{
    const cb = 'bt_exists_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const url = `${GAS_ENDPOINT}?exists=${encodeURIComponent(sub)}&callback=${cb}&t=${Date.now()}`;
    const timer = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, 8000);
    function cleanup(){
      clearTimeout(timer);
      try{ delete window[cb]; }catch(_){}
      if (s && s.parentNode) s.parentNode.removeChild(s);
    }
    window[cb] = (resp)=>{
      cleanup();
      if (resp && resp.ok === true && typeof resp.exists === 'boolean'){
        resolve(resp.exists);
      } else {
        reject(new Error('bad_response'));
      }
    };
    s.onerror = ()=>{ cleanup(); reject(new Error('network')); };
    s.src = url;
    document.head.appendChild(s);
  });
}

// wire up the input
(function(){
  const subInput = document.getElementById('subdomain');
  const subWarn  = document.getElementById('subWarn');
  const hostPrev = document.getElementById('hostPrev');
  const DOMAIN   = "bagthatthangup.com";
  const sanitize = s => String(s||'').toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(0,63);

  let timer=null, lastReqId=0;
  function updatePreview(){
    const s = sanitize(subInput.value);
    hostPrev.textContent = s ? `${s}.${DOMAIN}` : `yourbrand.${DOMAIN}`;
  }
  subInput.addEventListener('input', ()=>{
    subWarn.classList.add('hide'); subWarn.textContent='';
    updatePreview();
    const s = sanitize(subInput.value);
    if (!s || s.length < 3) return;

    if (timer) clearTimeout(timer);
    timer = setTimeout(async ()=>{
      const myId = ++lastReqId;
      try{
        const exists = await checkExistsGAS(s);
        if (myId !== lastReqId) return; // ignore stale result
        if (exists){
          subWarn.textContent = "That site URL is already taken. Try another.";
          subWarn.classList.remove('hide');
        } else {
          subWarn.textContent = "Great! This name is available.";
          subWarn.classList.remove('hide');
          subWarn.style.color = "#0b7d3b";
        }
      }catch(_){
        if (myId !== lastReqId) return;
        subWarn.textContent = "Couldnâ€™t verify name right now. You can still submit.";
        subWarn.classList.remove('hide');
        subWarn.style.color = "";
      }
    }, 400);
  });

  // set initial preview once
  updatePreview();
})();
</script>
