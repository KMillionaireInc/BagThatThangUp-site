<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Finish Onboarding · BagThat</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --ink:#0b1320;--muted:#5a6b7a;--line:#e8eef5;--bg:#f6f9fc;--surface:#fff;--brand:#0b72f0;--ok:#0a7f4f;--bad:#b3261e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:900px;margin:28px auto;padding:16px}
  h1{font-size:32px;margin:0 0 18px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 10px 26px rgba(2,24,43,.06)}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:720px){ .row{grid-template-columns:1fr} }
  label{display:block;font-weight:700;margin:4px 0 6px}
  input[type="text"],input[type="email"],input[type="url"],input[type="color"]{
    width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff
  }
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;font-weight:800;border:1px solid #cfe2ff;background:#eaf2ff;color:#083663;border-radius:999px;padding:6px 10px}
  .btn{display:inline-block;background:var(--brand);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .alert{border:2px solid #ffd7d7;background:#fff6f6;color:var(--bad);border-radius:12px;padding:12px 14px;margin:10px 0}
  .good{color:var(--ok)}
  .space{height:10px}
  .actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
  /* Toggle advanced sections */
  [data-plan="Basic"] .pro-or-custom-only{display:none}
  /* Subdomain chip */
  .chip{display:inline-block;margin-left:8px;font-weight:800}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Let’s set up your site</h1>
    <p class="muted">Payment succeeded (or you came here directly). Complete this quick one-time setup.</p>

    <div id="errorTop" class="alert" style="display:none"></div>

    <div class="card">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
        <span class="pill">Selected plan: <span id="selectedPlanTag" style="margin-left:6px">—</span></span>
        <a href="/pricing/" class="muted" style="margin-left:auto;text-decoration:none;font-weight:800">Choose a different plan</a>
      </div>

      <form id="form">
        <div class="row">
          <div>
            <label for="site_display_name">Store display name</label>
            <input id="site_display_name" type="text" placeholder="Ex: Daisy’s Deals" required>
          </div>
          <div>
            <label for="email">Contact email</label>
            <input id="email" type="email" placeholder="you@example.com" required>
          </div>
        </div>

        <div class="space"></div>

        <div class="row">
          <div>
            <label for="subdomain">Site URL (subdomain)</label>
            <input id="subdomain" type="text" placeholder="e.g., daisysdeals" autocomplete="off" spellcheck="false" required>
            <div class="muted">Your site will be: <b id="sitePreview">—</b> <span id="subCheckStatus" class="chip"></span></div>
          </div>
          <div>
            <label for="amazon_tag">Amazon Associates ID</label>
            <input id="amazon_tag" type="text" placeholder="yourtag-20" required>
          </div>
        </div>

        <div class="space"></div>

        <!-- Optional colors / logo (hide for Basic if you want fewer fields visibly; keep but non-blocking) -->
        <div class="row pro-or-custom-only">
          <div>
            <label for="color_primary">Primary color (optional)</label>
            <input id="color_primary" type="text" placeholder="#0ea5a6">
          </div>
          <div>
            <label for="color_secondary">Accent color (optional)</label>
            <input id="color_secondary" type="text" placeholder="#1e90ff">
          </div>
        </div>

        <div class="space pro-or-custom-only"></div>

        <div class="row pro-or-custom-only">
          <div>
            <label for="logo_url">Logo URL (optional)</label>
            <input id="logo_url" type="url" placeholder="https://…/logo.png">
          </div>
          <div>
            <label for="layout">Layout (optional)</label>
            <input id="layout" type="text" placeholder="grid | rows | classic">
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="submitBtn" type="submit">Submit onboarding</button>
          <span id="saveMsg" class="muted"></span>
        </div>
      </form>
    </div>
  </div>

<script>
(function(){
  /* ====== SETTINGS ====== */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbytm-ntU4HHZq4PDXpwr4qoflZUy8Hcg-7GFLT0RFUJGuKIG0Zy3lIDEYTRBt7UVqkK/exec";

  /* ====== PLAN HANDLING ====== */
  const qs = new URLSearchParams(location.search);
  const planParam = (qs.get("plan")||"").trim();
  const planKey = (qs.get("plan_key")||"").trim(); // pass-through only, no validation
  const ALLOWED = new Set(["Basic","Custom","Pro"]);
  const PLAN = ALLOWED.has(planParam) ? planParam : "Basic";

  // Expose for debugging if needed
  window.__bagthat = { PLAN, planKey };

  document.getElementById("selectedPlanTag").textContent = PLAN;
  document.body.dataset.plan = PLAN;

  /* ====== DOM ====== */
  const el = (id)=>document.getElementById(id);
  const siteName = el("site_display_name");
  const email = el("email");
  const subdomain = el("subdomain");
  const amazon = el("amazon_tag");
  const color1 = el("color_primary");
  const color2 = el("color_secondary");
  const logo = el("logo_url");
  const layout = el("layout");
  const sitePreview = el("sitePreview");
  const subStatus = el("subCheckStatus");
  const errorTop = el("errorTop");
  const submitBtn = el("submitBtn");
  const saveMsg = el("saveMsg");

  const ROOT_DOMAIN = "bagthatthangup.com";

  function sanitizeSub(raw){
    return String(raw||"").toLowerCase().replace(/[^a-z0-9-]/g,"").replace(/^-+|-+$/g,"").slice(0,63);
  }

  function updatePreview(){
    const s = sanitizeSub(subdomain.value);
    sitePreview.textContent = s ? `${s}.${ROOT_DOMAIN}` : "—";
  }

  subdomain.addEventListener("input", updatePreview);
  updatePreview();

  /* ====== Subdomain availability (debounced, soft-fail) ====== */
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

  const checkSub = debounce(async function(raw){
    const sub = sanitizeSub(raw);
    if(!sub){ subStatus.textContent=""; subStatus.removeAttribute("data-ok"); return; }
    subStatus.textContent = "Checking…";
    subStatus.style.color = "";
    try{
      const res = await fetch(`${GAS_URL}?check=1&sub=${encodeURIComponent(sub)}`,{cache:"no-store"});
      const j = await res.json();
      if (j.ok && j.exists===false){
        subStatus.textContent = "Great! This name is available.";
        subStatus.style.color = "var(--ok)";
        subStatus.dataset.ok = "1";
      } else if (j.ok && j.exists===true){
        subStatus.textContent = "That name is taken. Try another.";
        subStatus.style.color = "var(--bad)";
        subStatus.dataset.ok = "0";
      } else {
        subStatus.textContent = "";
        subStatus.removeAttribute("data-ok"); // soft fail
      }
    }catch(_){
      subStatus.textContent = "";
      subStatus.removeAttribute("data-ok"); // soft fail
    }
  }, 400);

  subdomain.addEventListener("input", e=>checkSub(e.target.value));

  /* ====== Submit ====== */
  function showError(msg){
    errorTop.style.display = "block";
    errorTop.textContent = msg;
  }
  function clearError(){
    errorTop.style.display = "none";
    errorTop.textContent = "";
  }

  document.getElementById("form").addEventListener("submit", async (e)=>{
    e.preventDefault();
    clearError();
    saveMsg.textContent = "";
    submitBtn.disabled = true;

    const sub = sanitizeSub(subdomain.value);
    if(!sub){ showError("Please enter a valid site URL (subdomain)."); submitBtn.disabled=false; return; }

    // Don’t block on network hiccup from checker; we still write & let the sheet enforce uniqueness
    const payload = {
      beacon: 1,
      plan: PLAN,
      plan_key: planKey,              // passed through, not validated here
      site_display_name: siteName.value.trim(),
      email: email.value.trim(),
      subdomain: sub,
      amazon_tag: amazon.value.trim(),
      color_primary: (color1.value||"").trim(),
      color_secondary: (color2.value||"").trim(),
      logo_url: (logo.value||"").trim(),
      layout: (layout.value||"").trim(),
      status: "active"
    };

    try{
      const url = GAS_URL + "?" + new URLSearchParams(payload).toString();
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      const j = await res.json();
      if (j.ok){
        saveMsg.textContent = "Submitted! Creating your site…";
        // Send them to their new site (or a success page)
        const dest = `https://${sub}.${ROOT_DOMAIN}/`;
        // Optional: if you have a /stripe/success/ page, go there instead and include the URL
        // const dest = `/stripe/success/?site=${encodeURIComponent(dest)}`
        setTimeout(()=>{ location.href = dest; }, 900);
      } else {
        showError(j.error || "There was a problem submitting your setup. Please try again.");
        submitBtn.disabled = false;
      }
    }catch(err){
      showError("Network issue while submitting. Please try again.");
      submitBtn.disabled = false;
    }
  });

  // Focus first field
  siteName.focus();
})();
</script>
</body>
</html>
