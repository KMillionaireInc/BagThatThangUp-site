<script>
(function () {
  /* =========================
     CONFIG
  ========================== */
  const DOMAIN = "bagthatthangup.com";

  // Google Apps Script Web App endpoint (unchanged)
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzGCoO7gT7Uwf25T1ODHKTgTfTBXqIfVBh9EFmR66QohwsA9TOzH1J27SnhJrRSJX04/exec";

  // PLAN GATE: only these exact pairs are allowed to see/submit the form
  const VALID_KEYS = {
    Basic:  "btb_7vRyKQ6mP2wTg8nC4aZJd9sLq3Xe0Uh",
    Custom: "btc_R3mXn8qJ0vWk2pY5sHa4Lu9Td6Bf1Zo",
    Pro:    "btp_9hNsR3eL8kV5wC2mT1qXy4dJz7aF0Gb"
  };

  // Layout options shown for Custom/Pro
  const LAYOUTS = [
    { value: "classic", label: "Classic" },
    { value: "grid",    label: "Product Grid" },
    { value: "mag",     label: "Magazine" }
  ];

  // Subdomains we don't allow users to take
  const RESERVED = new Set([
    "www","app","admin","api","cdn","assets","static","img","mail",
    "onboarding","start","stripe","success","tenant","shop","store",
    "blog","help","support","status","docs"
  ]);

  /* =========================
     ELEMENTS & HELPERS
  ========================== */
  const $ = (id) => document.getElementById(id);

  const alertBox = $("alert");
  const planBadge = $("planBadge");
  const form = $("f");
  const done = $("done");
  const link = $("link");
  const hostPrev = $("hostPrev");
  const subWarn = $("subWarn");
  const goBtn = $("go");

  const fields = {
    site_display_name: $("site_display_name"),
    email: $("email"),
    subdomain: $("subdomain"),
    amazon_tag: $("amazon_tag"),
    color_primary: $("color_primary"),
    color_secondary: $("color_secondary"),
    layout: $("layout"),
    logo_url: $("logo_url"),
    featured_asins: $("featured_asins")
  };

  const p1 = $("p1"), p2 = $("p2"), layWrap = $("layWrap"),
        proLogo = $("proLogo"), proFeat = $("proFeat");

  const qs = new URLSearchParams(location.search);
  const plan = (qs.get("plan") || "").trim();
  const planKey = (qs.get("plan_key") || "").trim();

  const sanitizeSub = (s) =>
    String(s || "")
      .toLowerCase()
      .replace(/[^a-z0-9-]/g, "")
      .replace(/^-+|-+$/g, "")
      .slice(0, 63);

  const isEmail = (s) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s || "").trim());
  const isHex6 = (v) => /^[0-9a-f]{6}$/i.test(String(v || "").replace(/^#/, ""));
  const toHex6 = (v) => {
    v = String(v || "").trim().replace(/^#/, "");
    return isHex6(v) ? "#" + v : "";
  };

  function showError(msg) {
    alertBox.textContent = msg;
    alertBox.classList.remove("hide");
  }

  function hideError() {
    alertBox.classList.add("hide");
  }

  function setBusy(b) {
    goBtn.disabled = b;
    goBtn.textContent = b ? "Submitting…" : "Submit onboarding";
  }

  function updatePreview() {
    const sub = sanitizeSub(fields.subdomain.value);
    fields.subdomain.value = sub;
    const full = sub ? `https://${sub}.${DOMAIN}` : "—";
    hostPrev.textContent = full;
  }

  function subdomainIssue(sub) {
    if (!sub) return "Please enter a subdomain.";
    if (sub.length < 3) return "Subdomain must be at least 3 characters.";
    if (!/^[a-z0-9-]+$/.test(sub)) return "Use letters, numbers, and hyphens only.";
    if (/--/.test(sub)) return "Use single hyphens (no consecutive hyphens).";
    if (sub.startsWith("-") || sub.endsWith("-")) return "Cannot start or end with a hyphen.";
    if (RESERVED.has(sub)) return `“${sub}” is reserved. Please choose another.`;
    return "";
  }

  function applyPlanVisibility(plan) {
    // Default hide
    p1.classList.add("hide");
    p2.classList.add("hide");
    layWrap.classList.add("hide");
    proLogo.classList.add("hide");
    proFeat.classList.add("hide");

    // Basic: just core fields
    if (plan === "Basic") return;

    // Custom: colors + layout
    if (plan === "Custom") {
      p1.classList.remove("hide");
      p2.classList.remove("hide");
      layWrap.classList.remove("hide");
      return;
    }

    // Pro: everything
    if (plan === "Pro") {
      p1.classList.remove("hide");
      p2.classList.remove("hide");
      layWrap.classList.remove("hide");
      proLogo.classList.remove("hide");
      proFeat.classList.remove("hide");
    }
  }

  function fillLayouts() {
    fields.layout.innerHTML = "";
    for (const opt of LAYOUTS) {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.label;
      fields.layout.appendChild(o);
    }
  }

  function guardAccess() {
    const ok = !!plan && !!planKey && VALID_KEYS[plan] === planKey;
    if (!ok) {
      // Hide form & show error
      form.style.display = "none";
      showError("Invalid or missing plan link. Contact support.");
      return false;
    }
    return true;
  }

  /* =========================
     INIT
  ========================== */
  document.addEventListener("DOMContentLoaded", () => {
    // Gate check first
    if (!guardAccess()) return;

    // Badge + options based on plan
    planBadge.textContent = plan;
    fillLayouts();
    applyPlanVisibility(plan);

    // Autofill subdomain from store name (only if user hasn’t typed)
    let userTypedSub = false;
    fields.subdomain.addEventListener("input", () => {
      userTypedSub = true;
      const msg = subdomainIssue(fields.subdomain.value.trim());
      subWarn.textContent = msg;
      subWarn.classList.toggle("hide", !msg);
      updatePreview();
    });

    fields.site_display_name.addEventListener("input", () => {
      if (!userTypedSub) {
        fields.subdomain.value = sanitizeSub(fields.site_display_name.value).slice(0, 30);
        const msg = subdomainIssue(fields.subdomain.value.trim());
        subWarn.textContent = msg;
        subWarn.classList.toggle("hide", !msg);
        updatePreview();
      }
    });

    // initial preview
    updatePreview();

    // Submit handler
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideError();

      // Validate required fields
      const name = fields.site_display_name.value.trim();
      const email = fields.email.value.trim();
      const sub = sanitizeSub(fields.subdomain.value);
      const amazonTag = fields.amazon_tag.value.trim();

      if (!name) return showError("Please enter a store display name.");
      if (!isEmail(email)) return showError("Please enter a valid contact email.");

      const subIssue = subdomainIssue(sub);
      if (subIssue) {
        subWarn.textContent = subIssue;
        subWarn.classList.remove("hide");
        return showError(subIssue);
      }

      // Optional fields by plan
      const payload = {
        ts: new Date().toISOString(),
        plan,
        plan_key: planKey, // stored for verification on the backend sheet if needed
        store_name: name,
        email,
        subdomain: sub,
        host: `${sub}.${DOMAIN}`,
        amazon_tag: amazonTag,
        color_primary: "",
        color_secondary: "",
        layout: "",
        logo_url: "",
        featured_asins: ""
      };

      if (plan === "Custom" || plan === "Pro") {
        payload.color_primary = toHex6(fields.color_primary.value);
        payload.color_secondary = toHex6(fields.color_secondary.value);
        payload.layout = fields.layout.value || "classic";

        if (plan === "Pro") {
          payload.logo_url = (fields.logo_url.value || "").trim();
          payload.featured_asins = (fields.featured_asins.value || "").trim();
        }
      }

      setBusy(true);
      try {
        // Fire-and-forget to GAS (opaque response in no-cors)
        await fetch(GAS_ENDPOINT, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        // Show success UI
        form.classList.add("hide");
        const full = `https://${payload.host}`;
        link.href = full;
        link.textContent = full;
        done.classList.remove("hide");

        // Then go to success page
        setTimeout(() => {
          location.href = "/stripe/success?ts=" + Date.now();
        }, 1200);
      } catch (err) {
        console.error(err);
        showError("Something went wrong submitting your onboarding. Please try again.");
      } finally {
        setBusy(false);
      }
    });
  });
})();
</script>
