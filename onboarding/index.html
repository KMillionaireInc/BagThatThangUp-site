<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Finish Onboarding</title>
<style>
  :root{--ink:#0b1320;--muted:#5a6b7a;--line:#e8eef5;--bg:#f6f9fc;--surface:#fff;--brand:#0b72f0}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:820px;margin:36px auto;padding:20px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 26px rgba(2,24,43,.06);padding:22px}
  h1{margin:0 0 6px;font-size:28px} .sub{color:var(--muted);margin:0 0 16px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#194bfb;font-size:12px;margin-left:8px}
  form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .full{grid-column:1/-1}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:700}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .ok{padding:14px;border:1px solid #bfeee8;background:#ebfbf8;border-radius:12px;margin-top:16px}
  .err{padding:12px;border:1px solid #ffd2d2;background:#fff3f3;border-radius:10px;color:#8a1f1f;margin-bottom:12px}
  .warn{font-size:12px;color:#8a1f1f;margin-top:6px}
  .hide{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Great choice! Let’s set up your site <span id="planBadge" class="badge"></span></h1>
    <p class="sub">Payment succeeded (or you came here directly). Complete this one-time setup.</p>

    <div id="alert" class="err hide"></div>

    <form id="f" novalidate>
      <div class="full">
        <label>Store display name</label>
        <input id="site_display_name" placeholder="Demo Deals" autocomplete="organization"/>
      </div>

      <div>
        <label>Contact email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
      </div>

      <div>
        <label>Site URL (subdomain)</label>
        <input id="subdomain" placeholder="yourbrand" autocomplete="off"/>
        <div class="hint">Your site will be: <b id="hostPrev">—</b></div>
        <div id="subWarn" class="warn hide"></div>
      </div>

      <div class="full">
        <label>Amazon Associates ID</label>
        <input id="amazon_tag" placeholder="yourtag-20" autocomplete="off"/>
      </div>

      <!-- Custom/Pro -->
      <div id="p1" class="hide">
        <label>Primary color (hex)</label>
        <input id="color_primary" placeholder="#0ea5a6"/>
      </div>
      <div id="p2" class="hide">
        <label>Secondary color (hex)</label>
        <input id="color_secondary" placeholder="#1e90ff"/>
      </div>
      <div class="full hide" id="layWrap">
        <label>Layout</label>
        <select id="layout"></select>
      </div>

      <!-- Pro-only -->
      <div class="full hide" id="proLogo">
        <label>Logo URL (optional)</label>
        <input id="logo_url" placeholder="https://.../logo.png"/>
      </div>
      <div class="full hide" id="proFeat">
        <label>Featured ASINs (comma-separated)</label>
        <input id="featured_asins" placeholder="B0C123ABCD,B0D456EFGH"/>
      </div>

      <div class="full">
        <button id="go" class="btn" type="submit">Submit onboarding</button>
      </div>
    </form>

    <div id="done" class="ok hide">
      <b>Submitted.</b> Your site will be available at <a id="link" href="#" target="_blank" rel="noopener"></a>.
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ===== CONFIG ===== */
  const DOMAIN = "bagthatthangup.com";
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzGCoO7gT7Uwf25T1ODHKTgTfTBXqIfVBh9EFmR66QohwsA9TOzH1J27SnhJrRSJX04/exec";

  /* obfuscated plan keys (no plain names in URL) */
  const PLAN_KEYS = {
    "btb_7vRyKQ6mP2wTg8nC4aZJd9sLq3Xe0Uh": "Basic",
    "btb_k2Xr4P0sLm9Qa7nB8cV1yWz3Ht5Fe2Dc": "Custom",
    "btb_m8Qe1Za4Rt7Ui2Lp6Ns3Yw9Kd5Fx0Hg": "Pro"
  };

  /* ===== Elements ===== */
  const $ = id => document.getElementById(id);
  const alertBox = $('alert'), form = $('f'), done = $('done'), link = $('link');
  const planBadge = $('planBadge'), subWarn = $('subWarn'), hostPrev = $('hostPrev'), goBtn = $('go');
  const fields = {
    site_display_name:$('site_display_name'), email:$('email'), subdomain:$('subdomain'), amazon_tag:$('amazon_tag'),
    color_primary:$('color_primary'), color_secondary:$('color_secondary'), layout:$('layout'),
    logo_url:$('logo_url'), featured_asins:$('featured_asins')
  };
  const p1=$('p1'), p2=$('p2'), layWrap=$('layWrap'), proLogo=$('proLogo'), proFeat=$('proFeat');

  /* ===== Utils ===== */
  const sanitizeSub = s => String(s||'').toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(0,63);
  const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim());
  const normHex = v => { v=String(v||'').trim().replace(/^#/,''); return /^[0-9a-f]{6}$/i.test(v) ? '#'+v : ''; };
  const show = el => el && el.classList.remove('hide');
  const hide = el => el && el.classList.add('hide');
  const setText = (el, v) => el && (el.textContent = v);

  function showError(msg){ setText(alertBox, msg); show(alertBox); }
  function hideError(){ hide(alertBox); }
  function setBusy(b){ if(!goBtn) return; goBtn.disabled=b; goBtn.textContent=b?'Submitting…':'Submit onboarding'; }

  function validSubdomain(s){
    if(!s) return "Please enter a subdomain.";
    if(!/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/.test(s)) return "Use 1–63 chars: letters, numbers, hyphens (no leading/trailing hyphen).";
    return "";
  }

  /* ===== Plan detection from obfuscated key ===== */
  const usp = new URLSearchParams(location.search);
  const planKey = usp.get('plan_key') || "";
  const PLAN = PLAN_KEYS[planKey] || (['Basic','Custom','Pro'].includes(usp.get('plan')) ? usp.get('plan') : 'Basic');

  function renderPlan(){
    setText(planBadge, PLAN);
    show(planBadge);

    const isPro = PLAN === 'Pro';
    const isCustom = PLAN === 'Custom';

    // show color pickers for Custom/Pro
    if(isPro || isCustom){ show(p1); show(p2); show(layWrap); }
    else { hide(p1); hide(p2); hide(layWrap); }

    // Pro extras
    if(isPro){ show(proLogo); show(proFeat); }
    else { hide(proLogo); hide(proFeat); }

    // simple layout options example
    if(fields.layout){
      fields.layout.innerHTML = `
        <option value="clean">Clean (default)</option>
        <option value="grid">Grid</option>
        <option value="cards">Cards</option>
      `;
    }
  }

  function updatePrev(){
    if(!hostPrev || !fields.subdomain) return;
    const s = sanitizeSub(fields.subdomain.value);
    const warning = validSubdomain(s);
    if(warning){ setText(subWarn, warning); show(subWarn); }
    else { hide(subWarn); }
    setText(hostPrev, s ? `${s}.${DOMAIN}` : '—');
  }

  /* ===== Events ===== */
  if(fields.subdomain) fields.subdomain.addEventListener('input', updatePrev);

  if(form) form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    hideError();

    const site_display_name = (fields.site_display_name?.value || "").trim();
    const email = (fields.email?.value || "").trim();
    const subdomain = sanitizeSub(fields.subdomain?.value || "");
    const amazon_tag = (fields.amazon_tag?.value || "").trim();

    const color_primary = normHex(fields.color_primary?.value || "");
    const color_secondary = normHex(fields.color_secondary?.value || "");
    const layout = (fields.layout?.value || "clean");
    const logo_url = (fields.logo_url?.value || "");
    const featured_asins = (fields.featured_asins?.value || "");

    // Validate
    if(!site_display_name) return showError("Please enter your store display name.");
    if(!isEmail(email)) return showError("Please enter a valid email.");
    const w = validSubdomain(subdomain); if(w) return showError(w);
    if(PLAN !== 'Basic' && !amazon_tag) return showError("Amazon Associates ID is required for paid plans.");
    if((PLAN === 'Custom' || PLAN === 'Pro') && (!color_primary || !color_secondary)){
      return showError("Please provide both primary and secondary brand colors (6-digit hex).");
    }

    // Compose payload
    const payload = {
      plan: PLAN,
      site_display_name, email, subdomain, amazon_tag,
      color_primary, color_secondary, layout, logo_url, featured_asins,
      ts: Date.now()
    };

    try{
      setBusy(true);
      // Send to your Google Apps Script (or other endpoint)
      await fetch(GAS_ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
        mode:'no-cors' // GAS often works best with no-cors for anonymous web apps
      });

      const url = `https://${subdomain}.${DOMAIN}`;
      if(link){ link.href = url; setText(link, url); }
      show(done);
      // Optional: redirect after a short pause
      setTimeout(()=>{ location.href = `/stripe/success/?ts=${Date.now()}`; }, 800);
    }catch(err){
      console.error(err);
      showError("Could not submit onboarding. Please try again.");
    }finally{
      setBusy(false);
    }
  });

  // Initial paint
  renderPlan();
  updatePrev();
});
</script>
</body>
</html>
