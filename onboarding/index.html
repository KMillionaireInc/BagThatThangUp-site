<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Finish Onboarding</title>
<style>
  :root{--ink:#0b1320;--muted:#5a6b7a;--line:#e8eef5;--bg:#f6f9fc;--surface:#fff;--brand:#0b72f0}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:860px;margin:36px auto;padding:20px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 26px rgba(2,24,43,.06);padding:24px}
  h1{margin:0 0 8px;font-size:28px}
  .sub{color:var(--muted);margin:0 0 16px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#194bfb;font-size:12px;margin-left:8px}
  form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .full{grid-column:1/-1}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:700}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .ok{padding:14px;border:1px solid #bfeee8;background:#ebfbf8;border-radius:12px;margin-top:16px}
  .err{padding:12px;border:1px solid #ffd2d2;background:#fff3f3;border-radius:10px;color:#8a1f1f;margin-bottom:12px}
  .warn{font-size:12px;color:#8a1f1f;margin-top:6px}
  .hide{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Great choice! Let’s set up your site <span id="planBadge" class="badge"></span></h1>
    <p class="sub">Payment succeeded (or you came here directly). Complete this one-time setup.</p>

    <div id="alert" class="err hide"></div>

    <form id="f" novalidate>
      <div class="full">
        <label>Store display name</label>
        <input id="site_display_name" placeholder="Demo Deals" autocomplete="organization"/>
      </div>

      <div>
        <label>Contact email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
      </div>

      <div>
        <label>Site URL (subdomain)</label>
        <input id="subdomain" placeholder="yourbrand" autocomplete="off"/>
        <div class="hint">Your site will be: <b id="hostPrev">—</b></div>
        <div id="subWarn" class="warn hide"></div>
      </div>

      <div class="full">
        <label>Amazon Associates ID</label>
        <input id="amazon_tag" placeholder="yourtag-20" autocomplete="off"/>
      </div>

      <!-- Custom/Pro -->
      <div id="p1" class="hide">
        <label>Primary color (hex)</label>
        <input id="color_primary" placeholder="#0ea5a6"/>
      </div>
      <div id="p2" class="hide">
        <label>Secondary color (hex)</label>
        <input id="color_secondary" placeholder="#1e90ff"/>
      </div>
      <div class="full hide" id="layWrap">
        <label>Layout</label>
        <select id="layout"></select>
      </div>

      <!-- Pro-only -->
      <div class="full hide" id="proLogo">
        <label>Logo URL (optional)</label>
        <input id="logo_url" placeholder="https://.../logo.png"/>
      </div>
      <div class="full hide" id="proFeat">
        <label>Featured ASINs (comma-separated)</label>
        <input id="featured_asins" placeholder="B0C123ABCD,B0D456EFGH"/>
      </div>

      <div class="full">
        <button id="go" class="btn" type="submit">Submit onboarding</button>
      </div>
    </form>

    <div id="done" class="ok hide">
      <b>Submitted.</b> Your site will be available at
      <a id="link" href="#" target="_blank" rel="noopener"></a>.
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== CONFIG ===== */
  const DOMAIN  = "bagthatthangup.com";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzuBunZjoc0ZKjzOfOknjHKwgjPcHZgdfOC6FZjaccjtqtKjUpURj-jPrUjV4WkKrS9/exec";

  /* ===== Elements ===== */
  const $ = id => document.getElementById(id);
  const alertBox = $('alert'), form = $('f'), done = $('done'), link = $('link');
  const planBadge = $('planBadge'), subWarn = $('subWarn'), hostPrev = $('hostPrev'), goBtn = $('go');
  const fields = {
    site_display_name:$('site_display_name'), email:$('email'), subdomain:$('subdomain'), amazon_tag:$('amazon_tag'),
    color_primary:$('color_primary'), color_secondary:$('color_secondary'), layout:$('layout'),
    logo_url:$('logo_url'), featured_asins:$('featured_asins')
  };
  const p1=$('p1'), p2=$('p2'), layWrap=$('layWrap'), proLogo=$('proLogo'), proFeat=$('proFeat');

  /* ===== Utils ===== */
  const reserved = new Set(['www','admin','root','api','test','dev','static','assets','img','tenant','onboarding','start','stripe','success']);
  const sanitizeSub = s => String(s||'').toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(0,63);
  const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim());
  const normHex = v => { v=String(v||'').trim().replace(/^#/,''); return /^[0-9a-f]{6}$/i.test(v) ? '#'+v : ''; };

  function showError(msg){ alertBox.textContent = msg; alertBox.classList.remove('hide'); }
  function hideError(){ alertBox.classList.add('hide'); }
  function setBusy(b){ goBtn.disabled=b; goBtn.textContent=b?'Submitting…':'Submit onboarding'; }
  function updatePrev(){ const s = sanitizeSub(fields.subdomain.value); hostPrev.textContent = s ? `${s}.${DOMAIN}` : '—'; }

  // JSONP
  function jsonp(url, params={}, timeout=8000){
    return new Promise((resolve,reject)=>{
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      params.callback = cb;
      const q = Object.entries(params).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
      const src = url + (url.includes('?')?'&':'?') + q;
      const s = document.createElement('script'); s.src = src; s.async = true;
      const t = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, timeout);
      function cleanup(){ clearTimeout(t); try{ delete window[cb]; }catch(_){} s.remove(); }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error('load_error')); };
      document.head.appendChild(s);
    });
  }

  // Plan controls (UI only)
  const usp = new URLSearchParams(location.search);
  const plan = usp.get('plan') || '';
  if (plan) planBadge.textContent = plan; else planBadge.classList.add('hide');
  (function cfg(){
    const tier = plan.toLowerCase();
    const isCustom = tier==='custom' || tier==='pro';
    const isPro = tier==='pro';
    [p1,p2,layWrap].forEach(el=>el.classList.toggle('hide', !isCustom));
    [proLogo,proFeat].forEach(el=>el.classList.toggle('hide', !isPro));
    if (isCustom){
      fields.layout.innerHTML = `<option value="grid">Grid</option><option value="masonry">Masonry</option><option value="rows">Rows</option>`;
    }
  })();

  // Live preview + soft availability check
  fields.subdomain.addEventListener('input', ()=>{
    fields.subdomain.value = sanitizeSub(fields.subdomain.value);
    updatePrev();
    subWarn.classList.add('hide'); subWarn.textContent='';
    softCheck();
  });
  updatePrev();

  let debounce;
  function softCheck(){
    clearTimeout(debounce);
    const sub = sanitizeSub(fields.subdomain.value);
    if (!sub) return;
    if (reserved.has(sub)){ subWarn.textContent='This name is reserved. Choose another.'; subWarn.classList.remove('hide'); return; }
    debounce = setTimeout(async ()=>{
      try {
        // prefer "exists", fall back to "check"
        let res = await jsonp(GAS_URL, { exists: 1, subdomain: sub, t: Date.now() }).catch(()=>null);
        if (!res) res = await jsonp(GAS_URL, { check: 1, subdomain: sub, t: Date.now() }).catch(()=>null);
        if (res && res.ok && (res.exists===true || res.taken===true)) {
          subWarn.textContent='That subdomain is already taken. Try another.'; subWarn.classList.remove('hide');
        }
      } catch(_){
        // non-blocking; enforce on submit
      }
    }, 350);
  }

  // Submit
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault(); hideError();
    const sub = sanitizeSub(fields.subdomain.value);
    if (!isEmail(fields.email.value)) return showError('Enter a valid email.');
    if (!sub || sub.length<3) return showError('Enter a valid site URL (3+ chars).');
    if (reserved.has(sub)) return showError('That subdomain is reserved. Choose another.');

    setBusy(true);
    try{
      // enforce uniqueness right before write
      const chk = await jsonp(GAS_URL, { exists: 1, subdomain: sub, t: Date.now() }).catch(()=>null);
      if (chk && chk.ok && chk.exists===true){
        subWarn.textContent='That subdomain is already taken. Try another.'; subWarn.classList.remove('hide');
        setBusy(false); return;
      }

      const payload = {
        beacon: 1,
        email: (fields.email.value||'').trim(),
        site_display_name: (fields.site_display_name.value||'').trim(),
        subdomain: sub,
        plan: plan || '',
        amazon_tag: (fields.amazon_tag.value||'').trim(),
        color_primary: normHex(fields.color_primary.value),
        color_secondary: normHex(fields.color_secondary.value),
        logo_url: (fields.logo_url.value||'').trim(),
        layout: fields.layout.value || '',
        featured_asins: (fields.featured_asins.value||'').trim(),
        extra_page_enabled: 'false',
        status: 'active',
        t: Date.now()
      };

      const res = await jsonp(GAS_URL, payload, 10000);
      if (!res || res.ok !== true) throw new Error(res && res.error || 'write_failed');

      const host = `${sub}.${DOMAIN}`;
      link.href = `https://${host}`;
      link.textContent = host;
      form.classList.add('hide');
      done.classList.remove('hide');
    }catch(e){
      showError('Could not save your info. Try again.');
    }finally{
      setBusy(false);
    }
  });
})();
</script>
</body>
</html>
