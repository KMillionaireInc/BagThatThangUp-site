<script>
(function(){
  /* ========= CONFIG ========= */
  const DOMAIN = "bagthatthangup.com";

  // Your Google Apps Script Web App URL (deployed as "Anyone"): same one you used before.
  // We'll hit it with simple GETs to avoid CORS/preflight complexity.
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzGCoO7gT7Uwf25T1ODHKTgTfTBXqIfVBh9EFmR66QohwsA9TOzH1J27SnhJrRSJX04/exec";

  /* ========= Elements ========= */
  const $ = id => document.getElementById(id);
  const alertBox = $('alert'), form = $('f'), done = $('done'), link = $('link');
  const planBadge = $('planBadge'), subWarn = $('subWarn'), hostPrev = $('hostPrev'), goBtn = $('go');
  const fields = {
    site_display_name:$('site_display_name'),
    email:$('email'),
    subdomain:$('subdomain'),
    amazon_tag:$('amazon_tag'),
    color_primary:$('color_primary'),
    color_secondary:$('color_secondary'),
    layout:$('layout'),
    logo_url:$('logo_url'),
    featured_asins:$('featured_asins')
  };
  const p1=$('p1'), p2=$('p2'), layWrap=$('layWrap'), proLogo=$('proLogo'), proFeat=$('proFeat');

  /* ========= Utils ========= */
  const sanitizeSub = s => String(s||'').toLowerCase()
    .replace(/[^a-z0-9-]/g,'')
    .replace(/^-+|-+$/g,'')
    .slice(0,63);

  const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim());
  const normHex = v => { v=String(v||'').trim().replace(/^#/,''); return /^[0-9a-f]{6}$/i.test(v) ? '#'+v : ''; };

  function showError(msg){ alertBox.textContent = msg; alertBox.classList.remove('hide'); }
  function hideError(){ alertBox.classList.add('hide'); }
  function setBusy(b){ goBtn.disabled=b; goBtn.textContent=b?'Submitting…':'Submit onboarding'; }
  function setPlanBadge(txt){ planBadge.textContent = txt; planBadge.classList.remove('hide'); }

  // Parse plan (secure share link style: ?plan_key=btb_xxx) – still accept ?plan=Basic for backward compat
  const usp = new URLSearchParams(location.search);
  const planKey = usp.get('plan_key') || '';
  const plan = usp.get('plan') || (planKey ? 'Basic' : ''); // display only

  if (plan) setPlanBadge(plan);

  // Show/hide fields by (display) plan
  function configureByPlan(){
    const tier = (plan || '').toLowerCase();
    // Basic: none of the extra controls
    const isPro = tier === 'pro';
    const isCustom = tier === 'custom';

    // Custom & Pro: color + layout controls visible
    [p1,p2,layWrap].forEach(el => el.classList.toggle('hide', !(isCustom || isPro)));
    // Pro only controls
    [proLogo,proFeat].forEach(el => el.classList.toggle('hide', !isPro));
    // Populate layout choices (only when visible)
    if (!layWrap.classList.contains('hide')) {
      fields.layout.innerHTML = `
        <option value="grid">Grid</option>
        <option value="masonry">Masonry</option>
        <option value="rows">Rows</option>
      `;
    }
  }
  configureByPlan();

  // Live preview of host
  function updateHostPreview(){
    const sub = sanitizeSub(fields.subdomain.value);
    const host = sub ? `${sub}.${DOMAIN}` : `—`;
    hostPrev.textContent = host;
  }
  fields.subdomain.addEventListener('input', updateHostPreview);
  updateHostPreview();

  /* ========= Subdomain "already taken" check =========
     To make this authoritative, add the tiny handler below to your GAS (see next comment).
     We try it; if we can’t determine, we’ll show a warning but allow submit.
  */
  async function checkTaken(sub){
    if (!sub) return {state:'free'};
    // 1) Try GAS exists check: GET ?exists=sub  -> returns "1" if taken, "0" if free
    try {
      const res = await fetch(`${GAS_URL}?exists=${encodeURIComponent(sub)}`, { method:'GET', cache:'no-store' });
      if (res.ok) {
        const txt = (await res.text()).trim();
        if (txt === '1') return {state:'taken'};
        if (txt === '0') return {state:'free'};
      }
    } catch {}
    // 2) Unknown (client-only cannot verify globally without a server)
    return {state:'unknown'};
  }

  async function showTakenMessage(){
    const sub = sanitizeSub(fields.subdomain.value);
    const r = await checkTaken(sub);
    fields.subdomain.value = sub;
    if (r.state === 'taken') {
      subWarn.textContent = 'That subdomain is already in use. Please choose another.';
      subWarn.classList.remove('hide');
      subWarn.dataset.state = 'taken';
    } else if (r.state === 'unknown') {
      subWarn.textContent = 'Couldn’t verify if this subdomain is taken. You can continue, but if it’s already used you’ll need to pick another.';
      subWarn.classList.remove('hide');
      subWarn.dataset.state = 'unknown';
    } else {
      subWarn.classList.add('hide');
      subWarn.dataset.state = 'free';
    }
  }
  fields.subdomain.addEventListener('blur', showTakenMessage);

  /* ========= Write to Google Apps Script (GET) =========
     We use a simple GET write to avoid CORS/preflight issues:
       GAS_URL?write=1&<all fields…>
     In Apps Script, use doGet(e) to append to your sheet when e.parameter.write is present.
  */
  function writeToGAS(row){
    const p = new URLSearchParams(row);
    // fire-and-forget; we don’t block UX on the response
    fetch(`${GAS_URL}?write=1&${p.toString()}`, { method:'GET', mode:'no-cors' }).catch(()=>{});
  }

  /* ========= Submit ========= */
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    hideError();

    // Gather & validate
    const row = {
      when: new Date().toISOString(),
      plan_key: planKey || '',                 // secure “share link” style
      plan_display: plan || '',
      site_display_name: fields.site_display_name.value.trim(),
      email: fields.email.value.trim(),
      subdomain: sanitizeSub(fields.subdomain.value),
      amazon_tag: fields.amazon_tag.value.trim(),
      color_primary: normHex(fields.color_primary.value),
      color_secondary: normHex(fields.color_secondary.value),
      layout: fields.layout.value || '',
      logo_url: fields.logo_url.value.trim(),
      featured_asins: fields.featured_asins.value.trim(),
      referer: document.referrer || '',
      ua: navigator.userAgent
    };

    if (!row.site_display_name) return showError('Please enter a store display name.');
    if (!isEmail(row.email))    return showError('Please enter a valid email.');
    if (!row.subdomain)         return showError('Please enter a site URL (subdomain).');

    // Check "taken" state
    await showTakenMessage();
    const state = subWarn.dataset.state || 'free';
    if (state === 'taken') return showError('That subdomain is already in use. Please pick another.');

    setBusy(true);
    try {
      writeToGAS(row);  // non-blocking write

      // ✅ No more redirect to /stripe/success.
      // Show success right here with the site link:
      const host = `${row.subdomain}.${DOMAIN}`;
      link.textContent = host;
      link.href = `https://${host}/tenant`;
      done.classList.remove('hide');

      // optionally scroll to it
      done.scrollIntoView({behavior:'smooth', block:'center'});

    } catch(err){
      console.error(err);
      showError('We couldn’t finish the setup. Please try again.');
    } finally {
      setBusy(false);
    }
  });

})();
</script>
