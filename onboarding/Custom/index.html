<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Finish Onboarding · BagThat (Custom)</title>
  <meta name="color-scheme" content="light only">
  <style>
    :root{
      --ink:#0b1320; --muted:#5a6b7a; --bg:#f7fafc; --surface:#fff; --line:#e8eef5;
      --brand:#0b72f0; --ok:#0f915a; --warn:#b63a2b; --shadow:0 18px 40px rgba(11,19,32,.08)
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:960px;margin:28px auto;padding:0 16px}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px}
    h1{margin:0 0 12px;font-size:28px}
    .err{color:#8a1f1f;background:#fff6f6;border:2px solid #ffd2d2;border-radius:12px;padding:12px 14px;margin:12px 0;display:none}
    .good{display:inline-grid;grid-auto-flow:column;gap:10px;align-items:center;color:#2a6b2f;background:#e7f6ee;border:1px solid #c4ecd7;border-radius:10px;padding:8px 10px;font-weight:700}
    .plan-pill{display:inline-block;background:#083663;color:#fff;border:1px solid #083663;padding:8px 12px;border-radius:999px;font-weight:800}
    form{display:grid;gap:14px;margin-top:10px}
    .row{display:grid;gap:12px}
    @media (min-width:720px){ .row{grid-template-columns:1fr 1fr} }
    label{font-weight:800;font-size:14px}
    input[type="text"],input[type="email"],input[type="url"]{
      width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:12px;font-size:15px
    }
    .hint{color:var(--muted);font-size:12px}
    .flex{display:flex;gap:10px;align-items:center}
    .chip{display:inline-block;padding:4px 8px;border:1px solid #d9e7ff;background:#eef6ff;border-radius:999px;font-weight:800;color:#083663}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--ok);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .divider{height:1px;background:var(--line);margin:6px 0}
    .color-pair{display:flex;gap:10px;align-items:center}
    .color-pair input[type="color"]{width:42px;height:42px;border:1px solid var(--line);border-radius:10px;padding:0}
    .color-pair input[type="text"]{width:140px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Great choice! Let’s set up your site</h1>

      <div id="err" class="err"></div>

      <div class="flex" style="gap:12px;margin:6px 0 10px">
        <span class="plan-pill">Custom</span>
        <span class="chip">Secure setup</span>
      </div>

      <form id="onbForm" novalidate>
        <div class="row">
          <div>
            <label for="store_name">Store display name</label>
            <input id="store_name" type="text" placeholder="e.g., Daisy’s Deals" required>
          </div>
          <div>
            <label for="email">Contact email</label>
            <input id="email" type="email" placeholder="you@example.com" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="sub">Site URL (subdomain)</label>
            <input id="sub" type="text" placeholder="e.g., daisysdeals" pattern="^[a-z0-9-]+$" required>
            <div class="hint">Lowercase letters, numbers, and hyphens. Your site will be: <b id="preview">—</b></div>
            <div id="subWarn" class="hint" style="color:#8a1f1f;display:none"></div>
          </div>
          <div>
            <label for="aaid">Amazon Associates ID</label>
            <input id="aaid" type="text" placeholder="yourtag-20">
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Primary color</label>
            <div class="color-pair">
              <input id="color_primary_pick" type="color" value="#0ea5a6">
              <input id="color_primary_hex"  type="text"  value="#0ea5a6" placeholder="#0ea5a6">
            </div>
          </div>
          <div>
            <label>Accent color</label>
            <div class="color-pair">
              <input id="color_accent_pick" type="color" value="#1e90ff">
              <input id="color_accent_hex"  type="text"  value="#1e90ff" placeholder="#1e90ff">
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="logo_url">Logo / avatar URL (PNG/JPG)</label>
            <input id="logo_url" type="url" placeholder="https://…/logo.png">
            <div class="hint">Optional. If omitted we’ll use a simple letter avatar.</div>
          </div>
          <div>
            <label>Featured link (button)</label>
            <input id="link_label" type="text" placeholder="e.g., Amazon Storefront">
            <input id="link_url"   type="url"  placeholder="https://…">
            <div class="hint">Shown as a button under your header.</div>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
          <button id="submitBtn" class="btn primary" type="submit">Submit onboarding</button>
          <span id="status" class="hint"></span>
        </div>
      </form>
    </div>
  </div>

  <script>
  (function(){
    const DOMAIN     = "bagthatthangup.com";
    const PLAN       = "Custom";
    const GAS        = "https://script.google.com/macros/s/AKfycbytm-ntU4HHZq4PDXpwr4qoflZUy8Hcg-7GFLT0RFUJGuKIG0Zy3lIDEYTRBt7UVqkK/exec";

    // --- helpers ---
    const $ = id => document.getElementById(id);
    const subEl = $('sub'), prevEl = $('preview'), warnEl = $('subWarn');
    function normSub(v){ return String(v||'').toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(0,63); }
    function isEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim()); }
    function normHex(v){ v=String(v||'').trim().replace(/^#/,''); return /^[0-9a-f]{6}$/i.test(v)?('#'+v):''; }

    function updatePreview(){
      const v = normSub(subEl.value);
      prevEl.textContent = v ? (v + "." + DOMAIN) : "—";
      warnEl.style.display = 'none';
      warnEl.textContent = '';
    }
    subEl.addEventListener('input', updatePreview); updatePreview();

    // JSONP check
    function checkTaken(sub){
      return new Promise((resolve,reject)=>{
        const cb = 'bt_cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const url = `${GAS}?exists=1&sub=${encodeURIComponent(sub)}&callback=${cb}&_=${Date.now()}`;
        const to = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, 8000);
        function cleanup(){ clearTimeout(to); try{ delete window[cb]; }catch(_){ } if (s.parentNode) s.parentNode.removeChild(s); }
        window[cb] = (resp)=>{ cleanup(); if (resp && resp.ok) resolve(!!resp.exists); else reject(new Error('bad_response')); };
        s.onerror = ()=>{ cleanup(); reject(new Error('network')); };
        s.src = url; document.head.appendChild(s);
      });
    }

    // JSONP write
    function writeRow(payload){
      return new Promise((resolve,reject)=>{
        const cb = 'bt_cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const q = new URLSearchParams({
          beacon:'1',
          timestamp: new Date().toISOString(),
          tenant_id: '',
          email: payload.email,
          site_display_name: payload.store_name,
          subdomain: payload.subdomain,
          plan: PLAN,
          amazon_tag: payload.aaid,
          color_primary: payload.color_primary,
          color_secondary: payload.color_secondary,
          logo_url: payload.logo_url,
          layout: '',
          featured_asins: '',
          extra_link_label: payload.extra_link_label,
          extra_link_url:   payload.extra_link_url,
          extra_page_enabled: 'false',
          status: 'active',
          callback: cb
        });
        const url = `${GAS}?${q.toString()}`;
        const to = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, 8000);
        function cleanup(){ clearTimeout(to); try{ delete window[cb]; }catch(_){ } if (s.parentNode) s.parentNode.removeChild(s); }
        window[cb] = (resp)=>{ cleanup(); if (resp && resp.ok) resolve(resp); else reject(new Error(resp && resp.error || 'write_failed')); };
        s.onerror = ()=>{ cleanup(); reject(new Error('network')); };
        s.src = url; document.head.appendChild(s);
      });
    }

    // color pickers sync
    (function wireColors(){
      const p=$('color_primary_pick'), ph=$('color_primary_hex');
      const a=$('color_accent_pick'),  ah=$('color_accent_hex');
      p.addEventListener('input', ()=>{ ph.value=p.value; });
      a.addEventListener('input', ()=>{ ah.value=a.value; });
      ph.addEventListener('input', ()=>{ if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(ph.value)) p.value=ph.value; });
      ah.addEventListener('input', ()=>{ if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(ah.value)) a.value=ah.value; });
    })();

    const form = $('onbForm'), errEl = $('err'), statusEl = $('status'), submitBtn = $('submitBtn');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      errEl.style.display='none'; errEl.textContent='';
      statusEl.textContent=''; submitBtn.disabled=true;

      const store_name = $('store_name').value.trim();
      const email      = $('email').value.trim();
      const sub        = normSub(subEl.value);
      const aaid       = $('aaid').value.trim();
      const color1     = normHex($('color_primary_hex').value) || '#0ea5a6';
      const color2     = normHex($('color_accent_hex').value)  || '#1e90ff';
      const logo_url   = $('logo_url').value.trim();
      const extra_label= $('link_label').value.trim();
      const extra_url  = $('link_url').value.trim();

      if (!store_name || !isEmail(email) || !sub){
        errEl.style.display='block'; errEl.textContent='Please complete the required fields with valid values.'; submitBtn.disabled=false; return;
      }

      try{
        const taken = await checkTaken(sub);
        if (taken){
          warnEl.textContent = "That site URL is already taken. Try another.";
          warnEl.style.display = 'block';
          submitBtn.disabled=false;
          return;
        }
      }catch(_){
        // if check fails, we’ll attempt write; backend will enforce duplicates
      }

      try{
        await writeRow({
          store_name,
          email,
          subdomain: sub,
          aaid,
          color_primary: color1,
          color_secondary: color2,
          logo_url,
          extra_link_label: extra_label,
          extra_link_url:   extra_url
        });

        // redirect to your existing success page (same as Basic flow)
        const domain = `${sub}.${DOMAIN}`;
        const success =
          `/success/?domain=${encodeURIComponent(domain)}&store=${encodeURIComponent(store_name)}`;
        location.href = success;

      }catch(err){
        errEl.style.display='block';
        errEl.textContent = "Network or write error while saving. Please try again.";
        submitBtn.disabled=false;
      }
    });
  })();
  </script>
</body>
</html>
