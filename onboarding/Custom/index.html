<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Custom Plan Setup Â· BagThat</title>
<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#f7fafc;margin:0;display:flex;justify-content:center;
  align-items:center;min-height:100vh;color:#0b1320
}
.card{
  background:#fff;border:1px solid #e8eef5;border-radius:16px;
  box-shadow:0 18px 40px rgba(11,19,32,.08);padding:32px;
  text-align:center;max-width:440px;width:90%
}
h1{margin-bottom:16px;font-size:24px}
p{margin:0 0 14px;color:#5a6b7a}
input,select{
  width:100%;padding:11px;border:1px solid #e8eef5;
  border-radius:10px;margin:6px 0;font-size:15px
}
input[type="color"]{height:48px;cursor:pointer}
button{
  background:#0f915a;color:#fff;border:0;padding:12px 18px;
  border-radius:10px;font-weight:700;cursor:pointer;margin-top:12px;width:100%
}
button:disabled{opacity:.6;cursor:not-allowed}
.err{color:#8a1f1f;background:#fff6f6;border:2px solid #ffd2d2;
  border-radius:10px;padding:10px;margin-bottom:10px;display:none}
label{text-align:left;display:block;margin-top:8px;font-weight:700;font-size:14px}
.preview{width:80px;height:80px;border-radius:10px;object-fit:cover;margin-top:6px;display:none}
</style>
</head>
<body>
<div class="card">
  <h1>Custom Plan Setup</h1>
  <div id="err" class="err"></div>

  <label>Store Display Name*</label>
  <input id="store_name" placeholder="My Deals Hub" required>

  <label>Contact Email*</label>
  <input id="email" type="email" placeholder="you@example.com" required>

  <label>Subdomain*</label>
  <input id="sub" placeholder="yourstore" required>

  <label>Amazon Associates ID</label>
  <input id="aaid" placeholder="yourtag-20">

  <label>Logo Image URL</label>
  <input id="logo_url" type="url" placeholder="https://example.com/logo.png">
  <img id="logo_preview" class="preview" alt="Logo preview">

  <label>Primary Brand Color</label>
  <input id="color_primary" type="color" value="#0ea5a6">

  <label>Secondary Accent Color</label>
  <input id="color_secondary" type="color" value="#1e90ff">

  <label>Extra Button Label</label>
  <input id="extra_label" placeholder="Visit My Storefront">

  <label>Extra Button URL</label>
  <input id="extra_url" placeholder="https://amazon.com/shop/...">

  <label>Preferred Layout</label>
  <select id="layout">
    <option value="grid">Grid</option>
    <option value="list">List</option>
  </select>

  <button id="btn">Submit Onboarding</button>
</div>

<script>
(async()=>{
  const GAS_URL = "https://script.google.com/macros/s/AKfycbx3fxXZuoBROs2iYCuugwfTxRRXmX30BCMPZfzyUI8W3jbWK_oQwlvibIVhx9oL87v3/exec";
  const DOMAIN = "bagthatthangup.com";
  const plan = "custom";

  function jsonpRequest(url, params){
    return new Promise((resolve,reject)=>{
      const cbName = "cb"+Math.random().toString(36).slice(2);
      params = {...params, callback: cbName};
      const q = Object.entries(params)
        .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
      const s = document.createElement("script");
      s.src = `${url}?${q}`;
      let done=false;
      window[cbName] = d => { done=true; resolve(d); cleanup(); };
      s.onerror = () => { if(!done){ reject(new Error("JSONP error")); cleanup(); } };
      function cleanup(){ delete window[cbName]; s.remove(); }
      document.body.appendChild(s);
    });
  }

  const errEl=document.getElementById("err");
  const btn=document.getElementById("btn");
  const logoField=document.getElementById("logo_url");
  const logoPrev=document.getElementById("logo_preview");
  logoField.addEventListener("input",()=>{
    const url=logoField.value.trim();
    if(url){logoPrev.src=url;logoPrev.style.display="block";}
    else logoPrev.style.display="none";
  });

  btn.onclick=async()=>{
    errEl.style.display="none";
    const store=document.getElementById("store_name").value.trim();
    const email=document.getElementById("email").value.trim();
    const sub=document.getElementById("sub").value.trim().toLowerCase();
    const tag=document.getElementById("aaid").value.trim();
    const logo=document.getElementById("logo_url").value.trim();
    const color1=document.getElementById("color_primary").value.trim();
    const color2=document.getElementById("color_secondary").value.trim();
    const extraLabel=document.getElementById("extra_label").value.trim();
    const extraUrl=document.getElementById("extra_url").value.trim();
    const layout=document.getElementById("layout").value;

    if(!store||!email||!sub){
      errEl.textContent="Please complete all required fields.";
      errEl.style.display="block";return;
    }

    btn.disabled=true;btn.textContent="Saving...";

    try{
      const r=await jsonpRequest(GAS_URL,{
        beacon:1,
        plan,
        email,
        site_display_name:store,
        subdomain:sub,
        amazon_tag:tag,
        logo_url:logo,
        color_primary:color1,
        color_secondary:color2,
        extra_button_label:extraLabel,
        extra_button_url:extraUrl,
        layout,
        status:"active"
      });
      if(!r||r.ok!==true)throw new Error(r&&r.error?r.error:"write_failed");
      const domain=`${sub}.${DOMAIN}`;
      location.href=`/stripe/success/?domain=${encodeURIComponent(domain)}&store=${encodeURIComponent(store)}`;
    }catch(e){
      console.error(e);
      alert("Error saving your info.");
      btn.disabled=false;btn.textContent="Submit Onboarding";
    }
  };
})();
</script>
</body>
</html>
