<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pro Plan Setup Â· BagThat</title>
<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: #f7fafc;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  color: #0b1320;
}
.card {
  background: #fff;
  border: 1px solid #e8eef5;
  border-radius: 16px;
  box-shadow: 0 18px 40px rgba(11,19,32,.08);
  padding: 32px;
  text-align: center;
  max-width: 420px;
  width: 90%;
}
h1 {margin-bottom: 16px; font-size: 24px;}
p {margin: 0 0 14px; color: #5a6b7a;}
input {
  width: 100%;
  padding: 11px;
  border: 1px solid #e8eef5;
  border-radius: 10px;
  margin: 6px 0;
  font-size: 15px;
}
button {
  background: #0f915a;
  color: #fff;
  border: 0;
  padding: 12px 18px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 12px;
}
button:disabled {opacity: .6; cursor: not-allowed;}
.err {
  color: #8a1f1f;
  background: #fff6f6;
  border: 2px solid #ffd2d2;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 10px;
  display: none;
}
</style>
</head>
<body>
<div class="card">
  <h1>Pro Plan Setup</h1>
  <div id="err" class="err"></div>
  <input id="store_name" placeholder="Store display name" required>
  <input id="email" type="email" placeholder="Contact email" required>
  <input id="sub" placeholder="Site URL (subdomain)" required>
  <input id="aaid" placeholder="Amazon Associates ID">
  <button id="btn">Submit Onboarding</button>
</div>

<script>
(async () => {
  const GAS_URL = "https://script.google.com/macros/s/AKfycbytm-ntU4HHZq4PDXpwr4qoflZUy8Hcg-7GFLT0RFUJGuKIG0Zy3lIDEYTRBt7UVqkK/exec";
  const DOMAIN = "bagthatthangup.com";

  // --- determine plan from plan_key ---
  const planKey = new URLSearchParams(location.search).get("plan_key");
  const planMap = {
    "btb_a1d4f8c93e2b47f6a8d9c0e2f3b1c5d7": "basic",
    "btc_f9a4c7e2d1b0a6c3e8f4d2b7a1c9e0f5": "custom",
    "btp_7c2e9a5f1d3b4a8c6e0f2d9b1a4c7e3f": "pro"
  };
  const plan = planMap[planKey] || "pro";

  // --- helper: JSONP fetch ---
  function jsonpRequest(url, params) {
    return new Promise((resolve, reject) => {
      const cbName = "cb";
      const q = new URLSearchParams({...params, callback: cbName}).toString();
      const s = document.createElement("script");
      s.src = `${url}?${q}`;
      let done = false;
      window[cbName] = d => { done = true; resolve(d); cleanup(); };
      s.onerror = () => { if (!done) { reject(new Error("JSONP error")); cleanup(); } };
      function cleanup() { delete window[cbName]; s.remove(); }
      document.body.appendChild(s);
    });
  }

  const errEl = document.getElementById("err");
  const btn = document.getElementById("btn");

  btn.onclick = async () => {
    errEl.style.display = "none";
    const store = document.getElementById("store_name").value.trim();
    const email = document.getElementById("email").value.trim();
    let sub = document.getElementById("sub").value.trim().toLowerCase().replace(/[^a-z0-9-]/g, "");
    const tag = document.getElementById("aaid").value.trim();

    if (!store || !email || !sub) {
      errEl.textContent = "Please complete all required fields.";
      errEl.style.display = "block";
      return;
    }

    btn.disabled = true;
    btn.textContent = "Submitting...";

    try {
      const res = await jsonpRequest(GAS_URL, {
        plan,
        email,
        site_display_name: store,
        subdomain: sub,
        amazon_tag: tag,
        status: "active"
      });

      if (!res || res.ok !== true) throw new Error(res && res.error ? res.error : "write_failed");

      const domain = `${sub}.${DOMAIN}`;
      location.href = `/onboarding/success/index.html?domain=${encodeURIComponent(domain)}&store=${encodeURIComponent(store)}&plan=${plan}`;

    } catch (err) {
      console.error(err);
      alert("Error saving your info. Please try again.");
      btn.disabled = false;
      btn.textContent = "Submit Onboarding";
    }
  };
})();
</script>
</body>
</html>
