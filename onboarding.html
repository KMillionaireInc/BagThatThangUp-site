/**
 * CRITICAL UTILITY FUNCTIONS
 * -----------------------
 * These functions resolve the server-side TypeError and the client-side CORS error.
 */

function createJsonResponse(data) {
  // FIX: Breaks the chain to ensure ContentService recognizes appendHeader(), 
  // which resolves the "TypeError: ... appendHeader is not a function" error.
  
  // 1. Create the base output object and set MimeType/X-Frame
  const output = ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);

  // 2. Append the critical CORS header separately.
  // This header is essential for allowing your Vercel frontend to talk to GAS.
  output.appendHeader('Access-Control-Allow-Origin', '*'); 
  
  return output; 
}

function doGet(e) {
  // Handles the browser's CORS pre-flight OPTIONS request. 
  // It returns a success code with the correct CORS headers.
  return createJsonResponse({ status: 'info', message: 'GET request received. Ready for POST submission.' });
}

/**
 * MAIN LOGIC (doPost)
 * -------------------
 * Processes the four required fields, checks for duplicate domains, and saves to the sheet.
 */

function doPost(e) {
  try {
    // 1. Parse incoming JSON data (as sent by the frontend)
    let data = {};
    if (e.postData && e.postData.type === 'application/json') {
      data = JSON.parse(e.postData.contents);
    } else {
      data = e.parameter;
    }
    
    // 2. Open the spreadsheet and get the 'Basic' sheet
    const ss = SpreadsheetApp.openById('1YqMpo0L4tjHKq0gvGXmPQOu_iw5QkppFzy4HtdrD1Eo');
    const sheet = ss.getSheetByName('Basic');
    
    // 3. Validate and sanitize domain name
    const newDomainName = (data.domainName || '').toLowerCase().trim();
    
    if (!newDomainName) {
      return createJsonResponse({
          status: 'error',
          message: 'Domain name is required'
      });
    }
    
    // 4. Check for duplicate domain names (assuming column D holds the subdomain)
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
        // Range is from row 2 (skipping header) to last row, 1 column wide (Column D)
        const existingDomains = sheet.getRange(2, 4, lastRow - 1, 1).getValues();
        const domainExists = existingDomains.some(row => 
            row[0] && row[0].toString().toLowerCase().trim() === newDomainName
        );
        
        if (domainExists) {
            return createJsonResponse({
                status: 'error',
                message: `The domain name '${newDomainName}' is already taken. Please try a different name.`
            });
        }
    }
    
    // 5. Prepare and Append Data
    const timestamp = new Date();
    const tenantId = 'tenant_' + timestamp.getTime(); 
    
    // Data order for sheet columns A through F:
    const rowData = [
      timestamp,                    // Column A: timestamp
      tenantId,                     // Column B: tenant_id
      data.displayName || '',       // Column C: site_display_name (Site Name)
      newDomainName,                // Column D: subdomain (Domain Name)
      data.amazonTag || '',         // Column E: amazon_tag (Amazon Associate ID)
      data.email || ''              // Column F: email (Email Address)
    ];
    
    sheet.appendRow(rowData);
    
    // 6. Return success response
    return createJsonResponse({
        status: 'success',
        message: 'Registration successful! Data saved.',
        tenantId: tenantId
    });
      
  } catch (error) {
    // 7. Return detailed error response for server errors
    return createJsonResponse({
        status: 'error',
        message: 'Server Error: ' + error.message || error.toString()
    });
  }
}

/**
 * UTILITY FUNCTION 
 * ----------------
 * Allows you to test the doPost function directly in the GAS editor.
 */
function testDoPost() {
  const testData = {
    postData: {
      type: 'application/json',
      contents: JSON.stringify({
        displayName: 'Test Site',
        domainName: 'testsite-' + new Date().getTime(), // Ensures it's unique
        amazonTag: 'testag-20',
        email: 'test@example.com'
      })
    }
  };
  
  const result = doPost(testData);
  Logger.log(result.getContent());
}
