<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BagThat Onboarding</title>
<style>
  body{font-family:sans-serif;background:#f7f5f0;color:#333;padding:2rem;max-width:480px;margin:auto}
  form{background:#fff;padding:2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
  label{font-weight:600;margin-top:1rem;display:block}
  input{width:100%;padding:.6rem;margin-top:.3rem;border:1px solid #ccc;border-radius:6px}
  button{margin-top:1.5rem;width:100%;padding:.8rem;background:#c19a6b;border:none;border-radius:6px;color:#fff;font-size:1rem;cursor:pointer}
  button:hover{background:#aa875c}
  .error{color:#c62828;font-size:.9rem;margin-top:.5rem}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
</head>
<body>
<h1>Set Up Your Storefront</h1>

<form id="onboard-form">
  <label>First Name</label>
  <input name="first_name" required />
  <label>Last Name</label>
  <input name="last_name" required />
  <label>Store Name</label>
  <input name="site_name" required />
  <label>Desired Domain (letters and numbers only)</label>
  <input name="subdomain" required />
  <div id="domain-error" class="error"></div>
  <label>Amazon Store ID</label>
  <input name="amazon_id" required />
  <label>Email Address</label>
  <input name="email" type="email" required />
  <button type="submit">Submit</button>
</form>

<script>
const SUPABASE_URL = 'https://gmsjqunfsffjiksffvem.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtc2pxdW5mc2Zmamlrc2ZmdmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NzIxNTgsImV4cCI6MjA3NjQ0ODE1OH0.7qEXKk8f8Sd3G2y8KyQ0XbeCyG8ieD-8WV18-_JkRGc';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const form = document.getElementById("onboard-form");
const subInput = form.subdomain;
const err = document.getElementById("domain-error");
const ALNUM = /^[a-zA-Z0-9]+$/; // letters + numbers only

subInput.addEventListener("input", () => {
  err.textContent = ALNUM.test(subInput.value) ? "" :
    "Subdomain may only contain letters and numbers (no spaces, dashes, or symbols).";
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const subdomainRaw = subInput.value.trim();
  if (!ALNUM.test(subdomainRaw)) {
    err.textContent = "Subdomain may only contain letters and numbers (no spaces, dashes, or symbols).";
    return;
  }
  const subdomain = subdomainRaw.toLowerCase();

  const payload = {
    first_name: form.first_name.value.trim(),
    last_name:  form.last_name.value.trim(),
    site_name:  form.site_name.value.trim(),
    subdomain,
    amazon_id:  form.amazon_id.value.trim(),
    email:      form.email.value.trim()
  };

  // Insert and SELECT back the new row's id in one round-trip
  const { data, error } = await db.from('Users')
    .insert([payload])
    .select('id')
    .single();

  if (error) {
    document.body.innerHTML = `<h2 style="text-align:center;color:#c62828;">Error: ${error.message}</h2>`;
    return;
  }

  // Persist for fallback and redirect with a stable identifier
  sessionStorage.setItem('bagthat_tenant_id', String(data.id));
  sessionStorage.setItem('bagthat_sub', subdomain);

  window.location.href = `/success?tenant_id=${encodeURIComponent(String(data.id))}`;
});
</script>
</body>
</html>
