<!-- 
  This HTML file contains the frontend form and JavaScript logic to submit data 
  to the Google Apps Script endpoint using your NEWLY GENERATED WEB APP URL.
  
  **IMPORTANT FIX:** The submission logic has been changed from 'fetch' to 
  'XMLHttpRequest' (XHR) to bypass stubborn browser CORS security checks 
  that are failing the pre-flight request.
-->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  // **!!! ACTION REQUIRED !!!**
  // 
  // After creating a BRAND NEW deployment of your GAS script (Execute as: User accessing the web app, Who has access: Anyone),
  // paste the resulting NEW URL below.
  const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxbAn0Lat0Mr31nk7LIEvgTkaEguQ0VbkYAdnxfteh6MIBkkuC7oge5vRlpFK8-SYqjEw/exec'; 
  
  // Sets the Tailwind font to Inter
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
        },
      }
    }
  }

  // --- Utility Functions ---

  function showMessage(message, isError) {
    const messageBox = document.getElementById('message-box');
    messageBox.textContent = message;
    messageBox.className = isError 
      ? 'p-3 mt-4 text-sm text-red-800 bg-red-100 rounded-lg shadow-inner'
      : 'p-3 mt-4 text-sm text-green-800 bg-green-100 rounded-lg shadow-inner';
    messageBox.style.display = 'block';
  }

  function hideMessage() {
    document.getElementById('message-box').style.display = 'none';
  }

  // --- Form Submission Logic (Switched to XHR) ---

  function handleSubmit(event) {
    event.preventDefault();
    hideMessage();
    
    // Disable button and show loading state
    const button = document.getElementById('submit-button');
    const originalButtonText = button.textContent;
    button.textContent = 'Processing...';
    button.disabled = true;
    
    // Get form data
    const displayName = document.getElementById('displayName').value;
    const domainName = document.getElementById('domainName').value.toLowerCase().trim();
    const amazonTag = document.getElementById('amazonTag').value;
    const email = document.getElementById('email').value;

    const payload = {
      displayName: displayName,
      domainName: domainName,
      amazonTag: amazonTag,
      email: email
    };

    const xhr = new XMLHttpRequest();
    xhr.open('POST', GAS_WEB_APP_URL, true); // true for asynchronous
    
    // CRITICAL: Set the content type for GAS to recognize the JSON payload
    xhr.setRequestHeader('Content-Type', 'application/json');
    
    // XHR onload/onerror handlers
    xhr.onload = function() {
        button.textContent = originalButtonText;
        button.disabled = false;
        
        if (xhr.status >= 200 && xhr.status < 300) {
            try {
                const result = JSON.parse(xhr.responseText);
                
                if (result.status === 'success') {
                    showMessage(`Success! ${result.message}`, false);
                    document.getElementById('onboardingForm').reset(); 
                } else {
                    showMessage(`Submission Failed: ${result.message}`, true);
                }
            } catch (e) {
                // Should not happen if GAS script is correct, but handles corrupted response
                console.error('JSON Parse Error:', e);
                showMessage("Server returned non-JSON response. Check GAS log.", true);
            }
        } else {
            // This catches non-200 errors (like 401, 403) that sometimes happen
            console.error('XHR Load Error - Status:', xhr.status);
            showMessage("Connection Error! (HTTP Status " + xhr.status + "). Check GAS deployment.", true);
        }
    };

    xhr.onerror = function() {
        // This catches true network failures (like domain not found or blocked network request)
        button.textContent = originalButtonText;
        button.disabled = false;
        console.error('XHR Network Error');
        showMessage("Connection Error! Please check your network and ensure the GAS script is deployed correctly.", true);
    };

    // Send the request
    xhr.send(JSON.stringify(payload));
  }

  window.onload = function() {
    document.getElementById('onboardingForm').addEventListener('submit', handleSubmit);
    hideMessage();
  };
</script>

<div class="min-h-screen bg-gray-900 flex items-center justify-center p-4 font-sans">
  <div class="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden">
    <div class="p-8">
      <!-- Header -->
      <h1 class="text-3xl font-extrabold text-gray-900 mb-2">SaaS Onboarding</h1>
      <p class="text-gray-600 mb-6">
        Enter your site details to register and proceed to payment.
      </p>

      <!-- Form -->
      <form id="onboardingForm">
        <div class="space-y-4">
          <!-- Site Name -->
          <div>
            <label for="displayName" class="block text-sm font-medium text-gray-700">1. Site Name (e.g., "The Best Gadgets")</label>
            <input type="text" id="displayName" placeholder="Test 85" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
          </div>

          <!-- Desired Subdomain -->
          <div>
            <label for="domainName" class="block text-sm font-medium text-gray-700">2. Desired Subdomain (e.g., "bestgadgets" for bestgadgets.saas.com)</label>
            <div class="mt-1 relative rounded-lg shadow-sm">
                <input type="text" id="domainName" placeholder="/test85" required class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            </div>
          </div>

          <!-- Amazon Tag -->
          <div>
            <label for="amazonTag" class="block text-sm font-medium text-gray-700">3. Amazon Associate ID (e.g., yourtag-20)</label>
            <input type="text" id="amazonTag" placeholder="test85-20" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700">4. Contact Email Address</label>
            <input type="email" id="email" placeholder="test@test.com" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
          </div>
        </div>

        <!-- Submit Button -->
        <button id="submit-button" type="submit" class="w-full mt-6 flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 transform hover:scale-[1.01] active:scale-95">
          Register Site & Proceed to Stripe
        </button>
      </form>
      
      <!-- Message Box -->
      <div id="message-box" style="display: none;"></div>
    </div>
  </div>
</div>
