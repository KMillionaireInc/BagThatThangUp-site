<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://gmsjqunfsffjiksffvem.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtc2pxdW5mc2Zmamlrc2ZmdmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NzIxNTgsImV4cCI6MjA3NjQ0ODE1OH0.7qEXKk8f8Sd3G2y8KyQ0XbeCyG8ieD-8WV18-_JkRGc";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const form = document.getElementById("onboard-form");
const errEl = document.getElementById("err");
const btn = document.getElementById("submitBtn");
const ALNUM = /^[a-zA-Z0-9]+$/;

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  errEl.textContent = "";

  const f = new FormData(form);
  const subRaw = (f.get("subdomain") || "").trim();

  if (!ALNUM.test(subRaw)) {
    errEl.textContent = "Subdomain must contain only letters and numbers (no spaces or symbols).";
    form.subdomain.focus();
    return;
  }

  const payload = {
    first_name: (f.get("first_name") || "").trim(),
    last_name:  (f.get("last_name") || "").trim(),
    site_name:  (f.get("site_name") || "").trim(),
    subdomain:  subRaw.toLowerCase(),
    amazon_id:  (f.get("amazon_id") || "").trim(),
    email:      (f.get("email") || "").trim()
  };

  for (const [k, v] of Object.entries(payload)) {
    if (!v) { errEl.textContent = "All fields are required."; return; }
  }

  btn.disabled = true;

  const { data, error } = await db.from("Users")
    .insert([payload])
    .select("id, subdomain")
    .single();

  btn.disabled = false;

  if (error || !data) {
    errEl.textContent = "Error: " + (error ? error.message : "Insert failed");
    return;
  }

  sessionStorage.setItem("tenant_id", data.id);
  sessionStorage.setItem("subdomain", data.subdomain);

  window.location.href = "/success?id=" + encodeURIComponent(data.id);
});
</script>
