<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BagThatThangUp Onboarding</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; text-align: center; }
    form { max-width: 400px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; }
    input, button { width: 100%; padding: 10px; margin: 10px 0; }
    .error { color: red; }
    .store-link { font-weight: bold; color: blue; }
  </style>
</head>
<body>

<!-- ================== ONBOARDING FORM ================== -->
<div id="onboarding">
  <h2>Tenant Onboarding</h2>
  <form id="onboardForm">
    <input type="text" id="first_name" placeholder="First Name" required />
    <input type="text" id="last_name" placeholder="Last Name" required />
    <input type="email" id="email" placeholder="Email" required />
    <input type="text" id="subdomain" placeholder="Choose your subdomain" required />
    <p id="error" class="error"></p>
    <button type="submit">Submit</button>
  </form>
</div>

<!-- ================== SUCCESS PAGE ================== -->
<div id="successPage" style="display:none;">
  <div style="max-width:600px; margin:40px auto; padding:20px; background:#fff; border-radius:12px;">
    <h2>ðŸŽ‰ <span style="color:green;">Success!</span></h2>
    <p>Your storefront has been created.</p>
    <div id="storeLinkMessage">Loading your link...</div>
    <p>Check your email for setup details and next steps.</p>
    <p>If you need help, contact <a href="mailto:support@bagthatthangup.com">support@bagthatthangup.com</a></p>
  </div>
</div>

<script>
  // ===== Supabase init =====
  const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co"; // replace
  const SUPABASE_KEY = "YOUR-ANON-KEY"; // replace
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ====== ALLOWED SUBDOMAIN RULES ======
  const ALNUM = /^[a-zA-Z0-9]+$/; // only letters + numbers

  // ====== Onboarding Form Logic ======
  const form = document.getElementById("onboardForm");
  const err = document.getElementById("error");
  const subInput = document.getElementById("subdomain");

  subInput.addEventListener("input", () => {
    if (!ALNUM.test(subInput.value)) {
      err.textContent = "Subdomain may only contain letters and numbers (no spaces, dashes, or symbols).";
    } else {
      err.textContent = "";
    }
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const subRaw = subInput.value.trim();
    if (!ALNUM.test(subRaw)) {
      err.textContent = "Invalid subdomain: only letters and numbers are allowed.";
      return;
    }

    const subdomain = subRaw.toLowerCase();

    const { data, error } = await db.from("Users").insert([{
      first_name: document.getElementById("first_name").value,
      last_name: document.getElementById("last_name").value,
      email: document.getElementById("email").value,
      subdomain: subdomain
    }]).select("id");

    if (error) {
      err.textContent = "Error saving details: " + error.message;
      return;
    }

    const tenantId = data[0].id;
    sessionStorage.setItem("tenant_id", tenantId);

    // Show success page
    document.getElementById("onboarding").style.display = "none";
    document.getElementById("successPage").style.display = "block";
    renderLink();
  });

  // ====== Success Page Logic ======
  async function renderLink() {
    const el = document.getElementById("storeLinkMessage");
    const tenantId = sessionStorage.getItem("tenant_id");

    if (tenantId) {
      const { data, error } = await db.from("Users")
        .select("subdomain")
        .eq("id", tenantId)
        .single();

      if (!error && data && ALNUM.test(data.subdomain)) {
        const url = `https://${data.subdomain}.bagthatthangup.com`;
        el.innerHTML = `<p><strong>Your storefront is live at:</strong></p>
          <a href="${url}" class="store-link" target="_blank">${url}</a>`;
        return;
      }
    }

    el.innerHTML = `<p class="error">We could not find your store link. Please check your email or contact support.</p>`;
  }
</script>
</body>
</html>
