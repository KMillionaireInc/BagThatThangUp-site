<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Set Up Your Storefront</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f7f5f0;color:#222;margin:0}
  .wrap{max-width:520px;margin:48px auto;padding:0 16px}
  form{background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  h1{margin:0 0 20px 0}
  label{display:block;font-weight:600;margin-top:14px}
  input{width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:8px;font-size:16px}
  button{margin-top:18px;width:100%;padding:12px;background:#c19a6b;border:none;border-radius:8px;color:#fff;font-size:16px;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .error{color:#b00020;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Set Up Your Storefront</h1>
  <form id="onboard-form" novalidate>
    <label>First Name
      <input name="first_name" required />
    </label>
    <label>Last Name
      <input name="last_name" required />
    </label>
    <label>Store Name
      <input name="site_name" required />
    </label>
    <label>Desired Domain (letters and numbers only)
      <input name="subdomain" inputmode="latin" autocomplete="off"
             pattern="[A-Za-z0-9]+"
             placeholder="e.g. myshop123" required />
    </label>
    <label>Amazon Store ID
      <input name="amazon_id" required />
    </label>
    <label>Email Address
      <input name="email" type="email" required />
    </label>
    <div id="err" class="error"></div>
    <button type="submit" id="submitBtn">Submit</button>
  </form>
</div>
<script>
const SUPABASE_URL = "https://gmsjqunfsffjiksffvem.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtc2pxdW5mc2Zmamlrc2ZmdmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NzIxNTgsImV4cCI6MjA3NjQ0ODE1OH0.7qEXKk8f8Sd3G2y8KyQ0XbeCyG8ieD-8WV18-_JkRGc";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const form = document.getElementById("onboard-form");
const errEl = document.getElementById("err");
const btn = document.getElementById("submitBtn");
const ALNUM = /^[a-zA-Z0-9]+$/;

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  errEl.textContent = "";

  const f = new FormData(form);
  const subRaw = (f.get("subdomain") || "").trim();

  if (!ALNUM.test(subRaw)) {
    errEl.textContent = "Subdomain must contain only letters and numbers (no spaces or symbols).";
    form.subdomain.focus();
    return;
  }

  const subdomainLower = subRaw.toLowerCase();

  // Check for duplicate subdomain
  btn.disabled = true;
  const { data: subCheck, error: subError } = await db.from("Users")
    .select("id")
    .eq("subdomain", subdomainLower);
  if (subCheck && subCheck.length > 0) {
    errEl.textContent = "This subdomain is already taken. Please choose another.";
    form.subdomain.focus();
    btn.disabled = false;
    return;
  }

  const payload = {
    first_name: (f.get("first_name") || "").trim(),
    last_name:  (f.get("last_name") || "").trim(),
    site_name:  (f.get("site_name") || "").trim(),
    subdomain:  subdomainLower,
    amazon_id:  (f.get("amazon_id") || "").trim(),
    email:      (f.get("email") || "").trim()
  };

  for (const [k, v] of Object.entries(payload)) {
    if (!v) { errEl.textContent = "All fields are required."; btn.disabled = false; return; }
  }

  try {
    const { data, error } = await db.from("Users")
      .insert([payload])
      .select("id, subdomain")
      .single();

    btn.disabled = false;

    if (error || !data) {
      errEl.textContent = "Error: " + (error ? error.message : "Insert failed");
      console.error("Supabase error:", error);
      return;
    }

    sessionStorage.setItem("tenant_id", data.id);
    sessionStorage.setItem("subdomain", data.subdomain);

    window.location.href = "/success?id=" + encodeURIComponent(data.id);

  } catch (ex) {
    btn.disabled = false;
    errEl.textContent = "Unexpected error: " + ex.message;
    console.error("Unexpected error:", ex);
  }
});
</script>
</body>
</html>
