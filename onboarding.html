<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BagThat Onboarding</title>
<style>
body{font-family:sans-serif;background:#f7f5f0;color:#333;padding:2rem;max-width:480px;margin:auto}
form{background:#fff;padding:2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
label{font-weight:600;margin-top:1rem;display:block}
input{width:100%;padding:.6rem;margin-top:.3rem;border:1px solid #ccc;border-radius:6px}
button{margin-top:1.5rem;width:100%;padding:.8rem;background:#c19a6b;border:none;border-radius:6px;color:white;font-size:1rem;cursor:pointer}
button:hover{background:#aa875c}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<h1>Set Up Your Storefront</h1>
<form id="onboard-form">
  <label>First Name</label>
  <input name="first_name" required>
  <label>Last Name</label>
  <input name="last_name" required>
  <label>Store Name</label>
  <input name="site_display_name" required>
  <label>Desired Domain (letters + numbers only)</label>
  <input name="subdomain" required>
  <label>Amazon Store ID</label>
  <input name="amazon_tag" required>
  <label>Email Address</label>
  <input name="email" type="email" required>
  <button type="submit">Submit</button>
</form>

<script>
const SUPABASE_URL = "https://gmsjqunfsffjiksffvem.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtc2pxdW5mc2Zmamlrc2ZmdmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NzIxNTgsImV4cCI6MjA3NjQ0ODE1OH0.7qEXKk8f8Sd3G2y8KyQ0XbeCyG8ieD-8WV18-_JkRGc";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

document.getElementById("onboard-form").addEventListener("submit", async e => {
  e.preventDefault();
  const form = e.target;

  // sanitize subdomain (letters + numbers only)
  let raw = form.subdomain.value.trim().toLowerCase();
  let clean = raw.replace(/[^a-z0-9]/g, "");
  if (clean !== raw || clean.length === 0) {
    alert("Subdomain must contain only letters and numbers.");
    return;
  }

  const payload = {
    first_name: form.first_name.value.trim(),
    last_name: form.last_name.value.trim(),
    site_display_name: form.site_display_name.value.trim(),
    subdomain: clean,
    amazon_tag: form.amazon_tag.value.trim(),
    email: form.email.value.trim()
  };

  const { data: inserted, error } = await supabase
    .from("Users")
    .insert([payload])
    .select("id,subdomain")
    .single();

  if (error) {
    alert("Error: " + error.message);
  } else {
    // store for success page
    sessionStorage.setItem("tenant_id", inserted.id);
    sessionStorage.setItem("subdomain", inserted.subdomain);
    window.location.href = "success.html?id=" + inserted.id;
  }
});
</script>
</body>
</html>
