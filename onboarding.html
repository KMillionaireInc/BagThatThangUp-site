function doPost(e) {
  try {
    // Parse incoming data (handles both JSON and form data)
    let data;
    if (e.postData && e.postData.type === 'application/json') {
      data = JSON.parse(e.postData.contents);
    } else {
      data = e.parameter;
    }
    
    // Open the spreadsheet and get the Basic sheet
    const ss = SpreadsheetApp.openById('1YqMpo0L4tjHKq0gvGXmPQOu_iw5QkppFzy4HtdrD1Eo');
    const sheet = ss.getSheetByName('Basic');
    
    // Get the domain name being submitted
    const newDomainName = (data.subdomain || '').toLowerCase().trim();
    
    if (!newDomainName) {
      return ContentService
        .createTextOutput(JSON.stringify({
          ok: false,
          msg: 'Domain name is required'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Check for duplicate domain names (column D is subdomain)
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      const existingDomains = sheet.getRange(2, 4, lastRow - 1, 1).getValues();
      const domainExists = existingDomains.some(row => 
        row[0] && row[0].toString().toLowerCase().trim() === newDomainName
      );
      
      if (domainExists) {
        return ContentService
          .createTextOutput(JSON.stringify({
            ok: false,
            msg: 'That domain name is not available. Please try a different name.'
          }))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Generate timestamp and tenant_id
    const timestamp = new Date();
    const tenantId = 'tenant_' + timestamp.getTime();
    
    // Map form fields to spreadsheet columns
    const rowData = [
      timestamp,                        // timestamp
      tenantId,                         // tenant_id
      data.site_display_name || '',     // site_display_name
      newDomainName,                    // subdomain
      data.amazon_tag || '',            // amazon_tag
      data.email || ''                  // email
    ];
    
    // Append the data to the sheet
    sheet.appendRow(rowData);
    
    // Return success response
    return ContentService
      .createTextOutput(JSON.stringify({
        ok: true,
        msg: 'Data saved successfully',
        subdomain: newDomainName,
        tenantId: tenantId
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // Return error response
    return ContentService
      .createTextOutput(JSON.stringify({
        ok: false,
        msg: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Test function to verify the script works
function testDoPost() {
  const testData = {
    postData: {
      type: 'application/json',
      contents: JSON.stringify({
        site_display_name: 'Test Site',
        subdomain: 'testsite',
        amazon_tag: 'testag-20',
        email: 'test@example.com'
      })
    }
  };
  
  const result = doPost(testData);
  Logger.log(result.getContent());
}
