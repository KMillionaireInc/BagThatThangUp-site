<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Finish Onboarding</title>
<style>
  :root{--ink:#0b1320;--muted:#5a6b7a;--line:#e8eef5;--bg:#f7f9fb;--surface:#fff;--ok:#0ea5a6;--err:#c62828}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:780px;margin:36px auto;padding:20px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 26px rgba(2,24,43,.08);padding:22px}
  h1{margin:0 0 6px} .sub{color:var(--muted);margin:0 0 16px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#194bfb;font-size:12px;margin-left:8px}
  form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .full{grid-column:1/-1}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .row{display:flex;gap:10px;align-items:center}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;background:#0b72f0;color:#fff;font-weight:700}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .ok{padding:14px;border:1px solid #bfeee8;background:#ebfbf8;border-radius:12px;margin-top:16px}
  .err{padding:12px;border:1px solid #ffd2d2;background:#fff3f3;border-radius:10px;color:#8a1f1f;margin-bottom:12px}
  .hide{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Great choice! Let’s set up your site <span id="planBadge" class="badge"></span></h1>
    <p class="sub">Payment succeeded. Complete this one-time setup.</p>

    <div id="alert" class="err hide"></div>

    <form id="f" novalidate>
      <div class="full">
        <label>Store display name</label>
        <input id="site_display_name" placeholder="Demo Deals"/>
      </div>

      <div>
        <label>Contact email</label>
        <input id="email" type="email" placeholder="you@example.com"/>
      </div>

      <div>
        <label>Your site URL</label>
        <input id="subdomain" placeholder="yourbrand"/>
        <div class="hint">Your site will be: <b id="hostPrev">—</b></div>
      </div>

      <div class="full">
        <label>Amazon Associates ID</label>
        <input id="amazon_tag" placeholder="yourtag-20"/>
      </div>

      <!-- Shown for Custom/Pro -->
      <div id="p1" class="hide">
        <label>Primary color (hex)</label>
        <input id="color_primary" placeholder="#0ea5a6"/>
      </div>
      <div id="p2" class="hide">
        <label>Secondary color (hex)</label>
        <input id="color_secondary" placeholder="#1e90ff"/>
      </div>
      <div class="full" id="layWrap" class="hide">
        <label>Layout</label>
        <select id="layout"></select>
      </div>

      <!-- Pro-only -->
      <div class="full hide" id="proLogo">
        <label>Logo URL (optional)</label>
        <input id="logo_url" placeholder="https://.../logo.png"/>
      </div>
      <div class="full hide" id="proFeat">
        <label>Featured ASINs (comma-separated)</label>
        <input id="featured_asins" placeholder="B0C123ABCD,B0D456EFGH"/>
      </div>

      <div class="full">
        <button id="go" class="btn" type="submit">Submit onboarding</button>
      </div>

      <input type="hidden" id="plan"/>
      <input type="hidden" id="plan_key"/>
    </form>

    <div id="done" class="ok hide">
      <b>Submitted.</b> Your site will be available at <a id="link" href="#" target="_blank" rel="noopener"></a>.
    </div>
  </div>
</div>

<script>
(function(){
  // CONFIG
  const GAS = "https://script.google.com/macros/s/AKfycbwuVE04GlyVDMnMujnT8ZuSIbH-XCj_P2KU1CoUgU5SGLqIZ0kbLMX4WjOScEQyUJ36/exec";
  const DOMAIN = "bagthatthangup.com";
  const KEYS = {
    Basic:  "btb_7vRyKQ6mP2wTg8nC4aZJd9sLq3Xe0Uh",
    Custom: "btc_R3mXn8qJ0vWk2pY5sHa4Lu9Td6Bf1Zo",
    Pro:    "btp_9hNsR3eL8kV5wC2mT1qXy4dJz7aF0Gb"
  };

  // elements
  const q = (id)=>document.getElementById(id);
  const planBadge = q('planBadge'), alertBox = q('alert'), form = q('f'), done = q('done'), link = q('link');
  const fields = {
    site_display_name:q('site_display_name'), email:q('email'), subdomain:q('subdomain'), amazon_tag:q('amazon_tag'),
    color_primary:q('color_primary'), color_secondary:q('color_secondary'), layout:q('layout'),
    logo_url:q('logo_url'), featured_asins:q('featured_asins')
  };
  const p1=q('p1'), p2=q('p2'), layWrap=q('layWrap'), proLogo=q('proLogo'), proFeat=q('proFeat'), go=q('go'), hostPrev=q('hostPrev');

  // plan from URL
  const params = new URLSearchParams(location.search);
  const plan = params.get('plan'); const plan_key = params.get('plan_key');
  q('plan').value = plan||''; q('plan_key').value = plan_key||'';

  function err(m){ alertBox.textContent=m; alertBox.classList.remove('hide'); }
  function ok(){ alertBox.classList.add('hide'); }

  // validate plan
  if(!plan || !plan_key || KEYS[plan] !== plan_key){
    err("Invalid or missing plan link. Contact support.");
    form.classList.add('hide');
    return;
  }
  planBadge.textContent = plan;

  // UI by plan
  function setUI(p){
    const isCustom = (p==='Custom'||p==='Pro'), isPro = (p==='Pro');
    p1.classList.toggle('hide', !isCustom);
    p2.classList.toggle('hide', !isCustom);
    layWrap.classList.toggle('hide', !isCustom);
    fields.layout.innerHTML = "";
    if (p==='Custom') ["list","grid"].forEach(x=>fields.layout.add(new Option(x,x)));
    if (p==='Pro') ["list","grid","spotlight","magazine"].forEach(x=>fields.layout.add(new Option(x,x)));
    proLogo.classList.toggle('hide', !isPro);
    proFeat.classList.toggle('hide', !isPro);
  }
  setUI(plan);

  // subdomain preview
  function sanitize(s){ return (s||"").toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/^-+|-+$/g,'').slice(0,63); }
  function updatePrev(){ const s=sanitize(fields.subdomain.value); hostPrev.textContent = s? `${s}.${DOMAIN}` : `yourbrand.${DOMAIN}`; }
  fields.subdomain.addEventListener('input', updatePrev); updatePrev();

  // submit
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault(); ok();
    const sub = sanitize(fields.subdomain.value);
    if(!fields.site_display_name.value.trim()) return err("Enter a site name.");
    if(!fields.email.value.trim()) return err("Enter an email.");
    if(!sub || sub.length<3) return err("Enter a valid site URL (3+ chars).");
    if(!fields.amazon_tag.value.trim()) return err("Enter your Amazon Associates ID.");

    go.disabled = true; go.textContent = "Submitting…";
    const payload = {
      timestamp: new Date().toISOString(),
      tenant_id: "",
      email: fields.email.value.trim(),
      site_display_name: fields.site_display_name.value.trim(),
      subdomain: sub,
      plan,
      amazon_tag: fields.amazon_tag.value.trim(),
      color_primary: (fields.color_primary.value||"").trim(),
      color_secondary: (fields.color_secondary.value||"").trim(),
      logo_url: (fields.logo_url?.value||"").trim(),
      layout: (fields.layout?.value||"") || (plan==='Basic'?'list':''),
      featured_asins: (fields.featured_asins?.value||"").trim(),
      extra_page_enabled: false,
      status: "active"
    };

    try{
      const r = await fetch(GAS, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      const data = await r.json().catch(()=>({}));
      if(!r.ok || data.ok===false){
        if (data && data.error === 'subdomain_taken') { throw new Error(`That site URL is already taken. Try another.`); }
        throw new Error(data && data.error ? data.error : `Submission failed (${r.status}).`);
      }
      form.classList.add('hide');
      done.classList.remove('hide');
      const url = `https://${sub}.${DOMAIN}`;
      link.href = url; link.textContent = url;
    }catch(e){ err(String(e.message||e)); go.disabled=false; go.textContent="Submit onboarding"; }
  });
})();
</script>
</body>
</html>
